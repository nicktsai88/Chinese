<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬4å†Š L1 é‹å‹•å®¶çš„é¢¨åº¦-å­—éŸ³ç·´ç¿’ (Firebaseç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #fff7ed; 
        }
        ::-webkit-scrollbar-thumb {
            background: #fdba74; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #fb923c; 
        }
        /* Hide scrollbar for clean horizontal scroll if needed */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Progress bar transition */
        .progress-bar {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Heart animation */
        @keyframes heartbeat {
            0% { transform: scale(1); }
            25% { transform: scale(1.2); }
            50% { transform: scale(1); }
            75% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .heart-click {
            animation: heartbeat 0.4s ease-in-out;
        }
        /* Status Dot styles */
        .status-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-loading { background-color: #eab308; box-shadow: 0 0 4px #eab308; } /* Yellow */
        .status-success { background-color: #22c55e; box-shadow: 0 0 4px #22c55e; } /* Green */
        .status-error { background-color: #ef4444; box-shadow: 0 0 4px #ef4444; }    /* Red */
        
        /* Delete button styling */
        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .user-btn-wrapper:hover .delete-btn {
            opacity: 1;
        }

        /* åˆå§‹åŠ è¼‰é®ç½© */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff7ed;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            transition: opacity 0.5s;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ea580c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-orange-50">
    <!-- åˆå§‹åŠ è¼‰ç•«é¢ï¼Œé˜²æ­¢ç™½å± -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-orange-600 font-bold">æ­£åœ¨è¼‰å…¥å­—éŸ³ç·´ç¿’...</p>
    </div>

    <div id="root"></div>

    <!-- 1. æ¨¡çµ„é åŠ è¼‰å™¨ (Module Pre-loader) -->
    <!-- é€™è£¡ä¸ä½¿ç”¨ importmapï¼Œæ”¹ç”¨æ¨™æº– module script ä¸‹è¼‰ä¸¦æ›è¼‰åˆ° window -->
    <script type="module">
        // å°å…¥ React
        import React from "https://esm.sh/react@18.2.0";
        import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";
        
        // å°å…¥ UI çµ„ä»¶åº“ Lucide React
        import * as Lucide from "https://esm.sh/lucide-react@0.263.1";
        
        // å°å…¥ç‰¹æ•ˆåº“
        import confetti from "https://esm.sh/canvas-confetti@1.9.2";
        
        // å°å…¥ Firebase (ä½¿ç”¨ Google å®˜æ–¹ CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // å°‡æ¨¡çµ„æ›è¼‰åˆ°å…¨å±€ window å°è±¡
        window.React = React;
        window.ReactDOM = ReactDOM;
        window.Lucide = Lucide;
        window.confetti = confetti;
        window.Firebase = {
            initializeApp,
            getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDoc
        };

        // é€šçŸ¥æ‡‰ç”¨ç¨‹åºä¾è³´å·²æº–å‚™å°±ç·’
        window.dispatchEvent(new Event('modules-loaded'));
    </script>

    <!-- 2. ä¸»æ‡‰ç”¨ç¨‹åºé‚è¼¯ (Main App Logic) -->
    <script type="text/babel">
        // ç­‰å¾…æ¨¡çµ„åŠ è¼‰å®Œæˆå¾Œå†å•Ÿå‹• React
        window.addEventListener('modules-loaded', () => {
            initApp();
        });

        // æª¢æŸ¥æ˜¯å¦å·²ç¶“è¼‰å…¥ (ä»¥é˜²è¬ä¸€)
        if (window.React && window.Firebase) {
             setTimeout(initApp, 100);
        }

        function initApp() {
            // éš±è—åŠ è¼‰ç•«é¢
            const loader = document.getElementById('loading-overlay');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 500);
            }

            // --- è®Šé‡è§£æ§‹ (æ›¿ä»£ import) ---
            const { useState, useEffect, useMemo, useCallback } = window.React;
            const { createRoot } = window.ReactDOM;
            // ç¢ºä¿å¾ Lucide ä¸­ç²å–æ‰€æœ‰åœ–æ¨™
            const { BookOpen, HelpCircle, CheckCircle, XCircle, ArrowRight, RefreshCcw, List, Sun, User, LogOut, Zap, Heart, BookX, Cloud, Trash2 } = window.Lucide;
            const confetti = window.confetti;
            
            // Firebase å‡½æ•¸
            const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDoc } = window.Firebase;

            // --- FIREBASE CONFIGURATION ---
            const firebaseConfig = {
                apiKey: "AIzaSyAxQFt76ZPXE7d0i1XeNZ1yiiD2WYNIfHs",
                authDomain: "chinese-learning-47f4d.firebaseapp.com",
                projectId: "chinese-learning-47f4d",
                storageBucket: "chinese-learning-47f4d.firebasestorage.app",
                messagingSenderId: "76289812052",
                appId: "1:76289812052:web:898384a916f9f341f62fc1"
            };

            // Initialize Firebase
            let db;
            let auth;
            try {
                // ç°¡å–®æª¢æŸ¥ Config æ˜¯å¦æœ‰æ•ˆ
                if (firebaseConfig.apiKey !== "è«‹å¡«å…¥æ‚¨çš„API_KEY") {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                } else {
                    console.warn("Firebase Config æœªè¨­å®š");
                }
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }

            // --- COLLECTION DEFINITION ---
            const COLLECTION_NAME = 'Chinese4-L1-3';
            const GLOBAL_DOC_ID = 'global_users'; 

            // è³‡æ–™åº«ï¼šå­—éŸ³è¾¨æ­£ (å®Œæ•´æ”¶éŒ„)
            const rawData = [
                // 1. é£²
                { id: 1, question: "ä¸‹è€Œã€Œé£²ã€", answer: "ã„§ã„£Ë‹", distractors: ["ã„§ã„£Ë‡", "ã„§ã„¥Ë‡"] },
                { id: 2, question: "ã€Œé£²ã€é¦¬é•·åŸ", answer: "ã„§ã„£Ë‹", distractors: ["ã„§ã„£Ë‡", "ã„§ã„¥Ë‡"] },
                { id: 3, question: "é€ ã€Œé£²ã€è¼’ç›¡", answer: "ã„§ã„£Ë‡", distractors: ["ã„§ã„£Ë‹", "ã„§ã„¥Ë‡"] },
                { id: 4, question: "ã€Œé£²ã€æ°´æ€æº", answer: "ã„§ã„£Ë‡", distractors: ["ã„§ã„£Ë‹", "ã„§ã„¥Ë‡"] },
                { id: 5, question: "ã€Œé£²ã€æ¨åè²", answer: "ã„§ã„£Ë‡", distractors: ["ã„§ã„£Ë‹", "ã„§ã„¥Ë‡"] },
                // 2. å‚³
                { id: 6, question: "ã€Œå‚³ã€è¨˜", answer: "ã„“ã„¨ã„¢Ë‹", distractors: ["ã„”ã„¨ã„¢ËŠ", "ã„“ã„¨ã„¢"] },
                { id: 7, question: "å·¦ã€Œå‚³ã€", answer: "ã„“ã„¨ã„¢Ë‹", distractors: ["ã„”ã„¨ã„¢ËŠ", "ã„“ã„¨ã„¢"] },
                { id: 8, question: "ã€Œå‚³ã€çµ±", answer: "ã„”ã„¨ã„¢ËŠ", distractors: ["ã„“ã„¨ã„¢Ë‹", "ã„”ã„¨ã„¢"] },
                { id: 9, question: "ã€Œå‚³ã€æŸ“", answer: "ã„”ã„¨ã„¢ËŠ", distractors: ["ã„“ã„¨ã„¢Ë‹", "ã„”ã„¨ã„¢"] },
                // 3. èª¿
                { id: 10, question: "å”ã€Œèª¿ã€", answer: "ã„Šã„§ã„ ËŠ", distractors: ["ã„‰ã„§ã„ Ë‹", "ã„Šã„§ã„ "] },
                { id: 11, question: "ã€Œèª¿ã€æˆ²", answer: "ã„Šã„§ã„ ËŠ", distractors: ["ã„‰ã„§ã„ Ë‹", "ã„Šã„§ã„ "] },
                { id: 12, question: "å–®ã€Œèª¿ã€", answer: "ã„‰ã„§ã„ Ë‹", distractors: ["ã„Šã„§ã„ ËŠ", "ã„‰ã„§ã„ "] },
                { id: 13, question: "è«–ã€Œèª¿ã€", answer: "ã„‰ã„§ã„ Ë‹", distractors: ["ã„Šã„§ã„ ËŠ", "ã„‰ã„§ã„ "] },
                // 4. è¡Œ
                { id: 14, question: "ã€Œè¡Œã€å¿…æœ", answer: "ã„’ã„§ã„¥ËŠ", distractors: ["ã„ã„¤ËŠ", "ã„’ã„§ã„¥Ë‹"] },
                { id: 15, question: "å¾·ã€Œè¡Œã€", answer: "ã„’ã„§ã„¥Ë‹", distractors: ["ã„’ã„§ã„¥ËŠ", "ã„ã„¤ËŠ"] },
                { id: 16, question: "æ’ã€Œè¡Œã€", answer: "ã„ã„¤ËŠ", distractors: ["ã„’ã„§ã„¥ËŠ", "ã„’ã„§ã„¥Ë‹"] },
                { id: 17, question: "éš”ã€Œè¡Œã€å¦‚éš”å±±", answer: "ã„ã„¤ËŠ", distractors: ["ã„’ã„§ã„¥ËŠ", "ã„’ã„§ã„¥Ë‹"] },
                // 5. ä¾¿
                { id: 18, question: "è«¸å¤šä¸ã€Œä¾¿ã€", answer: "ã„…ã„§ã„¢Ë‹", distractors: ["ã„†ã„§ã„¢ËŠ", "ã„…ã„§ã„¢"] },
                { id: 19, question: "ã€Œä¾¿ã€å®œè¡Œäº‹", answer: "ã„…ã„§ã„¢Ë‹", distractors: ["ã„†ã„§ã„¢ËŠ", "ã„…ã„§ã„¢"] },
                { id: 20, question: "åƒ¹æ ¼ã€Œä¾¿ã€å®œ", answer: "ã„†ã„§ã„¢ËŠ", distractors: ["ã„…ã„§ã„¢Ë‹", "ã„†ã„§ã„¢"] },
                { id: 21, question: "å å°ã€Œä¾¿ã€å®œ", answer: "ã„†ã„§ã„¢ËŠ", distractors: ["ã„…ã„§ã„¢Ë‹", "ã„†ã„§ã„¢"] },
                // 6. ç½ / æ† / è‘µ / ç™¸
                { id: 22, question: "è¬ç›®ã€Œç½ç½ã€", answer: "ã„ã„¨ã„ŸËŠ", distractors: ["ã„ã„¨ã„ŸË‡", "ã„ã„¨ã„Ÿ"] },
                { id: 23, question: "é–£ã€Œæ†ã€", answer: "ã„ã„¨ã„ŸËŠ", distractors: ["ã„ã„¨ã„ŸË‡", "ã„ã„¨ã„Ÿ"] },
                { id: 24, question: "ã€Œç½ã€é•å·²ä¹…", answer: "ã„ã„¨ã„ŸËŠ", distractors: ["ã„ã„¨ã„ŸË‡", "ã„ã„¨ã„Ÿ"] },
                { id: 25, question: "å‘æ—¥ã€Œè‘µã€", answer: "ã„ã„¨ã„ŸËŠ", distractors: ["ã„ã„¨ã„ŸË‡", "ã„ã„¨ã„Ÿ"] },
                { id: 26, question: "å£¬ã€Œç™¸ã€", answer: "ã„ã„¨ã„ŸË‡", distractors: ["ã„ã„¨ã„ŸËŠ", "ã„ã„¨ã„Ÿ"] },
                // 7. é‘„ / ç±Œ / ç–‡ / èºŠ / æ¿¤ / æ“£
                { id: 27, question: "é™¶ã€Œé‘„ã€", answer: "ã„“ã„¨Ë‹", distractors: ["ã„”ã„¡ËŠ", "ã„Šã„ ËŠ"] },
                { id: 28, question: "ã€Œé‘„ã€æˆå¤§éŒ¯", answer: "ã„“ã„¨Ë‹", distractors: ["ã„”ã„¡ËŠ", "ã„Šã„ ËŠ"] },
                { id: 29, question: "ç•¥å‹ä¸€ã€Œç±Œã€", answer: "ã„”ã„¡ËŠ", distractors: ["ã„“ã„¨Ë‹", "ã„•ã„¡Ë‹"] },
                { id: 30, question: "å¹³ã€Œç–‡ã€", answer: "ã„”ã„¡ËŠ", distractors: ["ã„“ã„¨Ë‹", "ã„•ã„¡Ë‹"] },
                { id: 31, question: "ã€ŒèºŠã€èº‡", answer: "ã„”ã„¡ËŠ", distractors: ["ã„“ã„¨Ë‹", "ã„•ã„¡Ë‹"] },
                { id: 32, question: "æµªã€Œæ¿¤ã€", answer: "ã„Šã„ ËŠ", distractors: ["ã„”ã„¡ËŠ", "ã„“ã„¨Ë‹"] },
                { id: 33, question: "ã€Œæ“£ã€è¡£è²", answer: "ã„‰ã„ Ë‡", distractors: ["ã„”ã„¡ËŠ", "ã„“ã„¨Ë‹"] },
                // 8. æ­ / ç«­ / æ­‡ / è¤ / ç¾¯
                { id: 34, question: "ã€Œæ­ã€æ›‰", answer: "ã„ã„§ã„", distractors: ["ã„ã„§ã„ËŠ", "ã„’ã„§ã„"] },
                { id: 35, question: "ã€Œæ­ã€ç™¼", answer: "ã„ã„§ã„", distractors: ["ã„ã„§ã„ËŠ", "ã„’ã„§ã„"] },
                { id: 36, question: "ã€Œç«­ã€èª ", answer: "ã„ã„§ã„ËŠ", distractors: ["ã„ã„§ã„", "ã„’ã„§ã„"] },
                { id: 37, question: "è²å˜¶åŠ›ã€Œç«­ã€", answer: "ã„ã„§ã„ËŠ", distractors: ["ã„ã„§ã„", "ã„’ã„§ã„"] },
                { id: 38, question: "ã€Œæ­‡ã€æ–¯åº•é‡Œ", answer: "ã„’ã„§ã„", distractors: ["ã„ã„§ã„", "ã„ã„§ã„ËŠ"] },
                { id: 39, question: "çŸ­ã€Œè¤ã€ç©¿çµ", answer: "ã„ã„œËŠ", distractors: ["ã„ã„§ã„ËŠ", "ã„ã„œË‡"] },
                { id: 40, question: "é­”ã€Œç¾¯ã€åº§", answer: "ã„ã„§ã„ËŠ", distractors: ["ã„‡ã„›ËŠ", "ã„’ã„§ã„"] },
                // 9. å®µ / éœ„ / éŠ· / å‰Š / è‚– / å³­ / é˜ / å±‘
                { id: 41, question: "é€šã€Œå®µã€", answer: "ã„’ã„§ã„ ", distractors: ["ã„’ã„§ã„ Ë‹", "ã„•ã„ "] },
                { id: 42, question: "ä¹ã€Œéœ„ã€", answer: "ã„’ã„§ã„ ", distractors: ["ã„’ã„§ã„ Ë‹", "ã„•ã„ "] },
                { id: 43, question: "ã€ŒéŠ·ã€å”®", answer: "ã„’ã„§ã„ ", distractors: ["ã„’ã„§ã„ Ë‹", "ã„•ã„ "] },
                { id: 44, question: "ä¸ã€Œè‚–ã€", answer: "ã„’ã„§ã„ Ë‹", distractors: ["ã„’ã„§ã„ ", "ã„•ã„ "] },
                { id: 45, question: "ã€Œå‰Šã€æ¸›", answer: "ã„’ã„©ã„Ë‹", distractors: ["ã„’ã„§ã„ ", "ã„’ã„§ã„ Ë‹"] },
                { id: 46, question: "æ‡¸å´–ã€Œå³­ã€å£", answer: "ã„‘ã„§ã„ Ë‹", distractors: ["ã„’ã„§ã„ Ë‹", "ã„•ã„ "] },
                { id: 47, question: "ã€Œé˜ã€", answer: "ã„‘ã„§ã„ Ë‹", distractors: ["ã„’ã„§ã„ Ë‹", "ã„•ã„ "] },
                { id: 48, question: "ä¸ã€Œå±‘ã€", answer: "ã„’ã„§ã„Ë‹", distractors: ["ã„’ã„§ã„ Ë‹", "ã„’ã„§ã„ "] },
                // 10. å€¡ / çŒ– / æ˜Œ / æš¢
                { id: 49, question: "æã€Œå€¡ã€", answer: "ã„”ã„¤Ë‹", distractors: ["ã„”ã„¤", "ã„”ã„¤ËŠ"] },
                { id: 50, question: "ã€Œæš¢ã€æ‰€æ¬²è¨€", answer: "ã„”ã„¤Ë‹", distractors: ["ã„”ã„¤", "ã„”ã„¤ËŠ"] },
                { id: 51, question: "ã€ŒçŒ–ã€ç—", answer: "ã„”ã„¤", distractors: ["ã„”ã„¤Ë‹", "ã„”ã„¤ËŠ"] },
                { id: 52, question: "ã€Œæ˜Œã€ç››", answer: "ã„”ã„¤", distractors: ["ã„”ã„¤Ë‹", "ã„”ã„¤ËŠ"] },
                // 11. æ– / è¼¯ / ç· / ä¾
                { id: 53, question: "ã€Œæ–ã€è®“", answer: "ã„§", distractors: ["ã„ã„§ËŠ", "ã„‘ã„§Ë‹"] },
                { id: 54, question: "æ‰“èº¬ä½œã€Œæ–ã€", answer: "ã„§", distractors: ["ã„ã„§ËŠ", "ã„‘ã„§Ë‹"] },
                { id: 55, question: "ã€Œä¾ã€æ¨£ç•«è‘«è˜†", answer: "ã„§", distractors: ["ã„ã„§ËŠ", "ã„‘ã„§Ë‹"] },
                { id: 56, question: "é€šã€Œç·ã€", answer: "ã„‘ã„§Ë‹", distractors: ["ã„ã„§ËŠ", "ã„§"] },
                { id: 57, question: "ç·¨ã€Œè¼¯ã€", answer: "ã„ã„§ËŠ", distractors: ["ã„‘ã„§Ë‹", "ã„§"] },
                // 12. ç«¶ / å…¢ / å‹ / å¾‘
                { id: 58, question: "ã€Œç«¶ã€çˆ­", answer: "ã„ã„§ã„¥Ë‹", distractors: ["ã„ã„§ã„¥", "ã„ã„§ã„¥Ë‡"] },
                { id: 59, question: "æˆ°æˆ°ã€Œå…¢å…¢ã€", answer: "ã„ã„§ã„¥", distractors: ["ã„ã„§ã„¥Ë‹", "ã„ã„§ã„¥Ë‡"] },
                { id: 60, question: "å¼·ã€Œå‹ã€", answer: "ã„ã„§ã„¥Ë‹", distractors: ["ã„ã„§ã„¥", "ã„ã„§ã„¥Ë‡"] },
                { id: 61, question: "ä¸ã€Œè„›ã€è€Œèµ°", answer: "ã„ã„§ã„¥Ë‹", distractors: ["ã„ã„§ã„¥", "ã„ã„§ã„¥Ë‡"] },
                // 13. æ–¥ / å± / èµ¤
                { id: 62, question: "æ’ã€Œæ–¥ã€", answer: "ã„”Ë‹", distractors: ["ã„”ã„œË‹", "ã„”"] },
                { id: 63, question: "ã€Œå±ã€å’é¢¨é›²", answer: "ã„”Ë‹", distractors: ["ã„”ã„œË‹", "ã„”"] },
                { id: 64, question: "è¿‘æœ±è€…ã€Œèµ¤ã€", answer: "ã„”Ë‹", distractors: ["ã„”ã„œË‹", "ã„”"] },
                // 14. ç®­ / åŠ
                { id: 65, question: "æš—ã€Œç®­ã€", answer: "ã„ã„§ã„¢Ë‹", distractors: ["ã„‘ã„§ã„¢ËŠ", "ã„ã„§ã„¢"] },
                { id: 66, question: "ã€ŒåŠã€åŠå±¥åŠ", answer: "ã„ã„§ã„¢Ë‹", distractors: ["ã„‘ã„§ã„¢ËŠ", "ã„ã„§ã„¢"] },
                // 15. çˆ­ / çœ
                { id: 67, question: "ã€Œçˆ­ã€å…ˆæå¾Œ", answer: "ã„“ã„¥", distractors: ["ã„“ã„¥Ë‹", "ã„—ã„¥"] },
                { id: 68, question: "ã€Œçœã€çœ¼èªªçè©±", answer: "ã„“ã„¥", distractors: ["ã„“ã„¥Ë‹", "ã„—ã„¥"] },
                // 16. æ / é¡Œ / ç· 
                { id: 69, question: "å‰ã€Œæã€", answer: "ã„Šã„§ËŠ", distractors: ["ã„‰ã„§Ë‹", "ã„Šã„§"] },
                { id: 70, question: "é‡‘æ¦œã€Œé¡Œã€å", answer: "ã„Šã„§ËŠ", distractors: ["ã„‰ã„§Ë‹", "ã„Šã„§"] },
                { id: 71, question: "è€³ã€Œæã€é¢å‘½", answer: "ã„Šã„§ËŠ", distractors: ["ã„‰ã„§Ë‹", "ã„Šã„§"] },
                { id: 72, question: "ã€Œç· ã€é€ ", answer: "ã„‰ã„§Ë‹", distractors: ["ã„Šã„§ËŠ", "ã„‰ã„§"] },
                // 17. å°¤ / ç”±
                { id: 73, question: "ã€Œå°¤ã€äºº", answer: "ã„§ã„¡ËŠ", distractors: ["ã„§ã„¡", "ã„§ã„¡Ë‡"] },
                { id: 74, question: "ã€Œç”±ã€å‘½", answer: "ã„§ã„¡ËŠ", distractors: ["ã„§ã„¡", "ã„§ã„¡Ë‡"] },
                { id: 75, question: "ã€Œç”±ã€ä¾†", answer: "ã„§ã„¡ËŠ", distractors: ["ã„§ã„¡", "ã„§ã„¡Ë‡"] },
                // 18. åŸº / ç© / ç¸¾
                { id: 76, question: "ã€ŒåŸºã€ç¤", answer: "ã„ã„§", distractors: ["ã„ã„§ËŠ", "ã„ã„§Ë‡"] },
                { id: 77, question: "ã€Œç©ã€éæˆæ˜¯", answer: "ã„ã„§", distractors: ["ã„ã„§ËŠ", "ã„ã„§Ë‡"] },
                { id: 78, question: "æˆã€Œç¸¾ã€", answer: "ã„ã„§", distractors: ["ã„ã„§ËŠ", "ã„ã„§Ë‡"] },
                // 19. èŠ / å»–
                { id: 79, question: "ç„¡ã€ŒèŠã€", answer: "ã„Œã„§ã„ ËŠ", distractors: ["ã„Œã„§ã„ Ë‡", "ã„Œã„§ã„ "] },
                { id: 80, question: "ã€ŒèŠã€å‹æ–¼ç„¡", answer: "ã„Œã„§ã„ ËŠ", distractors: ["ã„Œã„§ã„ Ë‡", "ã„Œã„§ã„ "] },
                // 20. æ¥ / é½’
                { id: 81, question: "ç„¡ã€Œæ¥ã€", answer: "ã„”Ë‡", distractors: ["ã„”Ë‹", "ã„”"] },
                { id: 82, question: "ä¸ã€Œé½’ã€", answer: "ã„”Ë‡", distractors: ["ã„”Ë‹", "ã„”"] },
                // 21. é› / æ“ / åº¸
                { id: 83, question: "ã€Œé›ã€å®¹", answer: "ã„©ã„¥", distractors: ["ã„©ã„¥Ë‡", "ã„©ã„¥Ë‹"] },
                { id: 84, question: "ã€Œæ“ã€æ“ ", answer: "ã„©ã„¥Ë‡", distractors: ["ã„©ã„¥", "ã„©ã„¥Ë‹"] },
                { id: 85, question: "ã€Œåº¸ã€ä¿—", answer: "ã„©ã„¥", distractors: ["ã„©ã„¥Ë‡", "ã„©ã„¥Ë‹"] },
                { id: 86, question: "ä¸­ã€Œåº¸ã€", answer: "ã„©ã„¥", distractors: ["ã„©ã„¥Ë‡", "ã„©ã„¥Ë‹"] },
                // 22. æ‚» / å€– / è˜
                { id: 87, question: "ã€Œæ‚»æ‚»ã€ç„¶", answer: "ã„’ã„§ã„¥Ë‹", distractors: ["ã„’ã„§ã„¥", "ã„•ã„£"] },
                { id: 88, question: "åƒ¥ã€Œå€–ã€", answer: "ã„’ã„§ã„¥Ë‹", distractors: ["ã„’ã„§ã„¥", "ã„•ã„£"] },
                { id: 89, question: "ã€Œè˜è˜ã€å­¸å­", answer: "ã„•ã„£", distractors: ["ã„’ã„§ã„£", "ã„’ã„§ã„¥Ë‹"] },
                // 23. æ›‰ / æ’“
                { id: 90, question: "ã€Œæ›‰ã€ä»¥å¤§ç¾©", answer: "ã„’ã„§ã„ Ë‡", distractors: ["ã„‹ã„ ËŠ", "ã„–ã„ ËŠ"] },
                { id: 91, question: "ä¸å±ˆä¸ã€Œæ’“ã€", answer: "ã„‹ã„ ËŠ", distractors: ["ã„’ã„§ã„ Ë‡", "ã„–ã„ ËŠ"] },
                // 24. å„ª / æ“¾
                { id: 92, question: "ã€Œå„ªã€è‰¯", answer: "ã„§ã„¡", distractors: ["ã„–ã„ Ë‡", "ã„§ã„¡Ë‡"] },
                { id: 93, question: "ã€Œæ“¾ã€äº‚", answer: "ã„–ã„ Ë‡", distractors: ["ã„§ã„¡", "ã„§ã„¡Ë‡"] },
                // 25. é™¶ / æ·˜ / æ
                { id: 94, question: "ã€Œé™¶ã€é‘„", answer: "ã„Šã„ ËŠ", distractors: ["ã„Šã„ ", "ã„Šã„ Ë‡"] },
                { id: 95, question: "ã€Œæ·˜ã€ç©º", answer: "ã„Šã„ ËŠ", distractors: ["ã„Šã„ ", "ã„Šã„ Ë‡"] },
                { id: 96, question: "ã€Œæã€éŒ¢", answer: "ã„Šã„ ", distractors: ["ã„Šã„ ËŠ", "ã„Šã„ Ë‡"] },
                // 26. æ‡ˆ / æ®† / è²½
                { id: 97, question: "æ‡ˆã€Œæ€ ã€", answer: "ã„‰ã„Ë‹", distractors: ["ã„§ËŠ", "ã„Šã„ËŠ"] },
                { id: 98, question: "å±ã€Œæ®†ã€", answer: "ã„‰ã„Ë‹", distractors: ["ã„§ËŠ", "ã„Šã„ËŠ"] },
                { id: 99, question: "ã€Œè²½ã€ç¬‘å¤§æ–¹", answer: "ã„§ËŠ", distractors: ["ã„‰ã„Ë‹", "ã„Šã„ËŠ"] },
                // 27. å¡‘ / æœ”
                { id: 100, question: "ã€Œå¡‘ã€é€ ", answer: "ã„™ã„¨Ë‹", distractors: ["ã„•ã„¨ã„›Ë‹", "ã„™ã„¨"] },
                { id: 101, question: "æ’²ã€Œæœ”ã€", answer: "ã„•ã„¨ã„›Ë‹", distractors: ["ã„™ã„¨Ë‹", "ã„•ã„¨ã„›"] },
                // 28. æ¸ / æ„ˆ / è¸° / é€¾ / è¦¦
                { id: 102, question: "ä¸ã€Œæ¸ã€", answer: "ã„©ËŠ", distractors: ["ã„©Ë‹", "ã„©"] },
                { id: 103, question: "æ¯æ³ã€Œæ„ˆã€", answer: "ã„©Ë‹", distractors: ["ã„©ËŠ", "ã„©"] },
                { id: 104, question: "ä¸ã€Œè¸°ã€çŸ©", answer: "ã„©ËŠ", distractors: ["ã„©Ë‹", "ã„©"] },
                { id: 105, question: "ã€Œé€¾ã€æ™‚", answer: "ã„©ËŠ", distractors: ["ã„©Ë‹", "ã„©"] },
                { id: 106, question: "è¦¬ã€Œè¦¦ã€", answer: "ã„©ËŠ", distractors: ["ã„©Ë‹", "ã„©"] },
                // 29. æ¶¯ / å´– / æ±
                { id: 107, question: "å¤©ã€Œæ¶¯ã€", answer: "ã„§ã„šËŠ", distractors: ["ã„ËŠ", "ã„§ã„š"] },
                { id: 108, question: "æ‡¸ã€Œå´–ã€", answer: "ã„§ã„šËŠ", distractors: ["ã„ËŠ", "ã„§ã„š"] },
                { id: 109, question: "ã€Œæ±ã€ç½µ", answer: "ã„ËŠ", distractors: ["ã„§ã„šËŠ", "ã„"] },
                // 30. é­˜ / é¨ / é¥œ
                { id: 110, question: "å¤¢ã€Œé­˜ã€", answer: "ã„§ã„¢Ë‡", distractors: ["ã„§ã„¢Ë‹", "ã„§ã„Ë‹"] },
                { id: 111, question: "ç¬‘ã€Œé¨ã€", answer: "ã„§ã„Ë‹", distractors: ["ã„§ã„¢Ë‡", "ã„§ã„¢Ë‹"] },
                { id: 112, question: "è²ªå¾—ç„¡ã€Œé¥œã€", answer: "ã„§ã„¢Ë‹", distractors: ["ã„§ã„¢Ë‡", "ã„§ã„Ë‹"] },
                // 31. å½ / ç‚º
                { id: 113, question: "ã€Œå½ã€é€ ", answer: "ã„¨ã„ŸË‹", distractors: ["ã„¨ã„ŸËŠ", "ã„¨ã„ŸË‡"] },
                { id: 114, question: "ã€Œç‚ºã€åœ‹æ•ˆå¿ ", answer: "ã„¨ã„ŸË‹", distractors: ["ã„¨ã„ŸËŠ", "ã„¨ã„ŸË‡"] },
                // 32. æ‰ / æœ­
                { id: 115, question: "æ™ã€Œæ‰ã€", answer: "ã„“ã„š", distractors: ["ã„“ã„šËŠ", "ã„“ã„šË‡"] },
                { id: 116, question: "ã€Œæœ­ã€è¨˜", answer: "ã„“ã„šËŠ", distractors: ["ã„“ã„š", "ã„“ã„šË‡"] },
                // 33. åƒ§ / å¢
                { id: 117, question: "è€ã€Œåƒ§ã€", answer: "ã„™ã„¥", distractors: ["ã„—ã„¥", "ã„™ã„¥Ë‹"] },
                { id: 118, question: "ã€Œå¢ã€åŠ ", answer: "ã„—ã„¥", distractors: ["ã„™ã„¥", "ã„—ã„¥Ë‹"] },
                // 34. å‚· / è§´
                { id: 119, question: "ã€Œå‚·ã€å®³", answer: "ã„•ã„¤", distractors: ["ã„•ã„¤Ë‹", "ã„•ã„¤ËŠ"] },
                { id: 120, question: "æµã€Œè§´ã€", answer: "ã„•ã„¤", distractors: ["ã„•ã„¤Ë‹", "ã„•ã„¤ËŠ"] },
                // 35. æ€¨ / è‹‘
                { id: 121, question: "ã€Œæ€¨ã€å¤©", answer: "ã„©ã„¢Ë‹", distractors: ["ã„©ã„¢", "ã„©ã„¢Ë‡"] },
                { id: 122, question: "å­¸ã€Œè‹‘ã€", answer: "ã„©ã„¢Ë‹", distractors: ["ã„©ã„¢", "ã„©ã„¢Ë‡"] },
                // 36. ç›£ / å …
                { id: 123, question: "ã€Œç›£ã€è¦–", answer: "ã„ã„§ã„¢", distractors: ["ã„ã„§ã„¢Ë‹", "ã„ã„§ã„¢Ë‡"] },
                { id: 124, question: "ã€Œå …ã€å¿", answer: "ã„ã„§ã„¢", distractors: ["ã„ã„§ã„¢Ë‹", "ã„ã„§ã„¢Ë‡"] },
                // 37. ç¤« / çˆ
                { id: 125, question: "æ²™ã€Œç¤«ã€", answer: "ã„Œã„§Ë‹", distractors: ["ã„•ã„¨ã„›Ë‹", "ã„Œã„œË‹"] },
                { id: 126, question: "é–ƒã€Œçˆã€", answer: "ã„•ã„¨ã„›Ë‹", distractors: ["ã„Œã„§Ë‹", "ã„Œã„œË‹"] },
                // 38. è£ / æ ½
                { id: 127, question: "ã€Œè£ã€åˆ¤", answer: "ã„˜ã„ËŠ", distractors: ["ã„—ã„", "ã„˜ã„"] },
                { id: 128, question: "ã€Œæ ½ã€åŸ¹", answer: "ã„—ã„", distractors: ["ã„˜ã„ËŠ", "ã„—ã„Ë‡"] },
                // 39. å¯“ / é‡ / è­½
                { id: 129, question: "ã€Œå¯“ã€æ–¼", answer: "ã„©Ë‹", distractors: ["ã„©ËŠ", "ã„©"] },
                { id: 130, question: "å¾…ã€Œé‡ã€", answer: "ã„©Ë‹", distractors: ["ã„©ËŠ", "ã„©"] },
                { id: 131, question: "æ¦®ã€Œè­½ã€", answer: "ã„©Ë‹", distractors: ["ã„©ËŠ", "ã„©"] },
                // 40. éˆ / é›¶
                { id: 132, question: "åœ°ã€Œéˆã€", answer: "ã„Œã„§ã„¥ËŠ", distractors: ["ã„Œã„§ã„¥Ë‹", "ã„Œã„§ã„¥"] },
                { id: 133, question: "æ¶•ã€Œé›¶ã€", answer: "ã„Œã„§ã„¥ËŠ", distractors: ["ã„Œã„§ã„¥Ë‹", "ã„Œã„§ã„¥"] },
                // 41. ç¾© / æ„
                { id: 134, question: "ã€Œç¾©ã€æ°£", answer: "ã„§Ë‹", distractors: ["ã„§ËŠ", "ã„§"] },
                { id: 135, question: "ã€Œæ„ã€è¦‹", answer: "ã„§Ë‹", distractors: ["ã„§ËŠ", "ã„§"] },
                // 42. æ·± / ç”³
                { id: 136, question: "ã€Œæ·±ã€æƒ¡", answer: "ã„•ã„£", distractors: ["ã„•ã„£ËŠ", "ã„•ã„£Ë‹"] },
                { id: 137, question: "ã€Œç”³ã€è¨´", answer: "ã„•ã„£", distractors: ["ã„•ã„£ËŠ", "ã„•ã„£Ë‹"] },
                // 43. å‹¾ / é£²
                { id: 138, question: "ã€Œå‹¾ã€ç•¶", answer: "ã„ã„¡Ë‹", distractors: ["ã„ã„¡", "ã„ã„¡Ë‡"] },
                // 44. ç‚¬ / é‰…
                { id: 139, question: "ç«ã€Œç‚¬ã€", answer: "ã„ã„©Ë‹", distractors: ["ã„ã„©Ë‡", "ã„ã„©"] },
                { id: 140, question: "ã€Œé‰…ã€ç´°é¡éº", answer: "ã„ã„©Ë‹", distractors: ["ã„ã„©Ë‡", "ã„ã„©"] },
                // 45. å‹
                { id: 141, question: "ã€Œå‹ã€æ•—", answer: "ã„•ã„¥Ë‹", distractors: ["ã„•ã„¥", "ã„•ã„¥Ë‡"] },
                { id: 142, question: "ä¸ã€Œå‹ã€æšèˆ‰", answer: "ã„•ã„¥", distractors: ["ã„•ã„¥Ë‹", "ã„•ã„¥Ë‡"] },
                // 46. æ¯”
                { id: 143, question: "ã€Œæ¯”ã€è³½", answer: "ã„…ã„§Ë‡", distractors: ["ã„…ã„§Ë‹", "ã„…ã„§"] },
                { id: 144, question: "å¤©æ¶¯è‹¥ã€Œæ¯”ã€é„°", answer: "ã„…ã„§Ë‹", distractors: ["ã„…ã„§Ë‡", "ã„…ã„§"] },
                // 47. è·
                { id: 145, question: "è² ã€Œè·ã€", answer: "ã„ã„œË‹", distractors: ["ã„ã„œËŠ", "ã„ã„œ"] },
                { id: 146, question: "ã€Œè·ã€èŠ±", answer: "ã„ã„œËŠ", distractors: ["ã„ã„œË‹", "ã„ã„œ"] },
                // 48. ç¨±
                { id: 147, question: "ã€Œç¨±ã€è®š", answer: "ã„”ã„¥", distractors: ["ã„”ã„£Ë‹", "ã„”ã„¥Ë‹"] },
                { id: 148, question: "å‹»ã€Œç¨±ã€", answer: "ã„”ã„£Ë‹", distractors: ["ã„”ã„¥", "ã„”ã„¥Ë‹"] },
                // 49. å¼·
                { id: 149, question: "ã€Œå¼·ã€å‹", answer: "ã„‘ã„§ã„¤ËŠ", distractors: ["ã„ã„§ã„¤Ë‹", "ã„‘ã„§ã„¤Ë‡"] },
                { id: 150, question: "ã€Œå¼·ã€è€…", answer: "ã„‘ã„§ã„¤ËŠ", distractors: ["ã„ã„§ã„¤Ë‹", "ã„‘ã„§ã„¤Ë‡"] },
                // 50. æ›´
                { id: 151, question: "ä¸‰ã€Œæ›´ã€åŠå¤œ", answer: "ã„ã„¥", distractors: ["ã„ã„¥Ë‹", "ã„ã„£"] },
                { id: 152, question: "ã€Œæ›´ã€åŠ ", answer: "ã„ã„¥Ë‹", distractors: ["ã„ã„¥", "ã„ã„£"] },
                // 51. æƒ¡
                { id: 153, question: "æ·±ã€Œæƒ¡ã€ç—›çµ•", answer: "ã„¨Ë‹", distractors: ["ã„œË‹", "ã„œË‡"] },
                { id: 154, question: "ã€Œæƒ¡ã€é­”", answer: "ã„œË‹", distractors: ["ã„¨Ë‹", "ã„œË‡"] },
            ];

            // --- Helper Functions ---
            const shuffleArray = (array) => {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            };

            const playSound = (type) => {
                const audioPath = type === 'success' ? 'sounds/correct.mp3' : 'sounds/fail.mp3';
                const audio = new Audio(audioPath);
                audio.play().catch(err => console.log('Audio play error:', err));
            }

            const App = () => {
                const [mode, setMode] = useState('menu'); 
                const [currentUser, setCurrentUser] = useState(null);
                const [users, setUsers] = useState([]);
                const [favorites, setFavorites] = useState(new Set());
                const [mistakes, setMistakes] = useState(new Set());
                const [userProgress, setUserProgress] = useState({}); 
                
                const [isFirebaseReady, setIsFirebaseReady] = useState(false);
                const [status, setStatus] = useState('loading'); 

                // 1. Firebase Auth & Global Users Listener
                useEffect(() => {
                    if (!auth) {
                        setStatus('error');
                        return;
                    }

                    const initAuth = async () => {
                        try {
                            setStatus('loading');
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Auth Error:", error);
                            setStatus('error');
                        }
                    };
                    initAuth();

                    const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            setIsFirebaseReady(true);
                            
                            const globalRef = doc(db, COLLECTION_NAME, GLOBAL_DOC_ID);
                            const unsubscribeGlobal = onSnapshot(globalRef, (docSnap) => {
                                if (docSnap.exists()) {
                                    setUsers(docSnap.data().users || []);
                                } else {
                                    setDoc(globalRef, { users: [] }, { merge: true });
                                    setUsers([]);
                                }
                                setStatus('success');
                            }, (error) => {
                                console.error("Global Sync Error:", error);
                                setStatus('error');
                            });

                            return () => unsubscribeGlobal();
                        } else {
                            setIsFirebaseReady(false);
                        }
                    });

                    return () => unsubscribeAuth();
                }, []);

                // 2. User Data Listener
                useEffect(() => {
                    if (currentUser && isFirebaseReady && db) {
                        const userRef = doc(db, COLLECTION_NAME, currentUser);
                        
                        const unsubscribeUser = onSnapshot(userRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                setFavorites(new Set(data.favorites || []));
                                setMistakes(new Set(data.mistakes || []));
                                setUserProgress(data.progress || {});
                            } else {
                                setFavorites(new Set());
                                setMistakes(new Set());
                                setUserProgress({});
                            }
                            setStatus('success');
                        }, (error) => {
                            console.error("User Sync Error:", error);
                            setStatus('error');
                        });

                        return () => unsubscribeUser();
                    } else {
                        setFavorites(new Set());
                        setMistakes(new Set());
                        setUserProgress({});
                    }
                }, [currentUser, isFirebaseReady]);

                // --- Operations ---

                const handleLogin = async (name) => {
                    if (!name.trim()) return;
                    const userName = name.trim();
                    if (!db) {
                        setCurrentUser(userName);
                        setMode('menu');
                        return;
                    }
                    try {
                        const globalRef = doc(db, COLLECTION_NAME, GLOBAL_DOC_ID);
                        await updateDoc(globalRef, { users: arrayUnion(userName) });
                        
                        // Ensure user doc exists
                        const userRef = doc(db, COLLECTION_NAME, userName);
                        const userSnap = await getDoc(userRef);
                        if (!userSnap.exists()) {
                            await setDoc(userRef, { favorites: [], mistakes: [], progress: {} });
                        }

                        setCurrentUser(userName);
                        setMode('menu');
                    } catch (e) {
                        console.error("Login Error:", e);
                        // Fallback logic for first login if updateDoc fails on non-existent doc
                        if (e.code === 'not-found') {
                             const globalRef = doc(db, COLLECTION_NAME, GLOBAL_DOC_ID);
                             await setDoc(globalRef, { users: [userName] });
                             setCurrentUser(userName);
                             setMode('menu');
                        } else {
                             alert("ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
                        }
                    }
                };

                const handleDeleteUser = async (userToDelete) => {
                    if (!db) return;
                    if (window.confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${userToDelete}ã€çš„ç´€éŒ„å—ï¼Ÿ`)) {
                        if (window.confirm(`åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œæ‚¨çœŸçš„ç¢ºå®šè¦åˆªé™¤ã€Œ${userToDelete}ã€å—ï¼Ÿ`)) {
                            try {
                                const globalRef = doc(db, COLLECTION_NAME, GLOBAL_DOC_ID);
                                await updateDoc(globalRef, { users: arrayRemove(userToDelete) });
                                
                                const userRef = doc(db, COLLECTION_NAME, userToDelete);
                                await deleteDoc(userRef);

                                if (currentUser === userToDelete) {
                                    handleLogout();
                                }
                            } catch (e) {
                                console.error("Delete Error:", e);
                                alert("åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                            }
                        }
                    }
                };

                const handleLogout = () => {
                    setCurrentUser(null);
                    setMode('menu');
                };

                const saveUserData = useCallback(async (dataToUpdate) => {
                    if(!currentUser || !isFirebaseReady || !db) return;
                    try {
                        setStatus('loading');
                        const userRef = doc(db, COLLECTION_NAME, currentUser);
                        await setDoc(userRef, dataToUpdate, { merge: true });
                        // Status will be updated by listener
                    } catch (e) {
                        console.error("Save Error:", e);
                        setStatus('error');
                    }
                }, [currentUser, isFirebaseReady]);

                const toggleFavorite = useCallback((id) => {
                    if (!currentUser) return;
                    const newFavorites = new Set(favorites);
                    let op;
                    if (newFavorites.has(id)) {
                        newFavorites.delete(id);
                        op = arrayRemove(id);
                    } else {
                        newFavorites.add(id);
                        op = arrayUnion(id);
                    }
                    
                    setFavorites(newFavorites); // Optimistic
                    if(db) updateDoc(doc(db, COLLECTION_NAME, currentUser), { favorites: op });
                }, [favorites, currentUser]);

                const addMistake = useCallback((id) => {
                    if (!currentUser) return;
                    const newMistakes = new Set(mistakes);
                    if (!newMistakes.has(id)) {
                        newMistakes.add(id);
                        setMistakes(newMistakes); // Optimistic
                        if(db) updateDoc(doc(db, COLLECTION_NAME, currentUser), { mistakes: arrayUnion(id) });
                    }
                }, [mistakes, currentUser]);

                const saveProgress = async (newSelections) => {
                    if(!currentUser || !db) return;
                    await setDoc(doc(db, COLLECTION_NAME, currentUser), { progress: newSelections }, { merge: true });
                }
                
                const resetProgress = async () => {
                    if(!currentUser || !db) return;
                    await updateDoc(doc(db, COLLECTION_NAME, currentUser), { progress: {} });
                }

                if (!currentUser) {
                    return (
                        <LoginView 
                            users={users} 
                            onLogin={handleLogin} 
                            onDeleteUser={handleDeleteUser} 
                            status={status} 
                        />
                    );
                }
                
                return (
                    <div className="min-h-screen bg-orange-50 text-stone-800 font-sans">
                        {/* Header */}
                        <header className="bg-orange-600 text-white p-4 shadow-lg sticky top-0 z-20">
                            <div className="max-w-4xl mx-auto flex justify-between items-center">
                                <div className="flex items-center space-x-2 cursor-pointer" onClick={() => setMode('menu')}>
                                <BookOpen size={28} />
                                <div className="flex flex-col">
                                    <h1 className="text-xl md:text-2xl font-bold tracking-wider">L1é‹å‹•å®¶çš„é¢¨åº¦</h1>
                                    <h2 className="text-xs text-orange-200">å­—éŸ³ç·´ç¿’</h2>
                                </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                <div className="hidden sm:flex items-center bg-black/20 px-3 py-1 rounded-full text-xs" title={status}>
                                    <span className={`status-dot status-${status}`}></span>
                                    <span className="text-white/90">{status === 'loading' ? 'åŒæ­¥ä¸­...' : status === 'success' ? 'å·²åŒæ­¥' : 'é€£ç·šç•°å¸¸'}</span>
                                </div>

                                <div className="hidden md:flex items-center bg-orange-700 px-3 py-1 rounded-full text-sm">
                                    <User size={16} className="mr-2"/>
                                    <span className="font-bold truncate max-w-[100px]">{currentUser}</span>
                                </div>
                                {mode !== 'menu' && (
                                    <button onClick={() => setMode('menu')} className="text-orange-100 hover:text-white transition font-medium">å›é¦–é </button>
                                )}
                                <button onClick={handleLogout} className="flex items-center text-orange-200 hover:text-white transition" title="ç™»å‡º">
                                    <LogOut size={20} />
                                </button>
                                </div>
                            </div>
                        </header>

                        <main className="max-w-4xl mx-auto p-4 md:p-6">
                            {mode === 'menu' && (
                                <div className="flex flex-col items-center justify-center space-y-8 py-12 animate-in fade-in duration-500">
                                <div className="text-center space-y-4">
                                    <div className="bg-orange-100 p-4 rounded-full inline-block mb-2">
                                    <Sun size={48} className="text-orange-500" />
                                    </div>
                                    <h2 className="text-3xl font-bold text-orange-900">æ­¡è¿å›ä¾†ï¼Œ{currentUser}</h2>
                                    <p className="text-stone-600 text-lg max-w-md">è«‹é¸æ“‡ä¸‹åˆ—åŠŸèƒ½é–‹å§‹å­¸ç¿’</p>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                                    <MenuButton onClick={() => setMode('study')} icon={<List size={40} className="text-orange-600" />} title="å…¨è¡¨ç€è¦½" desc="å®Œæ•´æª¢è¦–å­—éŸ³è¾¨æ­£è³‡æ–™åº«" />
                                    <MenuButton onClick={() => setMode('quiz')} icon={<Zap size={40} className="text-orange-600" />} title="é–ƒé›»åˆ·é¡Œ" desc="ç€‘å¸ƒæµå¼å¿«é€ŸæŒ‘æˆ°" />
                                    <MenuButton onClick={() => setMode('favorites')} icon={<Heart size={40} className="text-red-500 fill-red-500" />} title="æˆ‘çš„æœ€æ„›" desc="è¤‡ç¿’æ‚¨æ”¶è—çš„é‡é»é¡Œç›®" highlight="red" />
                                    <MenuButton onClick={() => setMode('mistakes')} icon={<BookX size={40} className="text-stone-600" />} title="éŒ¯é¡Œè¤‡ç¿’" desc="é‡å°ç­”éŒ¯çš„é¡Œç›®åŠ å¼·ç·´ç¿’" highlight="stone" />
                                </div>

                                <div style={{ marginTop: '20px' }}>
                                    <a href="index.html" 
                                       className="btn btn-gray hover:opacity-90 transition-opacity shadow-md" 
                                       style={{
                                           textDecoration: 'none', 
                                           padding: '10px 20px',
                                           background: 'linear-gradient(135deg, #ff4081 0%, #d81b60 100%)',
                                           color: 'white', 
                                           borderRadius: '999px', 
                                           display: 'inline-block',
                                           fontWeight: 'bold'
                                       }}>
                                        ğŸ  è¿”å›åœ‹æ–‡å­¸ç¿’ App ç¸½éƒ¨
                                    </a>
                                </div>
                                </div>
                            )}

                            {mode === 'study' && <TableView data={rawData} favorites={favorites} onToggleFavorite={toggleFavorite} title="å­—éŸ³è¾¨æ­£ä¸€è¦½è¡¨" />}
                            {mode === 'favorites' && <TableView data={rawData.filter(item => favorites.has(item.id))} favorites={favorites} onToggleFavorite={toggleFavorite} title="æˆ‘çš„æœ€æ„›æ¸…å–®" emptyMessage="æ‚¨é‚„æ²’æœ‰åŠ å…¥ä»»ä½•æœ€æ„›é¡Œç›®å–”ï¼" />}
                            {mode === 'mistakes' && <TableView data={rawData.filter(item => mistakes.has(item.id))} favorites={favorites} onToggleFavorite={toggleFavorite} title="éŒ¯é¡Œè¤‡ç¿’æœ¬" emptyMessage="å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰éŒ¯é¡Œç´€éŒ„ã€‚" />}
                            {mode === 'quiz' && (
                                <WaterfallQuizView 
                                    data={rawData} 
                                    currentUser={currentUser}
                                    progress={userProgress} 
                                    onSaveProgress={saveProgress} 
                                    onResetProgress={resetProgress}
                                    favorites={favorites} 
                                    onToggleFavorite={toggleFavorite} 
                                    onAddMistake={addMistake} 
                                    onExit={() => setMode('menu')} 
                                />
                            )}
                        </main>
                    </div>
                );
            };

            const MenuButton = ({ onClick, icon, title, desc, highlight = "orange" }) => {
                const bgClass = highlight === "red" ? "bg-red-50" : highlight === "stone" ? "bg-stone-100" : "bg-orange-100";
                return (
                    <button onClick={onClick} className="flex flex-col items-center p-8 bg-white rounded-2xl shadow-sm hover:shadow-xl hover:bg-orange-50 transition border-2 border-orange-100 hover:border-orange-300 group">
                        <div className={`${bgClass} p-4 rounded-full mb-4 group-hover:scale-110 transition`}>{icon}</div>
                        <h3 className="text-xl font-bold text-orange-900">{title}</h3>
                        <p className="text-stone-500 mt-2">{desc}</p>
                    </button>
                )
            }

            const LoginView = ({ users, onLogin, onDeleteUser, status }) => {
                const [inputName, setInputName] = useState("");
                return (
                    <div className="min-h-screen bg-orange-50 flex items-center justify-center p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-2 border-orange-100 relative">
                            <div className="absolute top-4 right-4 flex items-center bg-stone-100 px-2 py-1 rounded-full text-xs">
                                <span className={`status-dot status-${status}`}></span>
                                <span className="text-stone-600">{status === 'loading' ? 'é€£ç·šä¸­...' : status === 'success' ? 'é›²ç«¯å°±ç·’' : 'é€£ç·šç•°å¸¸'}</span>
                            </div>

                            <div className="text-center mb-8">
                                <div className="bg-orange-100 p-3 rounded-full inline-block mb-4"><BookOpen size={40} className="text-orange-600" /></div>
                                <h1 className="text-2xl font-bold text-orange-900">å­—éŸ³ç·´ç¿’App</h1>
                                <p className="text-stone-500 mt-2">è«‹è¼¸å…¥å§“åä»¥é–‹å§‹å­¸ç¿’</p>
                            </div>
                            <form onSubmit={(e) => { e.preventDefault(); if(inputName.trim()) onLogin(inputName.trim()); }} className="space-y-4">
                                <input type="text" value={inputName} onChange={(e) => setInputName(e.target.value)} placeholder="è¼¸å…¥æ‚¨çš„åå­—" className="w-full px-4 py-3 rounded-xl border border-orange-200 focus:outline-none focus:ring-2 focus:ring-orange-400 text-lg" autoFocus />
                                <button type="submit" disabled={!inputName.trim() || status === 'loading'} className="w-full py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-xl font-bold text-lg transition disabled:opacity-50">é–‹å§‹ä½¿ç”¨</button>
                            </form>
                            
                            <div className="mt-8">
                                <div className="relative mb-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-stone-200"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-stone-500">å¿«é€Ÿç™»å…¥</span></div></div>
                                
                                {users && users.length > 0 ? (
                                    <div className="flex flex-wrap gap-4 justify-center">
                                        {users.map((user, idx) => (
                                            <div key={idx} className="relative group user-btn-wrapper">
                                                <button onClick={() => onLogin(user)} className="px-6 py-3 bg-stone-100 hover:bg-orange-100 text-stone-700 hover:text-orange-700 rounded-lg text-lg font-medium transition w-full min-w-[100px]">{user}</button>
                                                <button onClick={(e) => { e.stopPropagation(); onDeleteUser(user); }} className="delete-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 shadow-sm" title="åˆªé™¤æ­¤ä½¿ç”¨è€…"><Trash2 size={16} /></button>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-4 bg-orange-50/50 rounded-xl border border-dashed border-orange-200">
                                        <p className="text-orange-800 font-medium">å°šç„¡æŒ‘æˆ°è€…ç´€éŒ„ï¼Œæ­¡è¿åŠ å…¥ï¼</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const TableView = ({ data, favorites, onToggleFavorite, title, emptyMessage = "æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„è³‡æ–™" }) => {
                const [searchTerm, setSearchTerm] = useState("");
                const filteredData = data.filter(item => item.question.includes(searchTerm) || item.answer.includes(searchTerm) || item.id.toString().includes(searchTerm));

                return (
                    <div className="bg-white rounded-xl shadow-lg overflow-hidden border border-orange-200 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <div className="p-4 border-b border-orange-100 bg-orange-50 flex flex-col md:flex-row justify-between items-center gap-4">
                        <h2 className="text-xl font-bold text-orange-900 flex items-center"><List className="mr-2" size={24} />{title}</h2>
                        <input type="text" placeholder="æœå°‹é¡Œç›®æˆ–è§£ç­”..." className="px-4 py-2 rounded-lg border border-orange-200 focus:outline-none focus:ring-2 focus:ring-orange-400 w-full md:w-64 bg-white" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                    </div>
                    
                    <div className="overflow-x-auto max-h-[70vh]">
                        <table className="w-full text-left">
                        <thead className="bg-orange-100 sticky top-0 z-10 shadow-sm">
                            <tr>
                            <th className="p-4 font-black text-orange-900 border-b-2 border-orange-200 w-16 text-center">æ”¶è—</th>
                            <th className="p-4 font-black text-orange-900 border-b-2 border-orange-200 w-24">ç·¨è™Ÿ</th>
                            <th className="p-4 font-black text-orange-900 border-b-2 border-orange-200">é¡Œç›®</th>
                            <th className="p-4 font-black text-orange-900 border-b-2 border-orange-200 w-80">æ­£ç¢ºè§£ç­”</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-orange-50">
                            {filteredData.length > 0 ? filteredData.map((item) => (
                                <tr key={item.id} className="hover:bg-orange-50 transition-colors group">
                                <td className="p-4 text-center">
                                    <button onClick={() => onToggleFavorite(item.id)} className={`transition transform active:scale-90 p-1 rounded-full hover:bg-orange-100 ${favorites.has(item.id) ? 'text-red-500' : 'text-stone-300 hover:text-red-400'}`}>
                                        <Heart size={20} className={favorites.has(item.id) ? "fill-current heart-click" : ""} />
                                    </button>
                                </td>
                                <td className="p-4 text-stone-500 font-mono font-medium">{item.id}</td>
                                <td className="p-4 text-stone-800 text-lg font-medium">{item.question}</td>
                                <td className="p-4 text-orange-700 text-xl font-bold">{item.answer}</td>
                                </tr>
                            )) : (
                                <tr>
                                    <td colSpan="4" className="p-12 text-center text-stone-400 flex flex-col items-center justify-center">
                                        <div className="mb-2 bg-stone-100 p-4 rounded-full"><List size={32} /></div>
                                        <p>{emptyMessage}</p>
                                    </td>
                                </tr>
                            )}
                        </tbody>
                        </table>
                    </div>
                    <div className="p-3 bg-orange-50 border-t border-orange-200 text-center text-sm text-stone-500">é¡¯ç¤º {filteredData.length} ç­†è³‡æ–™</div>
                    </div>
                );
            };

            const WaterfallQuizView = ({ data, currentUser, progress, onSaveProgress, onResetProgress, favorites, onToggleFavorite, onAddMistake, onExit }) => {
                const [quizData, setQuizData] = useState([]);
                const [selections, setSelections] = useState(progress || {});

                useEffect(() => {
                    const preparedData = data.map(item => ({ ...item, options: shuffleArray([item.answer, ...item.distractors]) }));
                    setQuizData(preparedData);
                }, [data]);

                useEffect(() => {
                    setSelections(progress || {});
                }, [progress]);

                const handleSelect = (questionId, option) => {
                    const newSelections = { ...selections, [questionId]: option };
                    setSelections(newSelections);
                    onSaveProgress(newSelections);
                    
                    const currentQuestion = data.find(item => item.id === questionId);
                    const isCorrect = option === currentQuestion.answer;
                    if (isCorrect) {
                        playSound('success');
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    } else {
                        playSound('error');
                        onAddMistake(questionId);
                    }
                };
                
                const completedCount = Object.keys(selections).length;
                const progressPercent = Math.round((completedCount / data.length) * 100);

                return (
                    <div className="max-w-4xl mx-auto pb-20">
                    <div className="sticky top-16 z-10 bg-orange-50/95 backdrop-blur-sm pt-4 pb-2 border-b border-orange-200 mb-6 shadow-sm">
                        <div className="flex justify-between items-center mb-2 px-2">
                            <div>
                                <h2 className="text-xl font-bold text-orange-900 flex items-center gap-2"><Zap size={24} className="fill-orange-500 text-orange-600"/>é–ƒé›»åˆ·é¡Œ</h2>
                                <p className="text-xs text-stone-500 mt-1">ä½œç­”è€…: {currentUser} | å·²å®Œæˆ: {completedCount} / {data.length} é¡Œ</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => { if(window.confirm('ç¢ºå®šè¦æ¸…ç©ºé€²åº¦é‡ä¾†å—ï¼Ÿ')) { const empty = {}; setSelections(empty); onResetProgress(); window.scrollTo(0,0); }}} className="px-3 py-1.5 bg-white border border-orange-300 text-orange-700 rounded-lg hover:bg-orange-50 font-medium text-xs sm:text-sm transition">é‡ç½®</button>
                                <button onClick={onExit} className="px-3 py-1.5 bg-stone-600 text-white rounded-lg hover:bg-stone-700 font-medium text-xs sm:text-sm transition">æš«åœ</button>
                            </div>
                        </div>
                        <div className="w-full bg-orange-200 h-2.5 rounded-full overflow-hidden"><div className="bg-orange-600 h-2.5 rounded-full progress-bar shadow-[0_0_10px_rgba(249,115,22,0.5)]" style={{ width: `${progressPercent}%` }}></div></div>
                    </div>

                    <div className="space-y-6">
                        {quizData.map((item) => {
                            const userSelection = selections[item.id];
                            const isAnswered = userSelection !== undefined;
                            const isCorrect = userSelection === item.answer;
                            const isFav = favorites.has(item.id);
                            
                            return (
                                <div key={item.id} className={`bg-white rounded-xl shadow-sm border-2 transition-all duration-300 overflow-hidden ${isAnswered ? (isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50') : 'border-orange-100'}`}>
                                    <div className="p-4 border-b border-black/5 flex items-start gap-3">
                                        <span className="bg-orange-100 text-orange-800 font-mono font-bold px-2 py-1 rounded text-sm shrink-0 mt-1">#{item.id}</span>
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2">
                                                <button onClick={(e) => { e.stopPropagation(); onToggleFavorite(item.id); }} className={`transition transform active:scale-90 p-1 rounded-full -ml-2 ${isFav ? 'text-red-500' : 'text-stone-300 hover:text-red-400'}`} title={isFav ? "å–æ¶ˆæ”¶è—" : "åŠ å…¥æœ€æ„›"}>
                                                    <Heart size={20} className={isFav ? "fill-current heart-click" : ""} />
                                                </button>
                                                <h3 className="text-xl md:text-2xl font-bold text-stone-800 leading-snug">{item.question}</h3>
                                            </div>
                                        </div>
                                        {isAnswered && <div className="ml-auto shrink-0">{isCorrect ? <CheckCircle className="text-green-500" /> : <XCircle className="text-red-500" />}</div>}
                                    </div>
                                    <div className="p-4 bg-white/50">
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                            {item.options.map((option, idx) => {
                                                let btnClass = "py-4 px-2 rounded-lg font-bold text-2xl md:text-3xl transition-all border-2 relative ";
                                                if (isAnswered) {
                                                    if (option === item.answer) btnClass += "bg-green-500 text-white border-green-600 shadow-md";
                                                    else if (option === userSelection && !isCorrect) btnClass += "bg-red-500 text-white border-red-600 shadow-md";
                                                    else btnClass += "bg-stone-100 text-stone-400 border-transparent opacity-50";
                                                } else {
                                                    btnClass += "bg-white text-stone-700 border-stone-200 hover:border-orange-400 hover:bg-orange-50 active:scale-95";
                                                }
                                                return <button key={idx} onClick={() => !isAnswered && handleSelect(item.id, option)} disabled={isAnswered} className={btnClass}>{option}</button>;
                                            })}
                                        </div>
                                        {isAnswered && !isCorrect && (
                                            <div className="mt-3 text-sm text-red-600 font-medium animate-in fade-in slide-in-from-top-1">
                                                æ­£ç¢ºç­”æ¡ˆï¼š{item.answer}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    {progressPercent === 100 && (
                        <div className="mt-8 p-8 bg-green-100 rounded-2xl text-center border-2 border-green-300 animate-in zoom-in duration-300">
                            <h3 className="text-2xl font-bold text-green-800 mb-2">æ­å–œå®Œæˆæ‰€æœ‰é¡Œç›®ï¼</h3>
                            <button onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })} className="mt-4 text-green-700 underline hover:text-green-900">å›åˆ°é ‚éƒ¨</button>
                        </div>
                    )}
                    </div>
                );
            };

            const root = createRoot(document.getElementById('root'));
            root.render(<App />);
        }
    </script>
</body>
</html>