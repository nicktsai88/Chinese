<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬4å†Š L1 é‹å‹•å®¶çš„é¢¨åº¦ æ³¨é‡‹ç·´ç¿’ (é›²ç«¯ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom scrollbar for better aesthetics - Warm Orange Theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #fff7ed; 
        }
        ::-webkit-scrollbar-thumb {
            background: #fdba74; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #fb923c; 
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .progress-bar {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes heartbeat {
            0% { transform: scale(1); }
            25% { transform: scale(1.2); }
            50% { transform: scale(1); }
            75% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .heart-click {
            animation: heartbeat 0.4s ease-in-out;
        }
        /* Zhuyin Font Style */
        .zhuyin-text {
            font-family: "Bopomofo", system-ui, -apple-system, sans-serif;
            color: #ea580c; /* orange-600 */
        }
        /* Loading Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ea580c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ç‹€æ…‹ç‡ˆè™Ÿæ¨£å¼ */
        .status-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-loading {
            background-color: #fbbf24; /* Amber-400 */
            box-shadow: 0 0 4px #fbbf24;
            animation: pulse-status 1.5s infinite;
        }
        .status-success {
            background-color: #34d399; /* Emerald-400 */
            box-shadow: 0 0 4px #34d399;
        }
        .status-error {
            background-color: #f87171; /* Red-400 */
            box-shadow: 0 0 4px #f87171;
        }
        .status-offline {
            background-color: #9ca3af; /* Gray-400 */
        }
        @keyframes pulse-status {
            0% { opacity: 0.4; }
            50% { opacity: 1; }
            100% { opacity: 0.4; }
        }
        /* åˆå§‹åŠ è¼‰é®ç½© */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff7ed;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body class="bg-orange-50">
    <!-- åˆå§‹åŠ è¼‰ç•«é¢ï¼Œé˜²æ­¢ç™½å± -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-orange-600 font-bold">æ­£åœ¨è¼‰å…¥å­¸ç¿’è³‡æº...</p>
    </div>

    <div id="root"></div>

    <!-- 1. æ¨¡çµ„é åŠ è¼‰å™¨ (Module Pre-loader) -->
    <!-- é€™æ®µä»£ç¢¼è² è²¬å¾ç¶²è·¯ä¸‹è¼‰æ‰€æœ‰ä¾è³´ï¼Œä¸¦æ›è¼‰åˆ° window å…¨å±€è®Šé‡ï¼Œä¾› Babel è…³æœ¬ä½¿ç”¨ -->
    <script type="module">
        // å°å…¥ React
        import React from "https://esm.sh/react@18.2.0";
        import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";
        
        // å°å…¥ UI çµ„ä»¶åº“ Lucide React
        import * as Lucide from "https://esm.sh/lucide-react@0.263.1";
        
        // å°å…¥ç‰¹æ•ˆåº“
        import confetti from "https://esm.sh/canvas-confetti@1.9.2";
        
        // å°å…¥ Firebase (ä½¿ç”¨ Google å®˜æ–¹ CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // å°‡æ¨¡çµ„æ›è¼‰åˆ°å…¨å±€ window å°è±¡
        window.React = React;
        window.ReactDOM = ReactDOM;
        window.Lucide = Lucide;
        window.confetti = confetti;
        window.Firebase = {
            initializeApp,
            getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, onSnapshot, collection,
            getAuth, signInAnonymously
        };

        // é€šçŸ¥æ‡‰ç”¨ç¨‹åºä¾è³´å·²æº–å‚™å°±ç·’ (è§¸ç™¼è‡ªå®šç¾©äº‹ä»¶)
        window.dispatchEvent(new Event('modules-loaded'));
    </script>

    <!-- 2. ä¸»æ‡‰ç”¨ç¨‹åºé‚è¼¯ (Main App Logic) -->
    <!-- ä½¿ç”¨ text/babel é¡å‹ï¼Œä½†ä¸ä½¿ç”¨ import èªå¥ï¼Œè€Œæ˜¯å¾ window ç²å–è®Šé‡ -->
    <script type="text/babel">
        // ç­‰å¾…æ¨¡çµ„åŠ è¼‰å®Œæˆå¾Œå†å•Ÿå‹• React
        window.addEventListener('modules-loaded', () => {
            initApp();
        });

        // å¦‚æœåœ¨äº‹ä»¶ç›£è½å™¨æ›è¼‰å‰æ¨¡çµ„å·²ç¶“åŠ è¼‰å®Œç•¢ï¼ˆé›–ç„¶ä¸å¤ªå¯èƒ½ï¼Œä¿éšªèµ·è¦‹ï¼‰ï¼Œæª¢æŸ¥è®Šé‡
        if (window.React && window.Firebase) {
             // ç¨å¾®å»¶é²ä»¥ç¢ºä¿ DOM æº–å‚™å°±ç·’
             setTimeout(initApp, 100);
        }

        function initApp() {
            // éš±è—åŠ è¼‰ç•«é¢
            const loader = document.getElementById('loading-overlay');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 500);
            }

            // --- è®Šé‡è§£æ§‹ (æ›¿ä»£ import) ---
            const { useState, useEffect, useMemo, useCallback } = window.React;
            const { createRoot } = window.ReactDOM;
            // ç¢ºä¿å¾ Lucide ä¸­ç²å–æ‰€æœ‰åœ–æ¨™
            const { BookOpen, HelpCircle, CheckCircle, XCircle, ArrowRight, RefreshCcw, List, Sun, User, LogOut, Zap, Heart, BookX, Brain, Cloud, CloudOff, Wifi, WifiOff, Trash2 } = window.Lucide;
            const confetti = window.confetti;
            
            // Firebase å‡½æ•¸
            const { initializeApp, getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, onSnapshot, collection, getAuth, signInAnonymously } = window.Firebase;

            // ------------------------------------------------------------------
            // â˜…â˜…â˜… è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ FIREBASE è¨­å®š (å¾ Firebase Console è¤‡è£½) â˜…â˜…â˜…
            // ------------------------------------------------------------------
            const firebaseConfig = {
                apiKey: "AIzaSyAxQFt76ZPXE7d0i1XeNZ1yiiD2WYNIfHs",
                authDomain: "chinese-learning-47f4d.firebaseapp.com",
                projectId: "chinese-learning-47f4d",
                storageBucket: "chinese-learning-47f4d.firebasestorage.app",
                messagingSenderId: "76289812052",
                appId: "1:76289812052:web:898384a916f9f341f62fc1"
            };

            // Initialize Firebase
            let db;
            let auth;
            let isFirebaseReady = false;

            try {
                if (firebaseConfig.apiKey !== "è«‹å¡«å…¥æ‚¨çš„API_KEY") {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    isFirebaseReady = true;
                } else {
                    console.warn("å°šæœªè¨­å®š Firebase Configï¼Œè«‹åƒé–±æ•™å­¸è¨­å®šã€‚");
                }
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
            }

            // COLLECTION REFERENCES
            const COLLECTION_NAME = 'Chinese4-L1-1';
            const DOC_GLOBAL = 'global_metadata';

            // æ³¨é‡‹æˆ–æ‘˜é‡‹å®Œæ•´è³‡æ–™åº«
            const rawData = [
                // --- èªè©éƒ¨åˆ† ---
                { id: 1, question: "é™¶é‘„", zhuyin: "ã„Šã„ ËŠ ã„“ã„¨Ë‹", answer: "åŸæŒ‡å°‡é‡‘å±¬é”åŒ–å€’å…¥é™¶è£½æ¨¡å‹ä¸­å†·å»å‡å›ºï¼Œåšæˆå„ç¨®å™¨ç‰©ã€‚æ–‡ä¸­æ¯”å–»é€ å°±ã€åŸ¹è‚²ã€‚", type: "term" },
                { id: 2, question: "é›å®¹", zhuyin: "ã„©ã„¥ ã„–ã„¨ã„¥ËŠ", answer: "å„€æ…‹å¾å®¹å„ªé›…ã€‚", type: "term" },
                { id: 3, question: "ç½ç½", zhuyin: "ã„ã„¨ã„ŸËŠ ã„ã„¨ã„ŸËŠ", answer: "å¼µå¤§çœ¼ç›æ³¨è¦–çš„æ¨£å­ã€‚", type: "term" },
                { id: 4, question: "è¬ç›®ç½ç½", zhuyin: "ã„¨ã„¢Ë‹ ã„‡ã„¨Ë‹ ã„ã„¨ã„ŸËŠ ã„ã„¨ã„ŸËŠ", answer: "çœ¾äººçš„çœ¼ç›åœ¨æ³¨è¦–ã€ç›£ç£ã€‚", type: "term" },
                { id: 5, question: "ä¸å±‘", zhuyin: "ã„…ã„¨Ë‹ ã„’ã„§ã„Ë‹", answer: "èªç‚ºä¸å€¼å¾—ã€‚å±‘ï¼Œèˆ‡ã€Œä¸ã€é€£ç”¨ï¼Œè¡¨ç¤ºè¼•è¦–ä¹‹æ„ã€‚", type: "term" },
                { id: 6, question: "æ‚»æ‚»ç„¶", zhuyin: "ã„’ã„§ã„¥Ë‹ ã„’ã„§ã„¥Ë‹ ã„–ã„¢ËŠ", answer: "æ†¤æ¨ä¸å¹³çš„æ¨£å­ã€‚", type: "term" },
                { id: 7, question: "å…¬è«¸", zhuyin: "ã„ã„¨ã„¥ ã„“ã„¨", answer: "å°‡å®ƒå…¬é–‹åœ¨......ã€‚ã€Œè«¸ã€æ˜¯ã€Œä¹‹æ–¼ã€äºŒå­—çš„åˆéŸ³ã€‚", type: "term" },
                { id: 8, question: "æ–è®“è€Œå‡", zhuyin: "ã„§ ã„–ã„¤Ë‹ ã„¦ËŠ ã„•ã„¥", answer: "æ‹±æ‰‹è¡Œç¦®ï¼Œç„¶å¾Œç™»è‡ºã€‚(æ–ï¼šæ‹±æ‰‹è¡Œç¦®)ã€‚", type: "term" },
                { id: 9, question: "ä¸‹è€Œé£²", zhuyin: "ã„’ã„§ã„šË‹ ã„¦ËŠ ã„§ã„£Ë‹", answer: "æ¯”è³½å®Œç•¢ï¼Œä½œæ–ä¸‹è‡ºï¼Œå‹è€…è«‹è¼¸è€…å–é…’ã€‚(é£²ï¼šç‰¹æŒ‡è«‹å°æ–¹å–é…’)ã€‚", type: "term" },
                { id: 10, question: "å›å­ç„¡æ‰€çˆ­", zhuyin: "ã„ã„©ã„£ ã„—Ë‡ ã„¨ËŠ ã„™ã„¨ã„›Ë‡ ã„“ã„¥", answer: "å›å­é‡ç¦®è®“ï¼Œæ²’æœ‰ä»€éº¼è¦ç«¶çˆ­çš„ã€‚", type: "term" },
                { id: 11, question: "å¿…ä¹Ÿå°„ä¹", zhuyin: "ã„…ã„§Ë‹ ã„§ã„Ë‡ ã„•ã„œË‹ ã„ã„¨", answer: "å¦‚æœæœ‰(ç«¶çˆ­)ï¼Œä¹Ÿåªæœ‰åœ¨æ¯”è³½å°„ç®­çš„æ™‚å€™ã€‚", type: "term" },
                { id: 12, question: "æ­æ›‰", zhuyin: "ã„ã„§ã„ ã„’ã„§ã„ Ë‡", answer: "å…¬å¸ƒä½¿äººçŸ¥æ‚‰ï¼›å…¬é–‹è¡¨éœ²å‡ºä¾†ã€‚", type: "term" },
                { id: 13, question: "ç«­èª ", zhuyin: "ã„ã„§ã„ËŠ ã„”ã„¥ËŠ", answer: "ç›¡ã€çª®ç›¡ï¼›ååˆ†èª æ‡‡ã€‚", type: "term" },
                { id: 14, question: "ç²¾ç¾©", zhuyin: "ã„ã„§ã„¥ ã„§Ë‹", answer: "ç²¾è¦çš„ç¾©ç†ã€‚", type: "term" },
                { id: 15, question: "å‚³è¨˜", zhuyin: "ã„“ã„¨ã„¢Ë‹ ã„ã„§Ë‹", answer: "è¨˜è¿°ä¸€å€‹äººç”Ÿå¹³äº‹è¹Ÿçš„ä½œå“ã€‚", type: "term" },
                { id: 16, question: "å°äºº", zhuyin: "ã„’ã„§ã„ Ë‡ ã„–ã„£ËŠ", answer: "æ­¤æŒ‡å“å¾·ä¸å¥½çš„äººã€‚(è§£æå·è£œå……ï¼šäº¦å¯æŒ‡å¹³æ°‘ç™¾å§“ï¼Œä½†åœ¨æœ¬èª²æŒ‡ç„¡å¾·ä¹‹äºº)ã€‚", type: "term" },
                { id: 17, question: "æš—ç®­å‚·äºº", zhuyin: "ã„¢Ë‹ ã„ã„§ã„¢Ë‹ ã„•ã„¤ ã„–ã„£ËŠ", answer: "è¶äººä¸å‚™ï¼Œç”¨ç‹¡è©é™°éšªçš„æ‰‹æ®µå‚·å®³äººã€‚", type: "term" },
                { id: 18, question: "èƒŒåœ°", zhuyin: "ã„…ã„ŸË‹ ã„‰ã„§Ë‹", answer: "æš—ä¸­ã€‚", type: "term" },
                { id: 19, question: "å å°ä¾¿å®œ", zhuyin: "ã„“ã„¢Ë‹ ã„’ã„§ã„ Ë‡ ã„†ã„§ã„¢ËŠ ã„§ËŠ", answer: "ç”¨æŠ•æ©Ÿæˆ–ä¸æ­£ç•¶çš„æ–¹æ³•å¾—åˆ°é¡å¤–çš„å¥½è™•ã€‚", type: "term" },
                { id: 20, question: "æ’æ–¥", zhuyin: "ã„†ã„ËŠ ã„”Ë‹", answer: "æ’é™¤é§æ–¥ï¼›æ’é™¤æ‹’çµ•ã€æ‘’æ£„ä¸ç”¨ã€‚", type: "term" },
                { id: 21, question: "è¦ºå¯Ÿ", zhuyin: "ã„ã„©ã„ËŠ ã„”ã„šËŠ", answer: "å¯ŸçŸ¥ã€‚", type: "term" },
                { id: 22, question: "è‡¨é™£è„«é€ƒ", zhuyin: "ã„Œã„§ã„£ËŠ ã„“ã„£Ë‹ ã„Šã„¨ã„› ã„Šã„ ËŠ", answer: "è»äººè‡¨åˆ°ä¸Šé™£ä½œæˆ°æ™‚å»é€ƒè·‘äº†ã€‚æ„è¬‚è‡¨å ´é€€æ€¯ã€‚", type: "term" },
                { id: 23, question: "åŠé€”è€Œå»¢", zhuyin: "ã„…ã„¢Ë‹ ã„Šã„¨ËŠ ã„¦ËŠ ã„ˆã„ŸË‹", answer: "äº‹æƒ…æ²’åšæˆåŠŸå°±åœæ­¢ã€‚æ¯”å–»åšäº‹æƒ…æœ‰å§‹ç„¡çµ‚ã€‚", type: "term" },
                { id: 24, question: "è²«å¾¹å§‹çµ‚", zhuyin: "ã„ã„¨ã„¢Ë‹ ã„”ã„œË‹ ã„•Ë‡ ã„“ã„¨ã„¥", answer: "è‡ªå§‹è‡³çµ‚ï¼Œæ¾ˆåº•å¯¦è¸ã€‚", type: "term" },
                { id: 25, question: "æ€¨å¤©å°¤äºº", zhuyin: "ã„©ã„¢Ë‹ ã„Šã„§ã„¢ ã„§ã„¡ËŠ ã„–ã„£ËŠ", answer: "æ‡·æ¨ä¸Šå¤©ï¼Œè²¬æ€ªä»–äººã€‚(å°¤ï¼šè²¬æ€ª)ã€‚", type: "term" },
                { id: 26, question: "æ€¨å°¤", zhuyin: "ã„©ã„¢Ë‹ ã„§ã„¡ËŠ", answer: "æ€¨æ¨è²¬æ€ªã€‚", type: "term" },
                { id: 27, question: "ç„¡å‹•æ–¼è¡·", zhuyin: "ã„¨ËŠ ã„‰ã„¨ã„¥Ë‹ ã„©ËŠ ã„“ã„¨ã„¥", answer: "å¿ƒè£¡ä¸€é»ä¹Ÿä¸å—æ„Ÿå‹•ã€‚äº¦ä½œã€Œå¾—å¤±ç„¡å‹•æ–¼è¡·ã€ã€‚", type: "term" },
                { id: 28, question: "å¾—å¤±ç„¡å‹•æ–¼è¡·", zhuyin: "ã„‰ã„œËŠ ã„• ã„¨ËŠ ã„‰ã„¨ã„¥Ë‹ ã„©ËŠ ã„“ã„¨ã„¥", answer: "ä¸è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œå…§å¿ƒéƒ½ä¸æœƒå—åˆ°å½±éŸ¿ã€‚", type: "term" },
                { id: 29, question: "ä»»é‡é“é ", zhuyin: "ã„–ã„£Ë‹ ã„“ã„¨ã„¥Ë‹ ã„‰ã„ Ë‹ ã„©ã„¢Ë‡", answer: "æŒ‡è²¬ä»»é‡å¤§ï¼Œè·¯é€”é™é ï¼Œéœ€è¦é•·æœŸè‰±è‹¦å¥®é¬¥ã€‚", type: "term" },
                { id: 30, question: "è¨€å¿…ä¿¡ï¼Œè¡Œå¿…æœ", zhuyin: "ã„§ã„¢ËŠ ã„…ã„§Ë‹ ã„’ã„§ã„£Ë‹ ï¼Œ ã„’ã„§ã„¥ËŠ ã„…ã„§Ë‹ ã„ã„¨ã„›Ë‡", answer: "èªªè©±å¿…å®šè¦å®ˆä¿¡ï¼Œåšäº‹å¿…å®šè¦è²«å¾¹åˆ°åº•ã€‚(æœï¼šå …å®šä¸ç§»)ã€‚", type: "term" },
                { id: 31, question: "å‹å›ºæ¬£ç„¶ï¼Œæ•—äº¦å¯å–œ", zhuyin: "ã„•ã„¥Ë‹ ã„ã„¨Ë‹ ã„’ã„§ã„£ ã„–ã„¢ËŠ ï¼Œ ã„…ã„Ë‹ ã„§Ë‹ ã„ã„œË‡ ã„’ã„§Ë‡", answer: "å‹äº†å›ºç„¶é«˜èˆˆï¼Œæ•—äº†ä¹Ÿå€¼å¾—æ¬£å–œã€‚", type: "term" },
                { id: 32, question: "å®£èª“", zhuyin: "ã„’ã„©ã„¢ ã„•Ë‹", answer: "æŸäº›æˆå“¡ç‚ºå¿ å¯¦å±¥è¡Œè·å‹™ï¼Œå…¬é–‹è²æ˜åš´å®ˆæˆ’ç´„çš„èª“è¨€ã€‚", type: "term" },
                { id: 33, question: "å‰æ", zhuyin: "ã„‘ã„§ã„¢ËŠ ã„Šã„§ËŠ", answer: "æ‡‰è©²å…ˆæ³¨æ„çš„éƒ¨åˆ†ã€‚", type: "term" },
                { id: 34, question: "è¶…è¶Šå‹æ•—", zhuyin: "ã„”ã„  ã„©ã„Ë‹ ã„•ã„¥Ë‹ ã„…ã„Ë‹", answer: "ä¸è¨ˆè¼ƒæˆåŠŸæˆ–å¤±æ•—ã€‚", type: "term" },
                { id: 35, question: "å‰µç´€éŒ„", zhuyin: "ã„”ã„¨ã„¤Ë‹ ã„ã„§Ë‹ ã„Œã„¨Ë‹", answer: "æ‰“ç ´ä»¥å¾€çš„æˆç¸¾æˆ–äº‹ä¾‹ã€‚", type: "term" },
                { id: 36, question: "ç„¡èŠ", zhuyin: "ã„¨ËŠ ã„Œã„§ã„ ËŠ", answer: "å½¢å®¹æ²’æœ‰æ„ç¾©çš„èªè¨€èˆ‰æ­¢ã€‚", type: "term" },
                { id: 37, question: "èŠåš´å…¬æ­£", zhuyin: "ã„“ã„¨ã„¤ ã„§ã„¢ËŠ ã„ã„¨ã„¥ ã„“ã„¥Ë‹", answer: "èŠé‡åš´è‚…ï¼Œå…¬å¹³ç„¡ç§ã€‚", type: "term" },
                { id: 38, question: "ç”Ÿå‘½åŠ›", zhuyin: "ã„•ã„¥ ã„‡ã„§ã„¥Ë‹ ã„Œã„§Ë‹", answer: "ç¶­æŒç”Ÿå‘½æ´»å‹•æˆ–ç™¼å±•çš„èƒ½åŠ›ã€‚", type: "term" },
                { id: 39, question: "å¿ƒéˆ", zhuyin: "ã„’ã„§ã„£ ã„Œã„§ã„¥ËŠ", answer: "äººå¿ƒä¸­æœ¬æœ‰çš„æ™ºæ…§ã€æ€æƒ³å’Œæƒ…æ„Ÿç­‰ã€‚", type: "term" },
                { id: 40, question: "ç—…æ…‹", zhuyin: "ã„…ã„§ã„¥Ë‹ ã„Šã„Ë‹", answer: "å¿ƒç†ä¸Šä¸æ­£å¸¸çš„ç‹€æ…‹ã€‚", type: "term" },
                { id: 41, question: "æ°‘æ—æ€§", zhuyin: "ã„‡ã„§ã„£ËŠ ã„—ã„¨ËŠ ã„’ã„§ã„¥Ë‹", answer: "ä¸€æ°‘æ—æ‰€å…±æœ‰çš„ç‰¹æ€§ã€‚", type: "term" },
                { id: 42, question: "è¨€ç°¡æ„è³…", zhuyin: "ã„§ã„¢ËŠ ã„ã„§ã„¢Ë‡ ã„§Ë‹ ã„ã„", answer: "è¨€è¾­ç°¡ç·´ï¼Œæ„æ€å®Œå‚™ã€‚", type: "term" },
                { id: 43, question: "è‡˜æœˆ", zhuyin: "ã„Œã„šË‹ ã„©ã„Ë‹", answer: "è¾²æ›†åäºŒæœˆã€‚", type: "term" },
                { id: 44, question: "ä»¥å‡é‡çŸ³", zhuyin: "ã„§Ë‡ ã„•ã„¥ ã„Œã„§ã„¤ËŠ ã„‰ã„¢Ë‹", answer: "æŒ‡ç”¨å°çš„å®¹å™¨æ¸¬é‡å¤§çš„å®¹é‡ã€‚æ¯”å–»ä»¥æ·ºé™‹çš„æ€æƒ³æ£åº¦é«˜æ·±çš„é“ç†ã€‚", type: "term" },
                { id: 45, question: "æ·±å±…ç°¡å‡º", zhuyin: "ã„•ã„£ ã„ã„© ã„ã„§ã„¢Ë‡ ã„”ã„¨", answer: "æŒ‡å±…æ–¼æ·±å¯†çš„åœ°æ–¹ï¼Œå¾ˆå°‘å¤–å‡ºã€‚", type: "term" },
                { id: 46, question: "ä¿¡èª“æ—¦æ—¦", zhuyin: "ã„’ã„§ã„£Ë‹ ã„•Ë‹ ã„‰ã„¢Ë‹ ã„‰ã„¢Ë‹", answer: "èª“è¨€èªªå¾—éå¸¸èª æ‡‡å¯é ã€‚", type: "term" },
                { id: 47, question: "ç§‹æ¯«ç„¡çŠ¯", zhuyin: "ã„‘ã„§ã„¡ ã„ã„ ËŠ ã„¨ËŠ ã„ˆã„¢Ë‹", answer: "ä¸€é»éƒ½ä¸ä¾µçŠ¯ã€‚", type: "term" },
                { id: 48, question: "æœ‰ç‚ºæœ‰å®ˆ", zhuyin: "ã„§ã„¡Ë‡ ã„¨ã„ŸËŠ ã„§ã„¡Ë‡ ã„•ã„¡Ë‡", answer: "æ—¢æœ‰ä½œç‚ºï¼Œåˆæœ‰ç¯€æ“ã€‚å½¢å®¹äººçš„å®Œç¾ã€‚", type: "term" },
                { id: 49, question: "åŒèˆŸå…±æ¿Ÿ", zhuyin: "ã„Šã„¨ã„¥ËŠ ã„“ã„¡ ã„ã„¨ã„¥Ë‹ ã„ã„§Ë‹", answer: "æ¯”å–»åŒå¿ƒå”åŠ›ï¼Œæˆ°å‹å›°é›£ã€‚", type: "term" },
                { id: 50, question: "èƒ½å±ˆèƒ½ä¼¸", zhuyin: "ã„‹ã„¥ËŠ ã„‘ã„© ã„‹ã„¥ËŠ ã„•ã„£", answer: "å¤±æ„æ™‚èƒ½å…‹åˆ¶å¿è€ï¼Œå¾—æ„æ™‚èƒ½æ–½å±•æŠ±è² ã€‚", type: "term" },
                { id: 51, question: "å¶”å´ç£Šè½", zhuyin: "ã„‘ã„§ã„£ ã„‘ã„§ËŠ ã„Œã„ŸË‡ ã„Œã„¨ã„›Ë‹", answer: "æ¯”å–»äººå“é«˜æ½”ï¼Œæœ‰éª¨æ°£ã€‚", type: "term" },
                { id: 52, question: "èŒ¹è‹¦å«è¾›", zhuyin: "ã„–ã„¨ËŠ ã„ã„¨Ë‡ ã„ã„¢ËŠ ã„’ã„§ã„£", answer: "å½¢å®¹å—ç›¡ç¨®ç¨®è¾›è‹¦ã€‚", type: "term" },
                { id: 53, question: "æ²½åé‡£è­½", zhuyin: "ã„ã„¨ ã„‡ã„§ã„¥ËŠ ã„‰ã„§ã„ Ë‹ ã„©Ë‹", answer: "æ•…æ„åšä½œï¼Œç”¨æ‰‹æ®µè¬€å–åè²å’Œè®šè­½ã€‚", type: "term" },
                { id: 54, question: "éš¨æ³¢é€æµ", zhuyin: "ã„™ã„¨ã„ŸËŠ ã„…ã„› ã„“ã„¨ËŠ ã„Œã„§ã„¡ËŠ", answer: "æ¯”å–»äººæ²’æœ‰ç¢ºå®šçš„æ–¹å‘å’Œç›®æ¨™ï¼Œåªä¾å¾ç’°å¢ƒã€æ½®æµè€Œè¡Œå‹•ã€‚", type: "term" },
                { id: 55, question: "è¡Œç™¾é‡Œè€…åŠä¹å", zhuyin: "ã„’ã„§ã„¥ËŠ ã„…ã„Ë‡ ã„Œã„§Ë‡ ã„“ã„œË‡ ã„…ã„¢Ë‹ ã„ã„§ã„¡Ë‡ ã„•ËŠ", answer: "è¡Œç™¾é‡Œè·¯çš„äººï¼Œèµ°äº†ä¹åé‡Œï¼Œåªç®—èµ°äº†ä¸€åŠã€‚æ¯”å–»æœ€å¾Œçš„éšæ®µæœ€è‰±é›£ã€‚", type: "term" },
                { id: 56, question: "æœ¨ç„¶", zhuyin: "ã„‡ã„¨Ë‹ ã„–ã„¢ËŠ", answer: "å½¢å®¹ä¸€æ™‚ç—´å‘†ï¼Œä¸çŸ¥æ‰€æªçš„æ¨£å­ã€‚", type: "term" },
                { id: 57, question: "æ­¸å’", zhuyin: "ã„ã„¨ã„Ÿ ã„ã„§ã„¡Ë‹", answer: "æŠŠç½ªæƒ¡æˆ–éŒ¯èª¤æ¨åˆ°æŸäººæˆ–æŸäº‹ä¸Šã€‚", type: "term" },
                { id: 58, question: "æ–¹åœ“", zhuyin: "ã„ˆã„¤ ã„©ã„¢ËŠ", answer: "æŒ‡å‘¨åœã€é™„è¿‘ã€‚", type: "term" },
                { id: 59, question: "è¦çŸ©", zhuyin: "ã„ã„¨ã„Ÿ ã„ã„©Ë‡", answer: "æœ¬æŒ‡ç•«åœ“ç•«æ–¹çš„å·¥å…·ï¼Œå¾Œæ¯”å–»ç‚ºæ³•åº¦ã€ç¦®æ³•ã€‚", type: "term" },
                { id: 60, question: "çŸ›ç›¾", zhuyin: "ã„‡ã„ ËŠ ã„‰ã„¨ã„£Ë‹", answer: "æ¯”å–»è¨€èªè¡Œç‚ºè‡ªç›¸æŠµè§¸ã€‚", type: "term" },
                { id: 61, question: "æ·é–", zhuyin: "ã„ã„§ã„š ã„™ã„¨ã„›Ë‡", answer: "å¤ä»£åˆ‘å…·ï¼Œå¾Œç”¨ä¾†æ¯”å–»æŸç¸›ã€å£“è¿«ã€‚", type: "term" },
                { id: 62, question: "åŠŸè™§ä¸€ç°£", zhuyin: "ã„ã„¨ã„¥ ã„ã„¨ã„Ÿ ã„§ ã„ã„¨ã„ŸË‹", answer: "æ¯”å–»äº‹æƒ…ä¸èƒ½å …æŒåˆ°åº•ï¼Œåªå·®æœ€å¾Œçš„æ­¥é©Ÿè€ŒåŠŸæ•—å‚æˆã€‚", type: "term" },
                { id: 63, question: "é¥è€Œä¸æ¨", zhuyin: "ã„‘ã„§ã„Ë‹ ã„¦ËŠ ã„…ã„¨Ë‹ ã„•ã„œË‡", answer: "æ¯”å–»å …æŒåˆ°åº•ï¼Œå¥®å‹‰ä¸æ‡ˆã€‚", type: "term" },
                { id: 64, question: "ä¼‘ä¼‘æœ‰å®¹", zhuyin: "ã„’ã„§ã„¡ ã„’ã„§ã„¡ ã„§ã„¡Ë‡ ã„–ã„¨ã„¥ËŠ", answer: "å½¢å®¹å›å­å¯¬å®å¤§é‡ã€‚(é©åˆå½¢å®¹å›å­ç„¡æ‰€çˆ­)ã€‚", type: "term" },
                { id: 65, question: "è‡ªçŸœè‡ªæƒ", zhuyin: "ã„—Ë‹ ã„ã„§ã„£ ã„—Ë‹ ã„•Ë‹", answer: "è‡ªä»¥ç‚ºæ˜¯ï¼Œå€šä»—è‡ªå·±çš„å‹¢åŠ›ã€‚", type: "term" },
                
                // --- é‡è¦æ–‡å¥éƒ¨åˆ† ---
                { id: 66, question: "å¥å…¨çš„å¿ƒéˆï¼Œå¯“æ–¼å¥å…¨çš„èº«é«”", answer: "èªªæ˜å¥åº·çš„èº«é«”æ˜¯å¥å…¨å¿ƒéˆçš„åŸºç¤ï¼ŒäºŒè€…é—œä¿‚å¯†åˆ‡ï¼Œäº’ç‚ºè¡¨è£¡ã€‚ï¼ˆå¼•ç”¨ (å¸Œè‡˜è«ºèª)ï¼‰", type: "sentence" },
                { id: 67, question: "é‹å‹•çš„ç²¾ç¾©ï¼Œé‚„ä¸åªæ­¤ã€‚å®ƒæ›´æœ‰é“å¾·çš„æ„ç¾©", answer: "å°‡é‹å‹•å¾ã€Œé«”è‚²ã€çš„ç¯„ç–‡æå‡è‡³ã€Œå“æ ¼æ•™è‚²ã€çš„å±¤æ¬¡ã€‚èªªæ˜åŸ¹è‚²å„ªè‰¯å“æ ¼æ¯”å‹æ•—æ›´é‡è¦ã€‚ï¼ˆè½‰æŠ˜ (æ‰¿ä¸Šå•Ÿä¸‹)ï¼‰", type: "sentence" },
                { id: 68, question: "å›å­ç„¡æ‰€çˆ­ï¼Œå¿…ä¹Ÿå°„ä¹ã€‚æ–è®“è€Œå‡ï¼Œä¸‹è€Œé£²ï¼Œå…¶çˆ­ä¹Ÿå›å­", answer: "é€™æ˜¯è¡Œç‚ºåˆå®œã€é€²é€€å®ˆç¦®çš„ã€Œå›å­ä¹‹çˆ­ã€ã€‚å¼·èª¿éµå®ˆè¦å‰‡ï¼Œä½œå…¬å¹³ã€å…‰æ˜è€Œæœ‰ç¦®çš„ç«¶çˆ­ã€‚ï¼ˆå¼•ç”¨ (è«–èª)ã€å›å­ä¹‹çˆ­ã€è¬™è®“ä¿®é¤Šï¼‰", type: "sentence" },
                { id: 69, question: "é‹å‹•æ˜¯è¦å®ˆè‘—ä¸€å®šçš„è¦å¾‹ï¼Œåœ¨è¬ç›®ç½ç½çš„ç›£è¦–ä¹‹ä¸‹ï¼Œå¾å…¬é–‹ç«¶çˆ­è€Œæ±‚å¾—å‹åˆ©çš„",  answer: "èªªæ˜é‹å‹•å®¶æ‡‰å…‰æ˜æ­£å¤§ï¼Œä¸å¯æŠ•æ©Ÿå–å·§ã€‚ï¼ˆå›å­ä¹‹çˆ­ï¼‰", type: "sentence" },
                { id: 70, question: "å›å­ä¸æ€¨å¤©ï¼Œä¸å°¤äºº", answer: "é€™æ˜¯ã€Œæœè¼¸çš„ç²¾ç¥ã€ï¼Œä¹Ÿæ˜¯ã€Œåæ±‚è«¸å·±ã€ã€ã€Œåèº¬è‡ªçœã€çš„æ…‹åº¦ã€‚è¼¸äº†åªæ€ªè‡ªå·±ä¸è¡Œï¼Œä¸æ€ªé‹æ°£æˆ–åˆ¥äººã€‚ï¼ˆå¼•ç”¨ (è«–èª)ã€æœè¼¸çš„ç²¾ç¥ã€åæ±‚è«¸å·±ï¼‰", type: "sentence" },
                { id: 71, question: "æˆ‘è¼¸äº†åªæ€ªæˆ‘è‡ªå·±ä¸è¡Œ......äººå®¶å‹äº†ï¼Œæ˜¯ä»–æœ¬äº‹å¥½ï¼Œæˆ‘åªæœ‰ä½©æœä»–", answer: "ã€Œæœè¼¸ã€å°±æ˜¯ã€Œæœå–„ã€ï¼Œä»£è¡¨èƒ½ã€Œæ¬£è³ä»–äººã€ä¸”çŸ¥ã€Œè‡ªæˆ‘åçœã€çš„ç¾å¾·ã€‚ï¼ˆæœè¼¸çš„ç²¾ç¥ï¼‰", type: "sentence" },
                { id: 72, question: "ç½µä»–ä¸ä½†æ˜¯ç„¡èŠï¼Œè€Œä¸”æ˜¯ç„¡æ¥", answer: "å¼·èª¿è¼¸ä¸èµ·ã€è¾±ç½µå°æ‰‹æ˜¯ç¼ºä¹é¢¨åº¦çš„è¡¨ç¾ã€‚ï¼ˆåé¢è«–è¿°ï¼‰", type: "sentence" },
                { id: 73, question: "ç¾…æ–¯ç¦æ”¶åˆ°ç¬¬ä¸€å€‹è³€é›»ï¼Œå°±æ˜¯å¨çˆ¾åŸºç™¼çš„", answer: "è¡¨ç¾å‡ºã€Œæœè¼¸çš„ç²¾ç¥ã€èˆ‡ã€Œè¶…è¶Šå‹æ•—çš„å¿ƒèƒ¸ã€ã€‚è´è€…æœ‰é¢¨åº¦ï¼Œè¼¸è€…æœ‰æ°£åº¦ã€‚ï¼ˆäº‹ä¾‹ã€æœè¼¸çš„ç²¾ç¥ï¼‰", type: "sentence" },
                { id: 74, question: "å¨çˆ¾åŸºå¤±æ•—ä»¥å¾Œï¼Œé‚„å¹«åŠ©ç¾…æ–¯ç¦ä½œç¨®ç¨®å¤–äº¤æ´»å‹•ï¼Œä¸€åˆ‡ä»¥åœ‹å®¶ç‚ºå‰æ", answer: "é™¤äº†æœè¼¸ç²¾ç¥å¤–ï¼Œæ›´å±•ç¾äº†ã€Œå…¬è€Œå¿˜ç§ã€çš„èƒ¸è¥Ÿã€‚ï¼ˆå…¬è€Œå¿˜ç§ã€æœè¼¸çš„ç²¾ç¥ï¼‰", type: "sentence" },
                { id: 75, question: "å‹åˆ©è€…å’Œå¤±æ•—è€…éš”ç¶²æ¡æ‰‹", answer: "ä»£è¡¨å‹åˆ©è€…æœ‰å›å­é¢¨åº¦ï¼Œå¤±æ•—è€…æœ‰æœè¼¸çš„ç²¾ç¥ã€‚(å‹‡æ–¼æœè¼¸ã€å°Šæ•¬å°æ‰‹)ã€‚ï¼ˆæœè¼¸çš„ç²¾ç¥ï¼‰", type: "sentence" },
                { id: 76, question: "å‹å›ºæ¬£ç„¶ï¼Œæ•—äº¦å¯å–œ", answer: "é€™æ˜¯ã€Œè¶…è¶Šå‹æ•—çš„å¿ƒèƒ¸ã€ã€‚é¢å°æ¯”è³½å…‰æ˜ç£Šè½ï¼Œç„¡è«–å‹æ•—éƒ½æ˜¯ä¸€ç¨®æ”¶ç©«ï¼Œèƒ½é”åˆ°ã€Œå¾—å¤±ç„¡å‹•æ–¼è¡·ã€çš„å¢ƒåœ°ã€‚ï¼ˆå¼•ç”¨ (è˜‡è»¾)ã€è¶…è¶Šå‹æ•—ã€æ˜ è¥¯ï¼‰", type: "sentence" },
                { id: 77, question: "è¨€å¿…ä¿¡ï¼Œè¡Œå¿…æœ", zhuyin: "ã„§ã„¢ËŠ ã„…ã„§Ë‹ ã„’ã„§ã„£Ë‹ ï¼Œ ã„’ã„§ã„¥ËŠ ã„…ã„§Ë‹ ã„ã„¨ã„›Ë‡", answer: "èªªæ˜é‹å‹•å®¶è¦æœ‰ã€Œè²«å¾¹å§‹çµ‚ã€çš„ç²¾ç¥ã€‚çµ•ä¸è‡¨é™£è„«é€ƒï¼Œä¸åŠé€”è€Œå»¢ã€‚ï¼ˆå¼•ç”¨ (è«–èª)ã€è²«å¾¹å§‹çµ‚ï¼‰", type: "sentence" },
                { id: 78, question: "é‹å‹•æœƒè¦èˆ‰è¡Œå®£èª“", answer: "è¡¨ç¾ã€Œè²«å¾¹å§‹çµ‚ã€èˆ‡ã€Œè¨€å¿…ä¿¡ï¼Œè¡Œå¿…æœã€çš„ç²¾ç¥ã€‚ï¼ˆè²«å¾¹å§‹çµ‚ï¼‰", type: "sentence" },
                { id: 79, question: "è³½è·‘è½å¾Œï¼Œç„¡å¸Œæœ›å¾—çï¼Œé‚„è¦åŠªåŠ›è·‘åˆ°çš„äºº", answer: "è¡¨ç¾ã€Œè²«å¾¹å§‹çµ‚ã€çš„æ¯…åŠ›èˆ‡ã€Œä»»é‡é“é ã€çš„ç²¾ç¥ã€‚ï¼ˆè²«å¾¹å§‹çµ‚ã€æœ‰æ¯…åŠ›ï¼‰", type: "sentence" },
                { id: 80, question: "æœ‰é‹å‹•å®¶é¢¨åº¦çš„äººï¼Œå¯§å¯æœ‰å…‰æ˜çš„å¤±æ•—ï¼Œçµ•ä¸è¦ä¸æ¦®è­½çš„æˆåŠŸï¼", answer: "é€™æ˜¯å›å­é¢¨åº¦çš„è¡¨ç¾ï¼Œè´å¾—çš„æ˜¯ã€Œäººæ ¼ä¸Šçš„éŒ¦æ¨™ã€ã€‚å¼·èª¿æ‰‹æ®µçš„å…‰æ˜æ­£å¤§æ¯”çµæœçš„å‹è² æ›´é‡è¦ã€‚ï¼ˆæ˜ è¥¯ã€çµè«–ï¼‰", type: "sentence" },
                { id: 81, question: "é‹å‹•å®¶çš„é¢¨åº¦è¡¨ç¾åœ¨äººç”Ÿä¸Šï¼Œæ˜¯ä¸€å€‹èŠåš´å…¬æ­£ã€å”èª¿é€²å–çš„äººç”Ÿ", answer: "ç¸½çµå…¨æ–‡ï¼Œå°‡é‹å‹•ç²¾ç¥æ¨å»£è‡³äººç”Ÿæ…‹åº¦ã€‚ï¼ˆç¸½çµï¼‰", type: "sentence" },
                { id: 82, question: "ä»»é‡è€Œé“é ", answer: "èªªæ˜é‹å‹•å®¶æ‡‰æœ‰é•·æœŸå¥®é¬¥ã€è² é‡è‡´é çš„ç²¾ç¥ã€‚ï¼ˆå¼•ç”¨ (è«–èª)ï¼‰", type: "sentence" },
                { id: 83, question: "é™¶é‘„å„ªè‰¯çš„æ°‘æ—æ€§", answer: "é‹å‹•çš„é“å¾·æ„ç¾©ä¹‹æœ€é«˜å±¤æ¬¡ï¼ˆå€‹äººâ†’æ”¿æ²»â†’æ°‘æ—ï¼‰ã€‚ï¼ˆå±¤é (æ¦‚å¿µä¸Š)ï¼‰", type: "sentence" },
                { id: 84, question: "çœŸæ­£çš„è€ƒé©—ï¼Œä¸¦ä¸æ˜¯ç¬¬ä¸€é‡Œè·¯ï¼Œè€Œæ˜¯æ—…ç¨‹æœ€å¾Œä¸€é‡Œè·¯", answer: "å¼·èª¿å …æŒåˆ°åº•çš„é‡è¦æ€§ã€‚ï¼ˆè¡Œç™¾é‡Œè€…åŠä¹åï¼‰", type: "sentence" },
                { id: 85, question: "å›å­æ¬²è¨¥æ–¼è¨€ï¼Œè€Œæ•æ–¼è¡Œ", answer: "å›å­è©±èªªå¾—ä¸å¤šï¼Œè€Œæ•æ·å‹¤å¥®åœ°è¿½æ±‚æ–¼åŠ›è¡Œçš„åŠŸå¤«ã€‚ï¼ˆå¯¡è¨€åŠ›è¡Œï¼‰", type: "sentence" },
                { id: 86, question: "æŠŠæŒè²ç•™çµ¦è‡ªå·±......ä½ çš„æœ‹å‹æœƒå°‘ä¸€å€‹",  answer: "é¼“å‹µäººè¦æ‡‚å¾—åˆ†äº«èˆ‡è®šç¾ï¼Œè®šç¾å°å‹èª¼æœ‰æ­£é¢æ„ç¾©ã€‚ï¼ˆåˆ†äº«æ¦®è€€ï¼‰", type: "sentence" },
                { id: 87, question: "ç„¡çŸ¥çš„ç‹‚ç†±ä¹ƒæ˜¯ä¸€åŒ¹è„«éŸä¹‹é¦¬", answer: "åªæœ‰ç†±æƒ…è€Œæ²’æœ‰æ™ºæ…§æˆ–æ–¹å‘ï¼Œå¾€å¾€æœƒæˆäº‹ä¸è¶³ï¼Œæ•—äº‹æœ‰é¤˜ã€‚ï¼ˆæˆäº‹ä¸è¶³ï¼Œæ•—äº‹æœ‰é¤˜ï¼‰", type: "sentence" },
                { id: 88, question: "ä¸èƒ½ä½é ­çš„äººï¼Œæ˜¯å› ç‚ºä¸€å†å›é¡§éå»çš„æˆå°±", answer: "èªªæ˜è€½æººæ–¼æ˜”æ—¥è¼ç…Œçš„äººï¼Œå¾€å¾€å®¹æ˜“è‡ªèª‡è‡ªå¤§(è‡ªçŸœè‡ªæƒ)ã€‚ï¼ˆè‡ªçŸœè‡ªæƒï¼‰", type: "sentence" },
                { id: 89, question: "æˆ‘æ²’è¾¦æ³•æ±ºå®šæˆ‘çš„æˆç¸¾å¦‚ä½•ï¼Œä½†æˆ‘å¯ä»¥æ±ºå®šæˆ‘åœ¨æ¯”è³½ä¸­çš„æ¨£å­", answer: "(ææ´‹åè¨€) å±•ç¾ã€Œèˆ‡å…¶è¿½æ±‚å‹åˆ©ï¼Œä¸å¦‚å…¨åŠ›ä»¥èµ´ï¼Œäº«å—æ¯”è³½ã€çš„ç²¾ç¥ã€‚ï¼ˆè¶…è¶Šå‹æ•—ã€äº«å—æ¯”è³½ï¼‰", type: "sentence" }
            ];

            const shuffleArray = (array) => {
              const newArray = [...array];
              for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
              }
              return newArray;
            };

            const playSound = (type) => {
                const audioPath = type === 'success' ? 'sounds/correct.mp3' : 'sounds/fail.mp3';
                const audio = new Audio(audioPath);
                audio.play().catch(err => console.log('Audio play error (expected if files missing):', err));
            }

            const App = () => {
              const [mode, setMode] = useState('menu'); // menu, study, quiz, favorites, mistakes
              const [currentUser, setCurrentUser] = useState(null);
              const [users, setUsers] = useState([]);
              const [favorites, setFavorites] = useState(new Set());
              const [mistakes, setMistakes] = useState(new Set());
              const [isFirebaseConfigured, setIsFirebaseConfigured] = useState(false);
              const [isLoading, setIsLoading] = useState(false); // Global Loading State
              const [connectionStatus, setConnectionStatus] = useState('offline'); // loading, success, error, offline

              // Function to update connection status externally
              const updateConnectionStatus = (status) => {
                setConnectionStatus(status);
              };

              // Check Firebase Config
              useEffect(() => {
                  setIsFirebaseConfigured(isFirebaseReady);
                  if (isFirebaseReady) {
                      setConnectionStatus('loading');
                      // åˆå§‹åŒ–åŒ¿åç™»å…¥ï¼Œç¢ºä¿æœ‰æ¬Šé™è®€å¯«è³‡æ–™
                      const loginAnon = async () => {
                          try {
                              await signInAnonymously(auth);
                              console.log("Firebase Anonymous Auth Success");
                              fetchUsersList();
                          } catch (err) {
                              console.error("Auth Error", err);
                              setConnectionStatus('error');
                          }
                      };
                      loginAnon();
                  } else {
                      // Fallback: load from local if firebase not ready (for demo only)
                      const storedUsers = JSON.parse(localStorage.getItem(`${COLLECTION_NAME}_users`)) || [];
                      setUsers(storedUsers);
                      setConnectionStatus('offline');
                  }
              }, []);

              // Fetch Global User List from Firestore
              const fetchUsersList = async () => {
                  if (!db) return;
                  updateConnectionStatus('loading');
                  try {
                      const docRef = doc(db, COLLECTION_NAME, DOC_GLOBAL);
                      const docSnap = await getDoc(docRef);
                      if (docSnap.exists()) {
                          setUsers(docSnap.data().users || []);
                      } else {
                          // First time setup: create the document
                          await setDoc(docRef, { users: [] });
                          setUsers([]);
                      }
                      updateConnectionStatus('success');
                  } catch (e) {
                      console.error("Error fetching users list:", e);
                      updateConnectionStatus('error');
                  }
              };

              // Load user data when currentUser changes (Firestore)
              useEffect(() => {
                if (currentUser && db) {
                    setIsLoading(true);
                    updateConnectionStatus('loading');
                    const userDocRef = doc(db, COLLECTION_NAME, `user_${currentUser}`);
                    
                    // Real-time listener for user data
                    const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            setFavorites(new Set(data.favorites || []));
                            setMistakes(new Set(data.mistakes || []));
                        } else {
                            setFavorites(new Set());
                            setMistakes(new Set());
                        }
                        setIsLoading(false);
                        updateConnectionStatus('success');
                    }, (error) => {
                        console.error("Error listening to user data:", error);
                        setIsLoading(false);
                        updateConnectionStatus('error');
                    });

                    return () => unsubscribe();
                } else if (!currentUser) {
                    setFavorites(new Set());
                    setMistakes(new Set());
                }
              }, [currentUser]);

              const handleLogin = async (name) => {
                if (!name.trim()) return;
                
                setIsLoading(true);
                updateConnectionStatus('loading');
                
                if (isFirebaseReady) {
                    try {
                        // Update Global User List if new
                        if (!users.includes(name)) {
                            const globalRef = doc(db, COLLECTION_NAME, DOC_GLOBAL);
                            await updateDoc(globalRef, {
                                users: arrayUnion(name)
                            });
                            setUsers(prev => [...prev, name]);
                        }
                        updateConnectionStatus('success');
                    } catch (e) {
                        console.error("Error updating user list:", e);
                        alert("é€£ç·šéŒ¯èª¤ï¼Œç„¡æ³•å»ºç«‹ä½¿ç”¨è€…ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase è¨­å®š");
                        setIsLoading(false);
                        updateConnectionStatus('error');
                        return;
                    }
                } else {
                    // LocalStorage Fallback
                    const newUsers = Array.from(new Set([name, ...users]));
                    setUsers(newUsers);
                    localStorage.setItem(`${COLLECTION_NAME}_users`, JSON.stringify(newUsers));
                }

                setCurrentUser(name);
                setMode('menu'); // Ensure we are on menu after login
                setIsLoading(false);
              };

              const handleDeleteUser = async (name) => {
                if (!window.confirm(`ç¢ºå®šè¦åˆªé™¤ä½¿ç”¨è€… "${name}" å—ï¼Ÿ\næ³¨æ„ï¼šæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼Œæ‰€æœ‰å­¸ç¿’ç´€éŒ„å°‡è¢«æ°¸ä¹…åˆªé™¤ã€‚`)) return;
                if (!window.confirm(`å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦æ°¸ä¹…åˆªé™¤ "${name}" çš„æ‰€æœ‰è³‡æ–™å—ï¼Ÿ`)) return;

                setIsLoading(true);
                updateConnectionStatus('loading');

                try {
                    if (isFirebaseReady) {
                        const globalRef = doc(db, COLLECTION_NAME, DOC_GLOBAL);
                        await updateDoc(globalRef, {
                            users: arrayRemove(name)
                        });

                        const userRef = doc(db, COLLECTION_NAME, `user_${name}`);
                        await deleteDoc(userRef);
                    } else {
                        localStorage.removeItem(`${COLLECTION_NAME}_progress_${name}`);
                    }

                    const newUsers = users.filter(u => u !== name);
                    setUsers(newUsers);
                    
                    if (!isFirebaseReady) {
                          localStorage.setItem(`${COLLECTION_NAME}_users`, JSON.stringify(newUsers));
                    }

                    updateConnectionStatus('success');
                } catch (e) {
                    console.error("Error deleting user:", e);
                    alert("åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
                    updateConnectionStatus('error');
                } finally {
                    setIsLoading(false);
                }
              };

              const handleLogout = () => {
                setCurrentUser(null);
                setMode('menu');
              };

              const toggleFavorite = useCallback(async (id) => {
                if (!currentUser) return;
                
                const newFavorites = new Set(favorites);
                if (newFavorites.has(id)) {
                    newFavorites.delete(id);
                } else {
                    newFavorites.add(id);
                }
                setFavorites(newFavorites); 

                if (isFirebaseReady) {
                    updateConnectionStatus('loading');
                    try {
                        const userRef = doc(db, COLLECTION_NAME, `user_${currentUser}`);
                        await setDoc(userRef, { favorites: [...newFavorites] }, { merge: true });
                        updateConnectionStatus('success');
                    } catch (e) {
                        console.error("Error saving favorites:", e);
                        updateConnectionStatus('error');
                    }
                }
              }, [favorites, currentUser]);

              const addMistake = useCallback(async (id) => {
                if (!currentUser) return;
                
                const newMistakes = new Set(mistakes);
                if (!newMistakes.has(id)) {
                    newMistakes.add(id);
                    setMistakes(newMistakes); 

                    if (isFirebaseReady) {
                        updateConnectionStatus('loading');
                        try {
                            const userRef = doc(db, COLLECTION_NAME, `user_${currentUser}`);
                            await setDoc(userRef, { mistakes: [...newMistakes] }, { merge: true });
                            updateConnectionStatus('success');
                        } catch (e) {
                            console.error("Error saving mistakes:", e);
                            updateConnectionStatus('error');
                        }
                    }
                }
              }, [mistakes, currentUser]);

              if (!currentUser) {
                return (
                    <LoginView 
                        users={users} 
                        onLogin={handleLogin} 
                        onDeleteUser={handleDeleteUser}
                        isConfigured={isFirebaseConfigured} 
                        isLoading={isLoading}
                        connectionStatus={connectionStatus}
                    />
                );
              }
              
              return (
                <div className="min-h-screen bg-orange-50 text-stone-800 font-sans">
                  {/* Header */}
                  <header className="bg-orange-600 text-white p-4 shadow-lg sticky top-0 z-20">
                    <div className="max-w-4xl mx-auto flex justify-between items-center">
                      <div 
                        className="flex items-center space-x-2 cursor-pointer"
                        onClick={() => setMode('menu')}
                      >
                        <BookOpen size={28} />
                        <h1 className="text-xl md:text-2xl font-bold tracking-wider">ç¬¬4å†Š L1 é‹å‹•å®¶çš„é¢¨åº¦</h1>
                      </div>
                      
                      <div className="flex items-center space-x-4">
                        
                        <div className="flex items-center bg-orange-700/50 px-3 py-1 rounded-full text-xs md:text-sm border border-orange-500/30">
                            {connectionStatus === 'loading' && (
                                <>
                                    <span className="status-dot status-loading"></span>
                                    <span className="text-orange-100">è®€å–è³‡æ–™ä¸­...</span>
                                </>
                            )}
                            {connectionStatus === 'success' && (
                                <>
                                    <span className="status-dot status-success"></span>
                                    <span className="text-green-100">å·²åŒæ­¥</span>
                                </>
                            )}
                            {connectionStatus === 'error' && (
                                <>
                                    <span className="status-dot status-error"></span>
                                    <span className="text-red-100">é›²ç«¯åŒæ­¥å¤±æ•—</span>
                                </>
                            )}
                            {connectionStatus === 'offline' && (
                                <>
                                    <span className="status-dot status-offline"></span>
                                    <span className="text-stone-300">æœ¬æ©Ÿæ¨¡å¼</span>
                                </>
                            )}
                        </div>

                        <div className="hidden md:flex items-center bg-orange-700 px-3 py-1 rounded-full text-sm">
                            <User size={16} className="mr-2"/>
                            <span className="font-bold truncate max-w-[100px]">{currentUser}</span>
                        </div>
                        {mode !== 'menu' && (
                            <button 
                            onClick={() => setMode('menu')}
                            className="text-orange-100 hover:text-white transition font-medium"
                            >
                            å›é¦–é 
                            </button>
                        )}
                        <button 
                            onClick={handleLogout}
                            className="flex items-center text-orange-200 hover:text-white transition"
                            title="ç™»å‡º"
                        >
                            <LogOut size={20} />
                        </button>
                      </div>
                    </div>
                  </header>

                  {/* Main Content */}
                  <main className="max-w-4xl mx-auto p-4 md:p-6">
                    {mode === 'menu' && (
                      <div className="flex flex-col items-center justify-center space-y-8 py-12 animate-in fade-in duration-500">
                        <div className="text-center space-y-4">
                          <div className="bg-orange-100 p-4 rounded-full inline-block mb-2">
                            <Brain size={48} className="text-orange-600" />
                          </div>
                          <h2 className="text-3xl font-bold text-orange-900">æ­¡è¿å›ä¾†ï¼Œ{currentUser}</h2>
                          <div className="flex justify-center items-center space-x-2 text-stone-500">
                              {isFirebaseReady ? 
                                <span className="flex items-center text-green-600 text-sm"><Cloud size={16} className="mr-1"/> é›²ç«¯åŒæ­¥ä¸­</span> : 
                                <span className="flex items-center text-stone-400 text-sm"><CloudOff size={16} className="mr-1"/> æœ¬æ©Ÿæ¨¡å¼</span>
                              }
                          </div>
                          <p className="text-stone-600 text-lg max-w-md">
                            ç²¾æº–æŒæ¡è©èªæ³¨é‡‹èˆ‡æ–‡å¥æ„æ—¨<br/>
                            å…±æœ‰ {rawData.length} é“ç²¾é¸é¡Œç›®
                          </p>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                          <button 
                            onClick={() => setMode('study')}
                            className="flex flex-col items-center p-8 bg-white rounded-2xl shadow-sm hover:shadow-xl hover:bg-orange-50 transition border-2 border-orange-100 hover:border-orange-300 group"
                          >
                            <div className="bg-orange-100 p-4 rounded-full mb-4 group-hover:scale-110 transition">
                              <List size={40} className="text-orange-600" />
                            </div>
                            <h3 className="text-xl font-bold text-orange-900">å…¨è¡¨ç€è¦½</h3>
                            <p className="text-stone-500 mt-2">å®Œæ•´æª¢è¦–æ³¨é‡‹å°ç…§è¡¨</p>
                          </button>

                          <button 
                            onClick={() => setMode('quiz')}
                            className="flex flex-col items-center p-8 bg-white rounded-2xl shadow-sm hover:shadow-xl hover:bg-orange-50 transition border-2 border-orange-100 hover:border-orange-300 group"
                          >
                            <div className="bg-orange-100 p-4 rounded-full mb-4 group-hover:scale-110 transition">
                              <Zap size={40} className="text-orange-600" />
                            </div>
                            <h3 className="text-xl font-bold text-orange-900">é–ƒé›»åˆ·é¡Œ</h3>
                            <p className="text-stone-500 mt-2">çœ‹è§£é‡‹çŒœèªè©</p>
                          </button>

                          <button 
                            onClick={() => setMode('favorites')}
                            className="flex flex-col items-center p-8 bg-white rounded-2xl shadow-sm hover:shadow-xl hover:bg-orange-50 transition border-2 border-orange-100 hover:border-orange-300 group"
                          >
                            <div className="bg-red-50 p-4 rounded-full mb-4 group-hover:scale-110 transition">
                              <Heart size={40} className="text-red-500 fill-red-500" />
                            </div>
                            <h3 className="text-xl font-bold text-orange-900">æˆ‘çš„æœ€æ„›</h3>
                            <p className="text-stone-500 mt-2">è¤‡ç¿’é‡é»æ”¶è—é¡Œç›®</p>
                          </button>

                          <button 
                            onClick={() => setMode('mistakes')}
                            className="flex flex-col items-center p-8 bg-white rounded-2xl shadow-sm hover:shadow-xl hover:bg-orange-50 transition border-2 border-orange-100 hover:border-orange-300 group"
                          >
                            <div className="bg-stone-100 p-4 rounded-full mb-4 group-hover:scale-110 transition">
                              <BookX size={40} className="text-stone-600" />
                            </div>
                            <h3 className="text-xl font-bold text-orange-900">éŒ¯é¡Œè¤‡ç¿’</h3>
                            <p className="text-stone-500 mt-2">é‡å°ç­”éŒ¯é¡Œç›®åŠ å¼·ç·´ç¿’</p>
                          </button>
<div style="margin-top: 20px;">
    <a href="index.html" 
       class="btn btn-gray" 
       style="text-decoration: none; padding: 10px 20px;
              background: linear-gradient(135deg, #ff4081 0%, #d81b60 100%);
              color: white; border-radius: 999px; display: inline-block;">
        ğŸ  è¿”å›åœ‹æ–‡å­¸ç¿’ App ç¸½éƒ¨
    </a>
</div>

                        </div>
                      </div>
                    )}

                    {mode === 'study' && (
                        <TableView 
                            data={rawData} 
                            favorites={favorites} 
                            onToggleFavorite={toggleFavorite} 
                            title="æ³¨é‡‹æˆ–æ–‡å¥ä¸€è¦½è¡¨"
                            updateConnectionStatus={updateConnectionStatus}
                        />
                    )}
                    
                    {mode === 'favorites' && (
                        <TableView 
                            data={rawData.filter(item => favorites.has(item.id))} 
                            favorites={favorites} 
                            onToggleFavorite={toggleFavorite} 
                            title="æˆ‘çš„æœ€æ„›æ¸…å–®"
                            emptyMessage="æ‚¨é‚„æ²’æœ‰åŠ å…¥ä»»ä½•æœ€æ„›é¡Œç›®å–”ï¼"
                            updateConnectionStatus={updateConnectionStatus}
                        />
                    )}

                    {mode === 'mistakes' && (
                        <TableView 
                            data={rawData.filter(item => mistakes.has(item.id))} 
                            favorites={favorites} 
                            onToggleFavorite={toggleFavorite} 
                            title="éŒ¯é¡Œè¤‡ç¿’æœ¬"
                            emptyMessage="å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰éŒ¯é¡Œç´€éŒ„ã€‚"
                            updateConnectionStatus={updateConnectionStatus}
                        />
                    )}

                    {mode === 'quiz' && (
                        <WaterfallQuizView 
                            data={rawData} 
                            currentUser={currentUser} 
                            favorites={favorites}
                            onToggleFavorite={toggleFavorite}
                            onAddMistake={addMistake}
                            onExit={() => setMode('menu')} 
                            db={db}
                            isFirebaseReady={isFirebaseReady}
                            collectionName={COLLECTION_NAME}
                            updateConnectionStatus={updateConnectionStatus}
                        />
                    )}
                  </main>
                </div>
              );
            };

            const LoginView = ({ users, onLogin, onDeleteUser, isConfigured, isLoading, connectionStatus }) => {
                const [inputName, setInputName] = useState("");

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if(inputName.trim()) onLogin(inputName.trim());
                }

                return (
                    <div className="min-h-screen bg-orange-50 flex items-center justify-center p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-2 border-orange-100 relative">
                            {!isConfigured && (
                                <div className="absolute top-0 left-0 w-full bg-red-100 text-red-700 text-xs text-center p-1 rounded-t-xl">
                                    å°šæœªè¨­å®š Firebase Config - åƒ…ä½¿ç”¨æœ¬æ©Ÿå„²å­˜
                                </div>
                            )}
                            <div className="text-center mb-8 mt-2">
                                <div className="bg-orange-100 p-3 rounded-full inline-block mb-4">
                                    <BookOpen size={40} className="text-orange-600" />
                                </div>
                                <h1 className="text-2xl font-bold text-orange-900">ç¬¬4å†Š L1 é‹å‹•å®¶çš„é¢¨åº¦</h1>
                                <p className="text-stone-500 mt-2">è«‹è¼¸å…¥å§“åä»¥é–‹å§‹å­¸ç¿’</p>
                                
                                <div className="mt-4 flex justify-center">
                                    <div className="flex items-center bg-stone-100 px-3 py-1 rounded-full text-xs">
                                         {connectionStatus === 'loading' && (
                                            <>
                                                <span className="status-dot status-loading"></span>
                                                <span className="text-stone-500">è®€å–è³‡æ–™ä¸­...</span>
                                            </>
                                        )}
                                        {connectionStatus === 'success' && (
                                            <>
                                                <span className="status-dot status-success"></span>
                                                <span className="text-stone-500">å·²åŒæ­¥</span>
                                            </>
                                        )}
                                        {connectionStatus === 'error' && (
                                            <>
                                                <span className="status-dot status-error"></span>
                                                <span className="text-stone-500">é›²ç«¯åŒæ­¥å¤±æ•—</span>
                                            </>
                                        )}
                                        {connectionStatus === 'offline' && (
                                            <>
                                                <span className="status-dot status-offline"></span>
                                                <span className="text-stone-500">æœ¬æ©Ÿæ¨¡å¼</span>
                                            </>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <input 
                                        type="text" 
                                        value={inputName}
                                        onChange={(e) => setInputName(e.target.value)}
                                        placeholder="è¼¸å…¥æ‚¨çš„åå­—"
                                        className="w-full px-4 py-3 rounded-xl border border-orange-200 focus:outline-none focus:ring-2 focus:ring-orange-400 text-lg"
                                        autoFocus
                                        disabled={isLoading}
                                    />
                                </div>
                                <button 
                                    type="submit" 
                                    disabled={!inputName.trim() || isLoading}
                                    className="w-full py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-xl font-bold text-lg transition disabled:opacity-50 flex justify-center items-center"
                                >
                                    {isLoading ? (
                                        <div className="spinner w-6 h-6 border-2 border-white border-t-transparent"></div>
                                    ) : "é–‹å§‹ä½¿ç”¨"}
                                </button>
                            </form>

                            <div className="mt-8">
                                <div className="relative mb-4">
                                    <div className="absolute inset-0 flex items-center">
                                        <div className="w-full border-t border-stone-200"></div>
                                    </div>
                                    <div className="relative flex justify-center text-sm">
                                        <span className="px-2 bg-white text-stone-500">å¿«é€Ÿç™»å…¥</span>
                                    </div>
                                </div>
                                
                                {users.length > 0 ? (
                                    <div className="flex flex-wrap gap-2 justify-center max-h-32 overflow-y-auto">
                                        {users.map((user, idx) => (
                                            <div key={idx} className="group flex items-center bg-stone-100 hover:bg-orange-100 rounded-full transition border border-transparent hover:border-orange-200 pr-1">
                                                <button
                                                    onClick={() => onLogin(user)}
                                                    disabled={isLoading}
                                                    className="px-4 py-2 text-stone-700 hover:text-orange-700 text-sm font-medium rounded-l-full"
                                                >
                                                    {user}
                                                </button>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        onDeleteUser(user);
                                                    }}
                                                    disabled={isLoading}
                                                    className="p-1.5 rounded-full text-stone-300 hover:text-red-500 hover:bg-red-50 transition"
                                                    title="åˆªé™¤ä½¿ç”¨è€…"
                                                >
                                                    <XCircle size={16} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center bg-stone-50 rounded-lg p-4 border border-stone-100">
                                        <p className="text-stone-400 text-sm">å°šç„¡æŒ‘æˆ°è€…ç´€éŒ„ï¼Œæ­¡è¿åŠ å…¥ï¼</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const TableView = ({ data, favorites, onToggleFavorite, title, emptyMessage = "æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„è³‡æ–™", updateConnectionStatus }) => {
              const [searchTerm, setSearchTerm] = useState("");

              const filteredData = data.filter(item => 
                item.question.includes(searchTerm) || 
                item.answer.includes(searchTerm) ||
                item.id.toString().includes(searchTerm)
              );

              return (
                <div className="bg-white rounded-xl shadow-lg overflow-hidden border border-orange-200 animate-in fade-in slide-in-from-bottom-4 duration-500">
                  <div className="p-4 border-b border-orange-100 bg-orange-50 flex flex-col md:flex-row justify-between items-center gap-4">
                    <h2 className="text-xl font-bold text-orange-900 flex items-center">
                      <List className="mr-2" size={24} />
                      {title}
                    </h2>
                    <input 
                      type="text" 
                      placeholder="æœå°‹èªè©æˆ–é‡‹ç¾©..." 
                      className="px-4 py-2 rounded-lg border border-orange-200 focus:outline-none focus:ring-2 focus:ring-orange-400 w-full md:w-64 bg-white"
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                    />
                  </div>
                  
                  <div className="overflow-x-auto max-h-[70vh]">
                    <table className="w-full text-left">
                      <thead className="bg-orange-100 sticky top-0 z-10 shadow-sm">
                        <tr>
                          <th className="p-4 font-black text-orange-900 border-b-2 border-orange-200 w-16 text-center">æ”¶è—</th>
                          <th className="p-4 font-black text-orange-900 border-b-2 border-orange-200 w-16">ç·¨è™Ÿ</th>
                          <th className="p-4 font-black text-orange-900 border-b-2 border-orange-200 w-1/4">èªè© / æ–‡å¥</th>
                          <th className="p-4 font-black text-orange-900 border-b-2 border-orange-200 w-1/4">æ³¨éŸ³</th>
                          <th className="p-4 font-black text-orange-900 border-b-2 border-orange-200">æ³¨é‡‹æˆ–æ‘˜é‡‹</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-orange-50">
                        {filteredData.length > 0 ? filteredData.map((item) => {
                          const isFav = favorites.has(item.id);
                          return (
                            <tr key={item.id} className="hover:bg-orange-50 transition-colors group">
                              <td className="p-4 text-center">
                                <button 
                                    onClick={() => onToggleFavorite(item.id)}
                                    className={`transition transform active:scale-90 p-1 rounded-full hover:bg-orange-100 ${isFav ? 'text-red-500' : 'text-stone-300 hover:text-red-400'}`}
                                >
                                    <Heart size={20} className={isFav ? "fill-current heart-click" : ""} />
                                </button>
                              </td>
                              <td className="p-4 text-stone-500 font-mono font-medium">{item.id}</td>
                              <td className="p-4 text-stone-800 text-lg font-medium">{item.question}</td>
                              <td className="p-4 text-lg font-medium zhuyin-text">{item.zhuyin}</td>
                              <td className="p-4 text-orange-700 text-lg font-bold">{item.answer}</td>
                            </tr>
                          );
                        }) : (
                          <tr>
                            <td colSpan="5" className="p-12 text-center text-stone-400 flex flex-col items-center justify-center">
                                <div className="mb-2 bg-stone-100 p-4 rounded-full">
                                    <List size={32} />
                                </div>
                                <p>{emptyMessage}</p>
                            </td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                  <div className="p-3 bg-orange-50 border-t border-orange-200 text-center text-sm text-stone-500">
                    é¡¯ç¤º {filteredData.length} ç­†è³‡æ–™
                  </div>
                </div>
              );
            };

            const WaterfallQuizView = ({ data, currentUser, favorites, onToggleFavorite, onAddMistake, onExit, db, isFirebaseReady, collectionName, updateConnectionStatus }) => {
              const [quizData, setQuizData] = useState([]);
              const [selections, setSelections] = useState({});
              
              useEffect(() => {
                const shuffledRawData = shuffleArray(data);

                const preparedData = shuffledRawData.map(item => {
                  let candidates = data.filter(i => i.id !== item.id && i.type === item.type);
                  
                  const targetLen = item.question.length;
                  candidates.sort((a, b) => {
                      const diffA = Math.abs(a.question.length - targetLen);
                      const diffB = Math.abs(b.question.length - targetLen);
                      return diffA - diffB;
                  });

                  let topCandidates = candidates.slice(0, 10);
                  if (topCandidates.length < 3) {
                     topCandidates = data.filter(i => i.id !== item.id);
                  }
                  
                  const shuffledOthers = shuffleArray(topCandidates);
                  const selectedDistractors = shuffledOthers.slice(0, 3).map(i => i.question);
                  const options = shuffleArray([item.question, ...selectedDistractors]);
                  
                  return { ...item, options };
                });
                setQuizData(preparedData);

                const loadProgress = async () => {
                    if (isFirebaseReady && db && currentUser) {
                          try {
                            const userDocRef = doc(db, collectionName, `user_${currentUser}`);
                            const docSnap = await getDoc(userDocRef);
                            if(docSnap.exists() && docSnap.data().quizProgress) {
                                setSelections(docSnap.data().quizProgress);
                            }
                        } catch (e) {
                            console.error("Error loading progress", e);
                        }
                    } else {
                          try {
                            const savedProgress = localStorage.getItem(`${collectionName}_progress_${currentUser}`);
                            if (savedProgress) {
                                setSelections(JSON.parse(savedProgress));
                            }
                        } catch (e) {}
                    }
                };
                loadProgress();
                
              }, [data, db, currentUser, isFirebaseReady, collectionName]);

              const handleSelect = async (questionId, option) => {
                const newSelections = {
                  ...selections,
                  [questionId]: option
                };
                setSelections(newSelections);
                
                if (isFirebaseReady) {
                    updateConnectionStatus('loading');
                    try {
                        const userRef = doc(db, collectionName, `user_${currentUser}`);
                        await setDoc(userRef, { quizProgress: newSelections }, { merge: true });
                        updateConnectionStatus('success');
                    } catch(e) {
                        console.error("Failed to save progress", e);
                        updateConnectionStatus('error');
                    }
                } else {
                    localStorage.setItem(`${collectionName}_progress_${currentUser}`, JSON.stringify(newSelections));
                }

                const currentItem = data.find(item => item.id === questionId);
                const isCorrect = option === currentItem.question;

                if (isCorrect) {
                    playSound('success');
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                } else {
                    playSound('error');
                    onAddMistake(questionId);
                }
              };
              
              const completedCount = Object.keys(selections).length;
              const progress = Math.round((completedCount / data.length) * 100);

              return (
                <div className="max-w-4xl mx-auto pb-20">
                  <div className="sticky top-16 z-10 bg-orange-50/95 backdrop-blur-sm pt-4 pb-2 border-b border-orange-200 mb-6 shadow-sm">
                     <div className="flex justify-between items-center mb-2 px-2">
                        <div>
                            <h2 className="text-xl font-bold text-orange-900 flex items-center gap-2">
                                <Zap size={24} className="fill-orange-500 text-orange-600"/>
                                é–ƒé›»åˆ·é¡Œ
                            </h2>
                            <p className="text-xs text-stone-500 mt-1">ä½œç­”è€…: {currentUser} | å·²å®Œæˆ: {completedCount} / {data.length} é¡Œ</p>
                        </div>
                        <div className="flex gap-2">
                            <button 
                                onClick={async () => {
                                    if(window.confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿæ‚¨å°‡éºå¤±ç›®å‰çš„ä½œç­”ç´€éŒ„ã€‚')) {
                                        if(window.confirm('å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦æ¸…ç©ºæ‰€æœ‰é€²åº¦é‡ä¾†å—ï¼Ÿ(æ­¤å‹•ä½œç„¡æ³•å¾©åŸ)')) {
                                            setSelections({});
                                            if (isFirebaseReady) {
                                                updateConnectionStatus('loading');
                                                const userRef = doc(db, collectionName, `user_${currentUser}`);
                                                await updateDoc(userRef, { quizProgress: {} });
                                                updateConnectionStatus('success');
                                            } else {
                                                localStorage.removeItem(`${collectionName}_progress_${currentUser}`);
                                            }
                                            window.scrollTo(0,0);
                                        }
                                    }
                                }}
                                className="px-3 py-1.5 bg-white border border-orange-300 text-orange-700 rounded-lg hover:bg-orange-50 font-medium text-xs sm:text-sm transition"
                            >
                                é‡ç½®é€²åº¦
                            </button>
                            <button 
                                onClick={onExit}
                                className="px-3 py-1.5 bg-stone-600 text-white rounded-lg hover:bg-stone-700 font-medium text-xs sm:text-sm transition"
                            >
                                æš«åœé›¢é–‹
                            </button>
                        </div>
                     </div>
                     <div className="w-full bg-orange-200 h-2.5 rounded-full overflow-hidden">
                        <div 
                            className="bg-orange-600 h-2.5 rounded-full progress-bar shadow-[0_0_10px_rgba(249,115,22,0.5)]" 
                            style={{ width: `${progress}%` }}
                        ></div>
                     </div>
                  </div>

                  <div className="space-y-6">
                    {quizData.map((item) => {
                        const userSelection = selections[item.id];
                        const isAnswered = userSelection !== undefined;
                        const isCorrect = userSelection === item.question;
                        const isFav = favorites.has(item.id);

                        return (
                            <div key={item.id} className={`bg-white rounded-xl shadow-sm border-2 transition-all duration-300 overflow-hidden ${isAnswered ? (isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50') : 'border-orange-100'}`}>
                                <div className="p-4 border-b border-black/5 flex items-start gap-3">
                                    <span className="bg-orange-100 text-orange-800 font-mono font-bold px-2 py-1 rounded text-sm shrink-0 mt-1">
                                        #{item.id}
                                    </span>
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2">
                                            <button 
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    onToggleFavorite(item.id);
                                                }}
                                                className={`transition transform active:scale-90 p-1 rounded-full -ml-2 ${isFav ? 'text-red-500' : 'text-stone-300 hover:text-red-400'}`}
                                                title={isFav ? "å–æ¶ˆæ”¶è—" : "åŠ å…¥æœ€æ„›"}
                                            >
                                                <Heart size={20} className={isFav ? "fill-current heart-click" : ""} />
                                            </button>
                                            <h3 className="text-xl md:text-2xl font-bold text-stone-800 leading-snug">
                                                {item.answer}
                                            </h3>
                                        </div>
                                    </div>
                                    {isAnswered && (
                                        <div className="ml-auto shrink-0">
                                            {isCorrect ? <CheckCircle className="text-green-500" /> : <XCircle className="text-red-500" />}
                                        </div>
                                    )}
                                </div>

                                <div className="p-4 bg-white/50">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        {item.options.map((option, idx) => {
                                            let btnClass = "py-3 px-4 rounded-lg font-bold text-lg text-left transition-all border-2 relative ";
                                            
                                            if (isAnswered) {
                                                if (option === item.question) {
                                                    btnClass += "bg-green-500 text-white border-green-600 shadow-md";
                                                } else if (option === userSelection && !isCorrect) {
                                                    btnClass += "bg-red-500 text-white border-red-600 shadow-md";
                                                } else {
                                                    btnClass += "bg-stone-50 text-stone-400 border-transparent opacity-50";
                                                }
                                            } else {
                                                btnClass += "bg-white text-stone-700 border-stone-200 hover:border-orange-400 hover:bg-orange-50 active:scale-95";
                                            }

                                            return (
                                                <button
                                                    key={idx}
                                                    onClick={() => !isAnswered && handleSelect(item.id, option)}
                                                    disabled={isAnswered}
                                                    className={btnClass}
                                                >
                                                    {option}
                                                </button>
                                            );
                                        })}
                                    </div>
                                    {isAnswered && !isCorrect && (
                                        <div className="mt-3 text-sm text-red-600 font-medium animate-in fade-in slide-in-from-top-1 bg-red-50 p-2 rounded border border-red-100">
                                            æ­£ç¢ºç­”æ¡ˆï¼š{item.question} <span className="zhuyin-text ml-2 text-red-500">{item.zhuyin}</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                  </div>

                  {progress === 100 && (
                    <div className="mt-8 p-8 bg-green-100 rounded-2xl text-center border-2 border-green-300 animate-in zoom-in duration-300">
                        <h3 className="text-2xl font-bold text-green-800 mb-2">æ­å–œå®Œæˆæ‰€æœ‰é¡Œç›®ï¼</h3>
                        <p className="text-green-700">æ‚¨å·²ç¶“å®Œæˆäº† {data.length} é¡Œçš„ç·´ç¿’ã€‚</p>
                        <button 
                            onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
                            className="mt-4 text-green-700 underline hover:text-green-900"
                        >
                            å›åˆ°é ‚éƒ¨
                        </button>
                    </div>
                  )}
                </div>
              );
            };

            const root = createRoot(document.getElementById('root'));
            root.render(<App />);
        }
    </script>
</body>
</html>