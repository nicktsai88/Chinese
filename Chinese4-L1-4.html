<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L1 é‹å‹•å®¶çš„é¢¨åº¦-å­—å½¢ç·´ç¿’ (Cloud)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #fff7ed; 
        }
        ::-webkit-scrollbar-thumb {
            background: #fdba74; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #fb923c; 
        }
        /* Hide scrollbar for clean horizontal scroll if needed */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Progress bar transition */
        .progress-bar {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Heart animation */
        @keyframes heartbeat {
            0% { transform: scale(1); }
            25% { transform: scale(1.2); }
            50% { transform: scale(1); }
            75% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .heart-click {
            animation: heartbeat 0.4s ease-in-out;
        }
        /* Status Dot styles */
        .status-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-loading { background-color: #eab308; box-shadow: 0 0 4px #eab308; animation: pulse 1.5s infinite; } /* Yellow */
        .status-success { background-color: #22c55e; box-shadow: 0 0 4px #22c55e; } /* Green */
        .status-error { background-color: #ef4444; box-shadow: 0 0 4px #ef4444; }    /* Red */
        
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* åˆå§‹åŠ è¼‰é®ç½© */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff7ed;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            transition: opacity 0.5s;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ea580c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-orange-50">
    <!-- åˆå§‹åŠ è¼‰ç•«é¢ï¼Œé˜²æ­¢ç™½å± -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-orange-600 font-bold">æ­£åœ¨è¼‰å…¥å­—å½¢ç·´ç¿’...</p>
    </div>

    <div id="root"></div>

    <!-- 1. æ¨¡çµ„é åŠ è¼‰å™¨ (Module Pre-loader) -->
    <!-- ä¿®å¾©æ–¹æ¡ˆï¼šä¸ä½¿ç”¨ importmapï¼Œæ”¹ç”¨æ¨™æº– module script ä¸‹è¼‰ä¾è³´ä¸¦æ›è¼‰åˆ° window -->
    <script type="module">
        // å°å…¥ React
        import React from "https://esm.sh/react@18.2.0";
        import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";
        
        // å°å…¥ UI çµ„ä»¶åº“ Lucide React
        import * as Lucide from "https://esm.sh/lucide-react@0.263.1";
        
        // å°å…¥ç‰¹æ•ˆåº“
        import confetti from "https://esm.sh/canvas-confetti@1.9.2";
        
        // å°å…¥ Firebase (ä½¿ç”¨ Google å®˜æ–¹ CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // å°‡æ¨¡çµ„æ›è¼‰åˆ°å…¨å±€ window å°è±¡
        window.React = React;
        window.ReactDOM = ReactDOM;
        window.Lucide = Lucide;
        window.confetti = confetti;
        window.Firebase = {
            initializeApp,
            getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, arrayUnion, getDoc
        };

        // é€šçŸ¥æ‡‰ç”¨ç¨‹åºä¾è³´å·²æº–å‚™å°±ç·’
        window.dispatchEvent(new Event('modules-loaded'));
    </script>

    <!-- 2. ä¸»æ‡‰ç”¨ç¨‹åºé‚è¼¯ (Main App Logic) -->
    <script type="text/babel">
        // ç­‰å¾…æ¨¡çµ„åŠ è¼‰å®Œæˆå¾Œå†å•Ÿå‹• React
        window.addEventListener('modules-loaded', () => {
            initApp();
        });

        // æª¢æŸ¥æ˜¯å¦å·²ç¶“è¼‰å…¥ (ä»¥é˜²è¬ä¸€)
        if (window.React && window.Firebase) {
             setTimeout(initApp, 100);
        }

        function initApp() {
            // éš±è—åŠ è¼‰ç•«é¢
            const loader = document.getElementById('loading-overlay');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 500);
            }

            // --- è®Šé‡è§£æ§‹ (æ›¿ä»£ import) ---
            const { useState, useEffect, useCallback, useRef } = window.React;
            const { createRoot } = window.ReactDOM;
            // ç¢ºä¿å¾ Lucide ä¸­ç²å–æ‰€æœ‰åœ–æ¨™
            const { BookOpen, List, Sun, User, LogOut, Zap, Heart, BookX, CheckCircle, XCircle, ArrowRightLeft, Cloud } = window.Lucide;
            const confetti = window.confetti;
            
            // Firebase å‡½æ•¸
            const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDoc } = window.Firebase;

            // --- Firebase Configuration ---
            const firebaseConfig = {
                apiKey: "AIzaSyAxQFt76ZPXE7d0i1XeNZ1yiiD2WYNIfHs",
                authDomain: "chinese-learning-47f4d.firebaseapp.com",
                projectId: "chinese-learning-47f4d",
                storageBucket: "chinese-learning-47f4d.firebasestorage.app",
                messagingSenderId: "76289812052",
                appId: "1:76289812052:web:898384a916f9f341f62fc1"
            };

            // Initialize Firebase
            let app, auth, db;
            try {
                if (firebaseConfig.apiKey !== "è«‹å¡«å…¥æ‚¨çš„API_KEY") {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                } else {
                    console.warn("Firebase Config æœªè¨­å®š");
                }
            } catch (error) {
                console.error("Firebase Init Error:", error);
            }

            // --- CONSTANTS ---
            const COLLECTION_NAME = 'Chinese4-L1-4'; 
            const DOC_GLOBAL = 'global_users';

            // è³‡æ–™åº«ï¼šå­—å½¢è¾¨æ­£
            const rawData = [
                // 1
                { id: 101, question: "ç„¡å‹•æ–¼ã€Œã„“ã„¨ã„¥ã€", answer: "è¡·", distractors: ["é¾", "ä¸­", "å¿ "], note: "æ¯”è¼ƒï¼šä¸€è¦‹ã€Œã„“ã„¨ã„¥ã€æƒ… (é¾)" },
                { id: 102, question: "ä¸€è¦‹ã€Œã„“ã„¨ã„¥ã€æƒ…", answer: "é¾", distractors: ["è¡·", "ä¸­", "é˜"], note: "æ¯”è¼ƒï¼šç„¡å‹•æ–¼ã€Œã„“ã„¨ã„¥ã€ (è¡·)" },
                // 2
                { id: 201, question: "æ‰“èº¬ä½œã€Œã„§ã€", answer: "æ–", distractors: ["è¼¯", "ç·", "ä¾"], note: "ç›¸åŒï¼šèˆ‡ã€Œã„§ã€è®“è€Œå‡åŒå­—" },
                { id: 202, question: "ã€Œã„§ã€è®“è€Œå‡", answer: "æ–", distractors: ["è¼¯", "ä¾", "å£¹"], note: "ç›¸åŒï¼šèˆ‡æ‰“èº¬ä½œã€Œã„§ã€åŒå­—" },
                { id: 203, question: "ã€Œã„§ã€æ¨£ç•«è‘«è˜†", answer: "ä¾", distractors: ["æ–", "è¡£", "ä¼Š"], note: "ä¸åŒï¼šèˆ‡ã€Œæ–ã€è®“è€Œå‡ä¸åŒ" },
                { id: 204, question: "é€šã€Œã„‘ã„§Ë‹ã€", answer: "ç·", distractors: ["æ–", "è¼¯", "è‘º"], note: "ä¸åŒï¼šèˆ‡ã€Œæ–ã€è®“è€Œå‡ä¸åŒ" },
                { id: 205, question: "ç·¨ã€Œã„ã„§ËŠã€", answer: "è¼¯", distractors: ["æ–", "ç·", "é›†"], note: "ä¸åŒï¼šèˆ‡ã€Œæ–ã€è®“è€Œå‡ä¸åŒ" },
                // 3
                { id: 301, question: "æš—ã€Œã„ã„§ã„¢Ë‹ã€å‚·äºº", answer: "ç®­", distractors: ["åŠ", "é‘‘", "å»º"], note: "ä¸åŒï¼šèˆ‡ã€Œã„ã„§ã„¢Ë‹ã€åŠå±¥åŠ (åŠ) ä¸åŒ" },
                { id: 302, question: "ã€Œã„ã„§ã„¢Ë‹ã€åŠå±¥åŠ", answer: "åŠ", distractors: ["ç®­", "è¦‹", "å¥"], note: "ä¸åŒï¼šèˆ‡æš—ã€Œã„ã„§ã„¢Ë‹ã€å‚·äºº (ç®­) ä¸åŒ" },
                { id: 303, question: "é—œã€Œã„ã„§ã„¢Ë‹ã€", answer: "éµ", distractors: ["ç®­", "å»º", "å¥"], note: "ä¸åŒï¼šèˆ‡æš—ã€Œã„ã„§ã„¢Ë‹ã€å‚·äºº (ç®­) ä¸åŒ" },
                // 4
                { id: 401, question: "è¬ç›®ã€Œã„ã„¨ã„ŸËŠ ã„ã„¨ã„ŸËŠã€", answer: "ç½", distractors: ["æ†", "è‘µ", "é­"], note: "ä¸åŒï¼šèˆ‡é–£ã€Œã„ã„¨ã„ŸËŠã€ (æ†) ä¸åŒ" },
                { id: 402, question: "é–£ã€Œã„ã„¨ã„ŸËŠã€", answer: "æ†", distractors: ["ç½", "è‘µ", "é­"], note: "ä¸åŒï¼šèˆ‡è¬ç›®ã€Œã„ã„¨ã„ŸËŠã€ (ç½) ä¸åŒ" },
                { id: 403, question: "ã€Œã„ã„¨ã„ŸËŠã€é•å·²ä¹…", answer: "ç½", distractors: ["æ†", "è‘µ", "é­"], note: "ç›¸åŒï¼šèˆ‡è¬ç›®ã€Œã„ã„¨ã„ŸËŠã€åŒå­—" },
                { id: 404, question: "å‘æ—¥ã€Œã„ã„¨ã„ŸËŠã€", answer: "è‘µ", distractors: ["ç½", "æ†", "é­"], note: "ä¸åŒï¼šæ¤ç‰©å" },
                { id: 405, question: "ç½ªã€Œã„ã„¨ã„ŸËŠã€ç¦é¦–", answer: "é­", distractors: ["ç½", "æ†", "è‘µ"], note: "ä¸åŒï¼šé¦–é ˜ä¹‹æ„" },
                // 5
                { id: 501, question: "é™¶ã€Œã„“ã„¨Ë‹ã€", answer: "é‘„", distractors: ["èºŠ", "æ³¨", "åŠ©"], note: "ç›¸åŒï¼šèˆ‡ã€Œã„“ã„¨Ë‹ã€æˆå¤§éŒ¯åŒå­—" },
                { id: 502, question: "ã€Œã„“ã„¨Ë‹ã€æˆå¤§éŒ¯", answer: "é‘„", distractors: ["èºŠ", "é§", "ç¥"], note: "ç›¸åŒï¼šèˆ‡é™¶ã€Œã„“ã„¨Ë‹ã€åŒå­—" },
                { id: 503, question: "èºŠã€Œã„”ã„¡ËŠã€", answer: "èº‡", distractors: ["é‘„", "ç±Œ", "ç–‡"], note: "æ¯”è¼ƒï¼šé™¶ã€Œã„“ã„¨Ë‹ã€ (é‘„)" }, 
                { id: 504, question: "é‹ç±Œå¸·ã€Œã„¨ã„›Ë‹ã€", answer: "å¹„", distractors: ["æ¡", "æ¸¥", "æ²ƒ"], note: "æ¯”è¼ƒï¼šé™¶ã€Œã„“ã„¨Ë‹ã€ (é‘„)" },
                // 6
                { id: 601, question: "ä»¥åœ‹å®¶ç‚ºå‰ã€Œã„Šã„§ËŠã€", answer: "æ", distractors: ["é¡Œ", "å ¤", "å•¼"], note: "ä¸åŒï¼šèˆ‡é‡‘æ¦œã€Œã„Šã„§ËŠã€å (é¡Œ) ä¸åŒ" },
                { id: 602, question: "é‡‘æ¦œã€Œã„Šã„§ËŠã€å", answer: "é¡Œ", distractors: ["æ", "å ¤", "è¹„"], note: "ä¸åŒï¼šèˆ‡å‰ã€Œã„Šã„§ËŠã€ (æ) ä¸åŒ" },
                { id: 603, question: "è€³ã€Œã„Šã„§ËŠã€é¢å‘½", answer: "æ", distractors: ["é¡Œ", "å ¤", "é€–"], note: "ç›¸åŒï¼šèˆ‡å‰ã€Œã„Šã„§ËŠã€åŒå­—" },
                { id: 604, question: "å°ã€Œã„Šã„§ËŠã€å¤§ä½œ", answer: "é¡Œ", distractors: ["æ", "å ¤", "è¹„"], note: "ä¸åŒï¼šèˆ‡å‰ã€Œã„Šã„§ËŠã€ (æ) ä¸åŒ" },
                // 7
                { id: 701, question: "ã€Œã„ã„§ã„ã€æ›‰", answer: "æ­", distractors: ["ç«­", "æ¥", "çµ"], note: "ä¸åŒï¼šèˆ‡ã€Œã„ã„§ã„ËŠã€èª  (ç«­) ä¸åŒ" },
                { id: 702, question: "ã€Œã„ã„§ã„ËŠã€èª ", answer: "ç«­", distractors: ["æ­", "æ½”", "çµ"], note: "ä¸åŒï¼šèˆ‡ã€Œã„ã„§ã„ã€æ›‰ (æ­) ä¸åŒ" },
                { id: 703, question: "ã€Œã„ã„§ã„ã€ç©¿çœŸç›¸", answer: "æ­", distractors: ["ç«­", "æ¥", "çµ"], note: "ç›¸åŒï¼šèˆ‡ã€Œã„ã„§ã„ã€æ›‰åŒå­—" },
                { id: 704, question: "ã€Œã„ã„§ã„ã€ç«¿èµ·ç¾©", answer: "æ­", distractors: ["ç«­", "æ¥", "çµ"], note: "ç›¸åŒï¼šèˆ‡ã€Œã„ã„§ã„ã€æ›‰åŒå­—" },
                { id: 705, question: "è²å˜¶åŠ›ã€Œã„ã„§ã„ËŠã€", answer: "ç«­", distractors: ["æ­", "æ½”", "æ°"], note: "ç›¸åŒï¼šèˆ‡ã€Œã„ã„§ã„ËŠã€èª åŒå­—" },
                { id: 706, question: "ã€Œã„’ã„§ã„ã€æ–¯åº•é‡Œ", answer: "æ­‡", distractors: ["ç«­", "æ­", "äº›"], note: "ä¸åŒï¼šèˆ‡ã€Œã„ã„§ã„ËŠã€èª  (ç«­) ä¸åŒ" },
                // 8
                { id: 801, question: "ã€Œã„©ã„¥ã€å®¹è¯è²´", answer: "é›", distractors: ["åº¸", "æ“", "å‚­"], note: "ä¸åŒï¼šèˆ‡é™„ã€Œã„©ã„¥ã€é¢¨é›… (åº¸) ä¸åŒ" },
                { id: 802, question: "é™„ã€Œã„©ã„¥ã€é¢¨é›…", answer: "åº¸", distractors: ["é›", "æ“", "å‚­"], note: "ä¸åŒï¼šèˆ‡ã€Œã„©ã„¥ã€å®¹è¯è²´ (é›) ä¸åŒ" },
                { id: 803, question: "ã€Œã„©ã„¥ã€ä¿—ä¸å ª", answer: "åº¸", distractors: ["é›", "æ“", "å‚­"], note: "ä¸åŒï¼šèˆ‡ã€Œã„©ã„¥ã€å®¹è¯è²´ (é›) ä¸åŒ" },
                { id: 804, question: "ã€Œã„©ã„¥ã€æ“ ", answer: "æ“", distractors: ["é›", "åº¸", "æ¹§"], note: "ä¸åŒï¼šèˆ‡ã€Œã„©ã„¥ã€å®¹è¯è²´ (é›) ä¸åŒ" },
                { id: 805, question: "ä¸­ã€Œã„©ã„¥ã€ä¹‹é“", answer: "åº¸", distractors: ["é›", "æ“", "ç”¨"], note: "ä¸åŒï¼šèˆ‡ã€Œã„©ã„¥ã€å®¹è¯è²´ (é›) ä¸åŒ" },
                // 9
                { id: 901, question: "ã€Œã„’ã„§ã„ËŠã€èª¿", answer: "å”", distractors: ["è«§", "è„…", "æ”œ"], note: "ä¸åŒï¼šèˆ‡å’Œã€Œã„’ã„§ã„ËŠã€ (è«§) ä¸åŒ" },
                { id: 902, question: "å’Œã€Œã„’ã„§ã„ËŠã€ç›¸è™•", answer: "è«§", distractors: ["å”", "é‹", "æ”œ"], note: "ä¸åŒï¼šèˆ‡ã€Œã„’ã„§ã„ËŠã€èª¿ (å”) ä¸åŒ" },
                // 10
                { id: 1001, question: "åŠé€”è€Œã€Œã„ˆã„ŸË‹ã€", answer: "å»¢", distractors: ["è²»", "è‚º", "å "], note: "ä¸åŒï¼šèˆ‡æ‰ã€Œã„ˆã„ŸË‹ã€ (è²») ä¸åŒ" },
                { id: 1002, question: "æ‰ã€Œã„ˆã„ŸË‹ã€å·¥å¤«", answer: "è²»", distractors: ["å»¢", "è‚º", "æ²¸"], note: "ä¸åŒï¼šèˆ‡åŠé€”è€Œã€Œã„ˆã„ŸË‹ã€ (å»¢) ä¸åŒ" },
                { id: 1003, question: "ã€Œã„ˆã„ŸË‹ã€å¯¢å¿˜é£Ÿ", answer: "å»¢", distractors: ["è²»", "è‚º", "æ²¸"], note: "ç›¸åŒï¼šèˆ‡åŠé€”è€Œã€Œã„ˆã„ŸË‹ã€åŒå­—" },
                // 11
                { id: 1101, question: "å…‰ã€Œã„‡ã„§ã„¥ËŠã€æ­£å¤§", answer: "æ˜", distractors: ["å", "éŠ˜", "é³´"], note: "ä¸åŒï¼šèˆ‡ã€Œã„‡ã„§ã„¥ËŠã€åˆ—å‰èŒ… (å) ä¸åŒ" },
                { id: 1102, question: "ã€Œã„‡ã„§ã„¥ËŠã€åˆ—å‰èŒ…", answer: "å", distractors: ["æ˜", "éŠ˜", "é³´"], note: "ä¸åŒï¼šèˆ‡å…‰ã€Œã„‡ã„§ã„¥ËŠã€æ­£å¤§ (æ˜) ä¸åŒ" },
                // 12
                { id: 1201, question: "ä¿¡ã€Œã„•Ë‹ã€æ—¦æ—¦", answer: "èª“", distractors: ["å‹¢", "ä¸–", "è©¦"], note: "ç›¸åŒï¼šèˆ‡ã€Œã„•Ë‹ã€ä¸ç”˜ä¼‘åŒå­—" },
                { id: 1202, question: "ã€Œã„•Ë‹ã€ä¸ç”˜ä¼‘", answer: "èª“", distractors: ["å‹¢", "ä¸–", "è©¦"], note: "ç›¸åŒï¼šèˆ‡ã€Œã„•Ë‹ã€èª“æ—¦æ—¦åŒå­—" },
                { id: 1203, question: "èˆ‰è¡Œå®£ã€Œã„•Ë‹ã€", answer: "èª“", distractors: ["å‹¢", "ä¸–", "è©¦"], note: "ä¸åŒï¼šèˆ‡ã€Œã„•Ë‹ã€å¦‚ç ´ç«¹ (å‹¢) ä¸åŒ" },
                { id: 1204, question: "ã€Œã„•Ë‹ã€å¦‚ç ´ç«¹", answer: "å‹¢", distractors: ["èª“", "ä¸–", "è©¦"], note: "ä¸åŒï¼šèˆ‡å®£ã€Œã„•Ë‹ã€ (èª“) ä¸åŒ" },
                // 13
                { id: 1301, question: "ã€Œã„’ã„§ã„¥Ë‹ ã„’ã„§ã„¥Ë‹ã€ç„¶", answer: "æ‚»", distractors: ["å€–", "å¹¸", "æ€§"], note: "ä¸åŒï¼šèˆ‡åƒ¥ã€Œã„’ã„§ã„¥Ë‹ã€ (å€–) ä¸åŒ" },
                { id: 1302, question: "åƒ¥ã€Œã„’ã„§ã„¥Ë‹ã€", answer: "å€–", distractors: ["æ‚»", "å¹¸", "æ€§"], note: "ä¸åŒï¼šèˆ‡ã€Œã„’ã„§ã„¥Ë‹ã€ç„¶ (æ‚») ä¸åŒ" },
                { id: 1303, question: "ã€Œã„’ã„§ã„¥Ë‹ã€ç½æ¨‚ç¦", answer: "å¹¸", distractors: ["æ‚»", "å€–", "æ€§"], note: "ä¸åŒï¼šèˆ‡ã€Œã„’ã„§ã„¥Ë‹ã€ç„¶ (æ‚») ä¸åŒ" },
                // 14
                { id: 1401, question: "ä¸ã€Œã„’ã„§ã„Ë‹ã€", answer: "å±‘", distractors: ["è‚–", "æ‡ˆ", "è¬"], note: "ä¸åŒï¼šèˆ‡ä¸ã€Œã„’ã„§ã„ Ë‹ã€å­ (è‚–) ä¸åŒ" },
                { id: 1402, question: "ä¸ã€Œã„’ã„§ã„ Ë‹ã€å­", answer: "è‚–", distractors: ["å±‘", "å­", "ç¬‘"], note: "ä¸åŒï¼šèˆ‡ä¸ã€Œã„’ã„§ã„Ë‹ã€ (å±‘) ä¸åŒ" },
                { id: 1403, question: "å¤™å¤œåŒªã€Œã„’ã„§ã„Ë‹ã€", answer: "æ‡ˆ", distractors: ["å±‘", "è¬", "æ¢°"], note: "ä¸åŒï¼šèˆ‡ä¸ã€Œã„’ã„§ã„Ë‹ã€ (å±‘) ä¸åŒ" },
                // 15
                { id: 1501, question: "ã€Œã„§ã„¡ã€äºº", answer: "å°¤", distractors: ["ç”±", "å„ª", "æ†‚"], note: "ä¸åŒï¼šèˆ‡ã€Œã„§ã„¡ËŠã€å‘½ (ç”±) ä¸åŒ" },
                { id: 1502, question: "ã€Œã„§ã„¡ËŠã€å‘½", answer: "ç”±", distractors: ["å°¤", "æ¸¸", "æ²¹"], note: "ä¸åŒï¼šèˆ‡ã€Œã„§ã„¡ã€äºº (å°¤) ä¸åŒ" },
                { id: 1503, question: "ã€Œã„§ã„¡ã€ä¾†", answer: "ç”±", distractors: ["å°¤", "æ¸¸", "æ²¹"], note: "ä¸åŒï¼šèˆ‡ã€Œã„§ã„¡ã€äºº (å°¤) ä¸åŒ" },
                // 16
                { id: 1601, question: "ã€Œã„ã„§ã€ç¤", answer: "åŸº", distractors: ["ç©", "é›", "æ©Ÿ"], note: "ä¸åŒï¼šèˆ‡ã€Œã„ã„§ã€éæˆæ˜¯ (ç©) ä¸åŒ" },
                { id: 1602, question: "ã€Œã„ã„§ã€éæˆæ˜¯", answer: "ç©", distractors: ["åŸº", "ç¸¾", "æ“Š"], note: "ä¸åŒï¼šèˆ‡ã€Œã„ã„§ã€ç¤ (åŸº) ä¸åŒ" },
                // 17
                { id: 1701, question: "ã€Œã„“ã„¨ã€å­ç™¾å®¶", answer: "è«¸", distractors: ["é‘„", "ç ", "æœ±"], note: "ç›¸åŒï¼šèˆ‡å…¬ã€Œã„“ã„¨ã€æ–¼ä¸–åŒå­—" },
                { id: 1702, question: "å…¬ã€Œã„“ã„¨ã€æ–¼ä¸–", answer: "è«¸", distractors: ["é‘„", "ç ", "æœ±"], note: "ç›¸åŒï¼šèˆ‡ã€Œã„“ã„¨ã€å­ç™¾å®¶åŒå­—" },
                { id: 1703, question: "ã€Œã„“ã„¨Ë‹ã€é€ ", answer: "é‘„", distractors: ["è«¸", "ç¯‰", "åŠ©"], note: "ä¸åŒï¼šèˆ‡å…¬ã€Œã„“ã„¨ã€ (è«¸) ä¸åŒ" },
                // 18
                { id: 1801, question: "ã€Œã„”ã„¤Ë‹ã€æ‰€æ¬²è¨€", answer: "æš¢", distractors: ["å€¡", "çŒ–", "å”±"], note: "ä¸åŒï¼šèˆ‡æã€Œã„”ã„¤Ë‹ã€ (å€¡) ä¸åŒ" },
                { id: 1802, question: "æã€Œã„”ã„¤Ë‹ã€", answer: "å€¡", distractors: ["æš¢", "çŒ–", "å”±"], note: "ä¸åŒï¼šèˆ‡ã€Œã„”ã„¤Ë‹ã€æ‰€æ¬²è¨€ (æš¢) ä¸åŒ" },
                { id: 1803, question: "ã€Œã„”ã„¤ã€ç—", answer: "çŒ–", distractors: ["å€¡", "æš¢", "æ˜Œ"], note: "ä¸åŒï¼šèˆ‡æã€Œã„”ã„¤Ë‹ã€ (å€¡) ä¸åŒ" },
                { id: 1804, question: "ã€Œã„”ã„¤ã€ç››", answer: "æ˜Œ", distractors: ["å€¡", "çŒ–", "æš¢"], note: "ä¸åŒï¼šèˆ‡æã€Œã„”ã„¤Ë‹ã€ (å€¡) ä¸åŒ" },
                // 19
                { id: 1901, question: "æ•—è€…ç‚ºã€Œã„ã„¡Ë‹ã€", answer: "å¯‡", distractors: ["å©", "æ‰£", "è”»"], note: "ç›¸åŒï¼šèˆ‡çª®ã€Œã„ã„¡Ë‹ã€è«è¿½åŒå­—" },
                { id: 1902, question: "çª®ã€Œã„ã„¡Ë‹ã€è«è¿½", answer: "å¯‡", distractors: ["å©", "æ‰£", "è”»"], note: "ç›¸åŒï¼šèˆ‡æ•—è€…ç‚ºã€Œã„ã„¡Ë‹ã€åŒå­—" },
                // 20
                { id: 2001, question: "æ„›çš„çœŸã€Œã„‰ã„§Ë‹ã€", answer: "è«¦", distractors: ["è’‚", "å¸", "åœ°"], note: "ä¸åŒï¼šèˆ‡ç“œç†Ÿã€Œã„‰ã„§Ë‹ã€è½ (è’‚) ä¸åŒ" },
                { id: 2002, question: "ç“œç†Ÿã€Œã„‰ã„§Ë‹ã€è½", answer: "è’‚", distractors: ["è«¦", "åœ°", "ç¬¬"], note: "ä¸åŒï¼šèˆ‡çœŸã€Œã„‰ã„§Ë‹ã€ (è«¦) ä¸åŒ" },
                // 21
                { id: 2101, question: "æ‡ˆã€Œã„‰ã„Ë‹ã€", answer: "æ€ ", distractors: ["æ®†", "å¾…", "ä»£"], note: "ä¸åŒï¼šèˆ‡å±ã€Œã„‰ã„Ë‹ã€ (æ®†) ä¸åŒ" },
                { id: 2102, question: "å±ã€Œã„‰ã„Ë‹ã€", answer: "æ®†", distractors: ["æ€ ", "å¾…", "ä»£"], note: "ä¸åŒï¼šèˆ‡æ‡ˆã€Œã„‰ã„Ë‹ã€ (æ€ ) ä¸åŒ" },
                { id: 2103, question: "ã€Œã„§ËŠã€ç¬‘å¤§æ–¹", answer: "è²½", distractors: ["æ€¡", "éº", "ç§»"], note: "æ¯”è¼ƒï¼šæ‡ˆã€Œã„‰ã„Ë‹ã€ (æ€ )" },
                // 22
                { id: 2201, question: "ã€Œã„“ã„¥ã€å…ˆæå¾Œ", answer: "çˆ­", distractors: ["çœ", "å¾", "è’¸"], note: "ä¸åŒï¼šèˆ‡ã€Œã„“ã„¥ã€çœ¼ (çœ) ä¸åŒ" },
                { id: 2202, question: "ã€Œã„“ã„¥ã€çœ¼èªªçè©±", answer: "çœ", distractors: ["çˆ­", "å¾", "è’¸"], note: "ä¸åŒï¼šèˆ‡ã€Œã„“ã„¥ã€å…ˆ (çˆ­) ä¸åŒ" },
                // 23
                { id: 2301, question: "å¤–è²¨å……ã€Œã„”Ë‹ã€", answer: "æ–¥", distractors: ["èµ¤", "å±", "æ••"], note: "ç›¸åŒï¼šèˆ‡ã€Œã„”Ë‹ã€è³‡æ“´å» åŒå­—" },
                { id: 2302, question: "ã€Œã„”Ë‹ã€è³‡æ“´å» ", answer: "æ–¥", distractors: ["èµ¤", "å±", "æ••"], note: "ç›¸åŒï¼šèˆ‡å¤–è²¨å……ã€Œã„”Ë‹ã€åŒå­—" },
                { id: 2303, question: "æ’ã€Œã„”Ë‹ã€", answer: "æ–¥", distractors: ["èµ¤", "å±", "æ••"], note: "ä¸åŒï¼šèˆ‡ã€Œã„”Ë‹ã€å’é¢¨é›² (å±) ä¸åŒ" },
                { id: 2304, question: "ã€Œã„”Ë‹ã€å’é¢¨é›²", answer: "å±", distractors: ["æ–¥", "èµ¤", "æ••"], note: "ä¸åŒï¼šèˆ‡æ’ã€Œã„”Ë‹ã€ (æ–¥) ä¸åŒ" },
                { id: 2305, question: "è¿‘æœ±è€…ã€Œã„”Ë‹ã€", answer: "èµ¤", distractors: ["æ–¥", "å±", "æ••"], note: "ä¸åŒï¼šèˆ‡æ’ã€Œã„”Ë‹ã€ (æ–¥) ä¸åŒ" },
                // 24
                { id: 2401, question: "æˆ°æˆ°ã€Œã„ã„§ã„¥ ã„ã„§ã„¥ã€", answer: "å…¢", distractors: ["ç«¶", "é©š", "ç²¾"], note: "ä¸åŒï¼šèˆ‡ã€Œã„ã„§ã„¥Ë‹ã€çˆ­ (ç«¶) ä¸åŒ" },
                { id: 2402, question: "ã€Œã„ã„§ã„¥Ë‹ã€çˆ­æ¿€çƒˆ", answer: "ç«¶", distractors: ["å…¢", "å‹", "æ•¬"], note: "ä¸åŒï¼šèˆ‡æˆ°æˆ°ã€Œã„ã„§ã„¥ã€ (å…¢) ä¸åŒ" },
                { id: 2403, question: "å¼·ã€Œã„ã„§ã„¥Ë‹ã€", answer: "å‹", distractors: ["ç«¶", "æ•¬", "å¾‘"], note: "ä¸åŒï¼šèˆ‡ã€Œã„ã„§ã„¥Ë‹ã€çˆ­ (ç«¶) ä¸åŒ" },
                { id: 2404, question: "ä¸ã€Œã„ã„§ã„¥Ë‹ã€è€Œèµ°", answer: "è„›", distractors: ["ç«¶", "å‹", "å¾‘"], note: "ä¸åŒï¼šèˆ‡ã€Œã„ã„§ã„¥Ë‹ã€çˆ­ (ç«¶) ä¸åŒ" },
                // 25
                { id: 2501, question: "ã€Œã„©Ë‹ã€æ•™æ–¼æ¨‚", answer: "å¯“", distractors: ["é‡", "è­½", "è‚²"], note: "ç›¸åŒï¼šèˆ‡ã€Œã„©Ë‹ã€æ„æ·±åˆ»åŒå­—" },
                { id: 2502, question: "ã€Œã„©Ë‹ã€æ„æ·±åˆ»", answer: "å¯“", distractors: ["é‡", "è­½", "è‚²"], note: "ç›¸åŒï¼šèˆ‡ã€Œã„©Ë‹ã€æ•™æ–¼æ¨‚åŒå­—" },
                { id: 2503, question: "ã€Œã„©Ë‹ã€æ–¼å¥å…¨èº«é«”", answer: "å¯“", distractors: ["é‡", "è­½", "è‚²"], note: "ç›¸åŒï¼šèˆ‡ã€Œã„©Ë‹ã€æ•™æ–¼æ¨‚åŒå­—" },
                { id: 2504, question: "å¾…ã€Œã„©Ë‹ã€", answer: "é‡", distractors: ["å¯“", "è­½", "è‚²"], note: "ä¸åŒï¼šèˆ‡ã€Œã„©Ë‹ã€æ–¼å¥å…¨ (å¯“) ä¸åŒ" },
                { id: 2505, question: "æ¦®ã€Œã„©Ë‹ã€", answer: "è­½", distractors: ["å¯“", "é‡", "è‚²"], note: "ä¸åŒï¼šèˆ‡ã€Œã„©Ë‹ã€æ–¼å¥å…¨ (å¯“) ä¸åŒ" },
                // 26
                { id: 2601, question: "åœ°ã€Œã„Œã„§ã„¥ËŠã€äººå‚‘", answer: "éˆ", distractors: ["é›¶", "ç²", "ä¼¶"], note: "ä¸åŒï¼šèˆ‡æ„Ÿæ¿€æ¶•ã€Œã„Œã„§ã„¥ËŠã€ (é›¶) ä¸åŒ" },
                { id: 2602, question: "æ„Ÿæ¿€æ¶•ã€Œã„Œã„§ã„¥ËŠã€", answer: "é›¶", distractors: ["éˆ", "ç²", "ä¼¶"], note: "ä¸åŒï¼šèˆ‡åœ°ã€Œã„Œã„§ã„¥ËŠã€ (éˆ) ä¸åŒ" },
                // 27
                { id: 2701, question: "å¤©ç¶“åœ°ã€Œã„§Ë‹ã€", answer: "ç¾©", distractors: ["æ„", "ç•°", "æ˜“"], note: "ç›¸åŒï¼šèˆ‡å¿˜æ©è² ã€Œã„§Ë‹ã€åŒå­—" },
                { id: 2702, question: "å¿˜æ©è² ã€Œã„§Ë‹ã€", answer: "ç¾©", distractors: ["æ„", "ç•°", "æ˜“"], note: "ç›¸åŒï¼šèˆ‡å¤©ç¶“åœ°ã€Œã„§Ë‹ã€åŒå­—" },
                { id: 2703, question: "ã€Œã„§Ë‹ã€æ°£", answer: "ç¾©", distractors: ["æ„", "ç•°", "æ˜“"], note: "ä¸åŒï¼šèˆ‡ã€Œã„§Ë‹ã€è¦‹ (æ„) ä¸åŒ" },
                { id: 2704, question: "ã€Œã„§Ë‹ã€è¦‹", answer: "æ„", distractors: ["ç¾©", "ç•°", "æ˜“"], note: "ä¸åŒï¼šèˆ‡ã€Œã„§Ë‹ã€æ°£ (ç¾©) ä¸åŒ" },
                // 28
                { id: 2801, question: "ã€Œã„•ã„£ã€æƒ¡ç—›çµ•", answer: "æ·±", distractors: ["ç”³", "ä¼¸", "èº«"], note: "ç›¸åŒï¼šèˆ‡ã€Œã„•ã„£ã€å±…ç°¡å‡ºåŒå­—" },
                { id: 2802, question: "ã€Œã„•ã„£ã€å±…ç°¡å‡º", answer: "æ·±", distractors: ["ç”³", "ä¼¸", "èº«"], note: "ç›¸åŒï¼šèˆ‡ã€Œã„•ã„£ã€æƒ¡ç—›çµ•åŒå­—" },
                // 29
                { id: 2901, question: "ç™¾ç„¡ã€Œã„Œã„§ã„ ËŠã€è³´", answer: "èŠ", distractors: ["å¯¥", "é¼", "åƒš"], note: "ä¸åŒï¼šèˆ‡ã€Œã„Œã„§ã„ ËŠã€å‹æ–¼ç„¡ (å¯¥) ä¸åŒ" },
                { id: 2902, question: "ã€Œã„Œã„§ã„ ËŠã€å‹æ–¼ç„¡", answer: "å¯¥", distractors: ["èŠ", "é¼", "åƒš"], note: "ä¸åŒï¼šèˆ‡ç™¾ç„¡ã€Œã„Œã„§ã„ ËŠã€ (èŠ) ä¸åŒ" },
                // 30
                { id: 3001, question: "å¯¡å»‰é®®ã€Œã„”Ë‡ã€", answer: "æ¥", distractors: ["é½’", "å°º", "ä¾ˆ"], note: "ä¸åŒï¼šèˆ‡ä»¤äººä¸ã€Œã„”Ë‡ã€ (é½’) ä¸åŒ" },
                { id: 3002, question: "ä»¤äººä¸ã€Œã„”Ë‡ã€", answer: "é½’", distractors: ["æ¥", "å°º", "ä¾ˆ"], note: "ä¸åŒï¼šèˆ‡å¯¡å»‰é®®ã€Œã„”Ë‡ã€ (æ¥) ä¸åŒ" },
                // 31
                { id: 3101, question: "ã€Œã„¨ã„ŸË‹ã€é€ æ–‡æ›¸", answer: "å½", distractors: ["ç‚º", "é­", "è¡›"], note: "ä¸åŒï¼šèˆ‡ã€Œã„¨ã„ŸË‹ã€åœ‹æ•ˆå¿  (ç‚º) ä¸åŒ" },
                { id: 3102, question: "ã€Œã„¨ã„ŸË‹ã€åœ‹æ•ˆå¿ ", answer: "ç‚º", distractors: ["å½", "é­", "è¡›"], note: "ä¸åŒï¼šèˆ‡ã€Œã„¨ã„ŸË‹ã€é€ æ–‡æ›¸ (å½) ä¸åŒ" },
                // 32
                { id: 3201, question: "å‚æ­»æ™ã€Œã„“ã„šã€", answer: "æ‰", distractors: ["æœ­", "ç´®", "æŸµ"], note: "ä¸åŒï¼šèˆ‡ç”Ÿæ´»ã€Œã„“ã„šËŠã€è¨˜ (æœ­) ä¸åŒ" },
                { id: 3202, question: "ç”Ÿæ´»ã€Œã„“ã„šËŠã€è¨˜", answer: "æœ­", distractors: ["æ‰", "ç´®", "æŸµ"], note: "ä¸åŒï¼šèˆ‡å‚æ­»æ™ã€Œã„“ã„šã€ (æ‰) ä¸åŒ" },
                // 33
                { id: 3301, question: "å§‹çµ‚ä¸ã€Œã„©ËŠã€", answer: "æ¸", distractors: ["æ„ˆ", "é€¾", "æ„‰"], note: "ä¸åŒï¼šèˆ‡æ¯æ³ã€Œã„©Ë‹ã€ä¸‹ (æ„ˆ) ä¸åŒ" },
                { id: 3302, question: "æ¯æ³ã€Œã„©Ë‹ã€ä¸‹", answer: "æ„ˆ", distractors: ["æ¸", "é€¾", "ç™’"], note: "ä¸åŒï¼šèˆ‡å§‹çµ‚ä¸ã€Œã„©ËŠã€ (æ¸) ä¸åŒ" },
                { id: 3303, question: "ä¸ã€Œã„©ËŠã€çŸ©", answer: "è¸°", distractors: ["æ¸", "æ„ˆ", "é€¾"], note: "ä¸åŒï¼šèˆ‡å§‹çµ‚ä¸ã€Œã„©ËŠã€ (æ¸) ä¸åŒ" },
                { id: 3304, question: "ã€Œã„©ËŠã€æ™‚ä¸å€™", answer: "é€¾", distractors: ["æ¸", "æ„ˆ", "è¸°"], note: "ä¸åŒï¼šèˆ‡å§‹çµ‚ä¸ã€Œã„©ËŠã€ (æ¸) ä¸åŒ" },
                { id: 3305, question: "è¦¬ã€Œã„©ËŠã€", answer: "è¦¦", distractors: ["æ¸", "é€¾", "æ„ˆ"], note: "ä¸åŒï¼šèˆ‡å§‹çµ‚ä¸ã€Œã„©ËŠã€ (æ¸) ä¸åŒ" },
                // 34
                { id: 3401, question: "å¤¢ã€Œã„§ã„¢Ë‡ã€", answer: "é­˜", distractors: ["é¨", "é¥œ", "æ©"], note: "ä¸åŒï¼šèˆ‡ç¬‘ã€Œã„§ã„Ë‹ã€ (é¨) ä¸åŒ" },
                { id: 3402, question: "ç¬‘ã€Œã„§ã„Ë‹ã€", answer: "é¨", distractors: ["é­˜", "é¥œ", "å¤œ"], note: "ä¸åŒï¼šèˆ‡å¤¢ã€Œã„§ã„¢Ë‡ã€ (é­˜) ä¸åŒ" },
                { id: 3403, question: "è²ªå¾—ç„¡ã€Œã„§ã„¢Ë‹ã€", answer: "é¥œ", distractors: ["é­˜", "é¨", "å­"], note: "ä¸åŒï¼šèˆ‡å¤¢ã€Œã„§ã„¢Ë‡ã€ (é­˜) ä¸åŒ" },
                // 35
                { id: 3501, question: "æ‡¸ã€Œã„§ã„šËŠã€", answer: "å´–", distractors: ["æ¶¯", "æ±", "äº"], note: "ä¸åŒï¼šèˆ‡å¤©ã€Œã„§ã„šËŠã€ (æ¶¯) ä¸åŒ" },
                { id: 3502, question: "å¤©ã€Œã„§ã„šËŠã€æµ·è§’", answer: "æ¶¯", distractors: ["å´–", "æ±", "äº"], note: "ä¸åŒï¼šèˆ‡æ‡¸ã€Œã„§ã„šËŠã€ (å´–) ä¸åŒ" },
                { id: 3503, question: "ã€Œã„ËŠã€ç½µ", answer: "æ±", distractors: ["å´–", "æ¶¯", "æŒ¨"], note: "ä¸åŒï¼šèˆ‡æ‡¸ã€Œã„§ã„šËŠã€ (å´–) ä¸åŒ" },
                // 36
                { id: 3601, question: "ç«ã€Œã„ã„©Ë‹ã€", answer: "ç‚¬", distractors: ["é‰…", "å…·", "æ“š"], note: "ä¸åŒï¼šèˆ‡ã€Œã„ã„©Ë‹ã€ç´°é¡éº (é‰…) ä¸åŒ" },
                { id: 3602, question: "ã€Œã„ã„©Ë‹ã€ç´°é¡éº", answer: "é‰…", distractors: ["ç‚¬", "å…·", "æ“š"], note: "ä¸åŒï¼šèˆ‡ç«ã€Œã„ã„©Ë‹ã€ (ç‚¬) ä¸åŒ" },
                // 37
                { id: 3701, question: "ã€Œã„•ã„¨ã„›Ë‹ã€å¤§", answer: "ç¢©", distractors: ["æœ”", "å¡‘", "æ•¸"], note: "ä¸åŒï¼šèˆ‡æ’²ã€Œã„•ã„¨ã„›Ë‹ã€ (æœ”) ä¸åŒ" },
                { id: 3702, question: "æ’²ã€Œã„•ã„¨ã„›Ë‹ã€è¿·é›¢", answer: "æœ”", distractors: ["ç¢©", "å¡‘", "æ•¸"], note: "ä¸åŒï¼šèˆ‡ã€Œã„•ã„¨ã„›Ë‹ã€å¤§ (ç¢©) ä¸åŒ" },
                { id: 3703, question: "ã€Œã„™ã„¨Ë‹ã€é€ ", answer: "å¡‘", distractors: ["æœ”", "ç¢©", "ç´ "], note: "ä¸åŒï¼šèˆ‡æ’²ã€Œã„•ã„¨ã„›Ë‹ã€ (æœ”) ä¸åŒ" },
            ];

            // --- Helper Functions ---
            const shuffleArray = (array) => {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            };

            const playSound = (type) => {
                const audioPath = type === 'success' ? 'sounds/correct.mp3' : 'sounds/fail.mp3';
                const audio = new Audio(audioPath);
                audio.play().catch(err => console.log('Audio play error:', err));
            }

            const App = () => {
                const [mode, setMode] = useState('menu'); 
                const [currentUser, setCurrentUser] = useState(null);
                const [users, setUsers] = useState([]);
                const [favorites, setFavorites] = useState(new Set());
                const [mistakes, setMistakes] = useState(new Set());
                const [userProgress, setUserProgress] = useState({}); 
                
                const [isFirebaseReady, setIsFirebaseReady] = useState(false);
                const [status, setStatus] = useState('loading'); 
                const [statusText, setStatusText] = useState('è®€å–è³‡æ–™ä¸­...');

                // 1. Firebase Auth & Global Users Listener
                useEffect(() => {
                    if (!auth) {
                        setStatus('error');
                        setStatusText('è¨­å®šéŒ¯èª¤');
                        return;
                    }

                    const initAuth = async () => {
                        try {
                            setStatus('loading');
                            setStatusText('é€£ç·šä¸­...');
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Auth Error:", error);
                            setStatus('error');
                            setStatusText('ç™»å…¥å¤±æ•—');
                        }
                    };
                    initAuth();

                    const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            setIsFirebaseReady(true);
                            
                            const globalRef = doc(db, COLLECTION_NAME, DOC_GLOBAL);
                            const unsubscribeGlobal = onSnapshot(globalRef, (docSnap) => {
                                if (docSnap.exists()) {
                                    setUsers(docSnap.data().users || []);
                                } else {
                                    setDoc(globalRef, { users: [] }, { merge: true });
                                    setUsers([]);
                                }
                                setStatus('success');
                                setStatusText('å·²åŒæ­¥');
                            }, (error) => {
                                console.error("Global Sync Error:", error);
                                setStatus('error');
                                setStatusText('åŒæ­¥å¤±æ•—');
                            });

                            return () => unsubscribeGlobal();
                        } else {
                            setIsFirebaseReady(false);
                        }
                    });

                    return () => unsubscribeAuth();
                }, []);

                // 2. User Data Listener
                useEffect(() => {
                    if (currentUser && isFirebaseReady && db) {
                        const userRef = doc(db, COLLECTION_NAME, currentUser);
                        
                        const unsubscribeUser = onSnapshot(userRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                setFavorites(new Set(data.favorites || []));
                                setMistakes(new Set(data.mistakes || []));
                                setUserProgress(data.progress || {});
                            } else {
                                setFavorites(new Set());
                                setMistakes(new Set());
                                setUserProgress({});
                            }
                            setStatus('success');
                            setStatusText('å·²åŒæ­¥');
                        }, (error) => {
                            console.error("User Sync Error:", error);
                            setStatus('error');
                            setStatusText('åŒæ­¥å¤±æ•—');
                        });

                        return () => unsubscribeUser();
                    } else {
                        setFavorites(new Set());
                        setMistakes(new Set());
                        setUserProgress({});
                    }
                }, [currentUser, isFirebaseReady]);

                const handleLogin = async (name) => {
                    if (!name.trim()) return;
                    const userName = name.trim();
                    if (!db) {
                        setCurrentUser(userName);
                        setMode('menu');
                        return;
                    }
                    try {
                        const globalRef = doc(db, COLLECTION_NAME, DOC_GLOBAL);
                        await updateDoc(globalRef, { users: arrayUnion(userName) });
                        
                        const userRef = doc(db, COLLECTION_NAME, userName);
                        const userSnap = await getDoc(userRef);
                        if (!userSnap.exists()) {
                            await setDoc(userRef, { favorites: [], mistakes: [], progress: {} });
                        }

                        setCurrentUser(userName);
                        setMode('menu');
                    } catch (e) {
                        console.error("Login Error:", e);
                        if (e.code === 'not-found') {
                             const globalRef = doc(db, COLLECTION_NAME, DOC_GLOBAL);
                             await setDoc(globalRef, { users: [userName] });
                             setCurrentUser(userName);
                             setMode('menu');
                        } else {
                             alert("ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
                        }
                    }
                };

                const handleLogout = () => {
                    setCurrentUser(null);
                    setMode('menu');
                };

                const saveUserData = useCallback(async (dataToUpdate) => {
                    if(!currentUser || !isFirebaseReady || !db) return;
                    try {
                        setStatus('loading');
                        const userRef = doc(db, COLLECTION_NAME, currentUser);
                        await setDoc(userRef, dataToUpdate, { merge: true });
                        // Listener will update status back to success
                    } catch (e) {
                        console.error("Save Error:", e);
                        setStatus('error');
                        setStatusText('å„²å­˜å¤±æ•—');
                    }
                }, [currentUser, isFirebaseReady]);

                const toggleFavorite = useCallback((id) => {
                    if (!currentUser) return;
                    const newFavorites = new Set(favorites);
                    let op;
                    if (newFavorites.has(id)) {
                        newFavorites.delete(id);
                        op = arrayRemove(id);
                    } else {
                        newFavorites.add(id);
                        op = arrayUnion(id);
                    }
                    setFavorites(newFavorites); 
                    if(db) updateDoc(doc(db, COLLECTION_NAME, currentUser), { favorites: op });
                }, [favorites, currentUser]);

                const addMistake = useCallback((id) => {
                    if (!currentUser) return;
                    const newMistakes = new Set(mistakes);
                    if (!newMistakes.has(id)) {
                        newMistakes.add(id);
                        setMistakes(newMistakes); 
                        if(db) updateDoc(doc(db, COLLECTION_NAME, currentUser), { mistakes: arrayUnion(id) });
                    }
                }, [mistakes, currentUser]);

                const updateProgress = useCallback((newProgress) => {
                    if(!currentUser) return;
                    setUserProgress(newProgress);
                    if(db) setDoc(doc(db, COLLECTION_NAME, currentUser), { progress: newProgress }, { merge: true });
                }, [currentUser]);

                if (!currentUser) {
                    return (
                        <LoginView 
                            users={users} 
                            onLogin={handleLogin} 
                            status={status}
                            statusText={statusText}
                        />
                    );
                }
                
                return (
                    <div className="min-h-screen bg-orange-50 text-stone-800 font-sans">
                        <header className="bg-orange-600 text-white p-4 shadow-lg sticky top-0 z-20">
                            <div className="max-w-4xl mx-auto flex justify-between items-center">
                                <div className="flex items-center space-x-2 cursor-pointer" onClick={() => setMode('menu')}>
                                <BookOpen size={28} />
                                <div className="flex flex-col">
                                    <h1 className="text-xl md:text-2xl font-bold tracking-wider">L1 é‹å‹•å®¶çš„é¢¨åº¦</h1>
                                    <h2 className="text-xs text-orange-200">å­—å½¢ç·´ç¿’</h2>
                                </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                <div className="hidden sm:flex items-center bg-black/20 px-3 py-1 rounded-full text-xs" title={statusText}>
                                    <span className={`status-dot status-${status}`}></span>
                                    <span className="text-white/90">{statusText}</span>
                                </div>

                                <div className="hidden md:flex items-center bg-orange-700 px-3 py-1 rounded-full text-sm">
                                    <User size={16} className="mr-2"/>
                                    <span className="font-bold truncate max-w-[100px]">{currentUser}</span>
                                </div>
                                {mode !== 'menu' && (
                                    <button onClick={() => setMode('menu')} className="text-orange-100 hover:text-white transition font-medium">å›é¦–é </button>
                                )}
                                <button onClick={handleLogout} className="flex items-center text-orange-200 hover:text-white transition" title="ç™»å‡º">
                                    <LogOut size={20} />
                                </button>
                                </div>
                            </div>
                        </header>

                        <main className="max-w-4xl mx-auto p-4 md:p-6">
                            {mode === 'menu' && (
                                <div className="flex flex-col items-center justify-center space-y-8 py-12 animate-in fade-in duration-500">
                                <div className="text-center space-y-4">
                                    <div className="bg-orange-100 p-4 rounded-full inline-block mb-2">
                                    <Sun size={48} className="text-orange-500" />
                                    </div>
                                    <h2 className="text-3xl font-bold text-orange-900">æ­¡è¿å›ä¾†ï¼Œ{currentUser}</h2>
                                    <p className="text-stone-600 text-lg max-w-md">è«‹é¸æ“‡ä¸‹åˆ—åŠŸèƒ½é–‹å§‹å­¸ç¿’</p>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                                    <MenuButton onClick={() => setMode('study')} icon={<List size={40} className="text-orange-600" />} title="å…¨è¡¨ç€è¦½" desc="å®Œæ•´æª¢è¦–å­—å½¢è¾¨æ­£è³‡æ–™åº«" />
                                    <MenuButton onClick={() => setMode('quiz')} icon={<Zap size={40} className="text-orange-600" />} title="é–ƒé›»åˆ·é¡Œ" desc="å¿«é€ŸæŒ‘æˆ°æ˜“æ··æ·†å­—å½¢" />
                                    <MenuButton onClick={() => setMode('favorites')} icon={<Heart size={40} className="text-red-500 fill-red-500" />} title="æˆ‘çš„æœ€æ„›" desc="è¤‡ç¿’æ‚¨æ”¶è—çš„é‡é»é¡Œç›®" highlight="red" />
                                    <MenuButton onClick={() => setMode('mistakes')} icon={<BookX size={40} className="text-stone-600" />} title="éŒ¯é¡Œè¤‡ç¿’" desc="é‡å°ç­”éŒ¯çš„é¡Œç›®åŠ å¼·ç·´ç¿’" highlight="stone" />
                                </div>
                                
                                {/* Add Return Button Here */}
                                <div style={{ marginTop: '20px', textAlign: 'center' }}>
                                    <a href="index.html" 
                                       className="btn btn-gray" 
                                       style={{
                                           textDecoration: 'none', 
                                           padding: '10px 20px',
                                           background: 'linear-gradient(135deg, #ff4081 0%, #d81b60 100%)',
                                           color: 'white', 
                                           borderRadius: '999px', 
                                           display: 'inline-block'
                                       }}>
                                        ğŸ  è¿”å›åœ‹æ–‡å­¸ç¿’ App ç¸½éƒ¨
                                    </a>
                                </div>
                                </div>
                            )}

                            {mode === 'study' && <StudyView data={rawData} favorites={favorites} onToggleFavorite={toggleFavorite} title="å­—å½¢è¾¨æ­£ä¸€è¦½è¡¨" />}
                            {mode === 'favorites' && <StudyView data={rawData.filter(item => favorites.has(item.id))} favorites={favorites} onToggleFavorite={toggleFavorite} title="æˆ‘çš„æœ€æ„›æ¸…å–®" emptyMessage="æ‚¨é‚„æ²’æœ‰åŠ å…¥ä»»ä½•æœ€æ„›é¡Œç›®å–”ï¼" />}
                            {mode === 'mistakes' && <StudyView data={rawData.filter(item => mistakes.has(item.id))} favorites={favorites} onToggleFavorite={toggleFavorite} title="éŒ¯é¡Œè¤‡ç¿’æœ¬" emptyMessage="å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰éŒ¯é¡Œç´€éŒ„ã€‚" />}
                            {mode === 'quiz' && (
                                <WaterfallQuizView 
                                    data={rawData} 
                                    currentUser={currentUser}
                                    progress={userProgress} 
                                    onUpdateProgress={updateProgress} 
                                    favorites={favorites} 
                                    onToggleFavorite={toggleFavorite} 
                                    onAddMistake={addMistake} 
                                    onExit={() => setMode('menu')} 
                                />
                            )}
                        </main>
                    </div>
                );
            };

            const MenuButton = ({ onClick, icon, title, desc, highlight = "orange" }) => {
                const bgClass = highlight === "red" ? "bg-red-50" : highlight === "stone" ? "bg-stone-100" : "bg-orange-100";
                return (
                    <button onClick={onClick} className="flex flex-col items-center p-8 bg-white rounded-2xl shadow-sm hover:shadow-xl hover:bg-orange-50 transition border-2 border-orange-100 hover:border-orange-300 group">
                        <div className={`${bgClass} p-4 rounded-full mb-4 group-hover:scale-110 transition`}>{icon}</div>
                        <h3 className="text-xl font-bold text-orange-900">{title}</h3>
                        <p className="text-stone-500 mt-2">{desc}</p>
                    </button>
                )
            }

            const LoginView = ({ users, onLogin, status, statusText }) => {
                const [inputName, setInputName] = useState("");
                return (
                    <div className="min-h-screen bg-orange-50 flex items-center justify-center p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-2 border-orange-100 relative">
                            <div className="absolute top-4 right-4 flex items-center bg-stone-100 px-2 py-1 rounded-full text-xs">
                                <span className={`status-dot status-${status}`}></span>
                                <span className="text-stone-600">{statusText}</span>
                            </div>

                            <div className="text-center mb-8">
                                <div className="bg-orange-100 p-3 rounded-full inline-block mb-4"><BookOpen size={40} className="text-orange-600" /></div>
                                <h1 className="text-2xl font-bold text-orange-900">å­—å½¢ç·´ç¿’App</h1>
                                <p className="text-stone-500 mt-2">è«‹è¼¸å…¥å§“åä»¥é–‹å§‹å­¸ç¿’</p>
                            </div>
                            <form onSubmit={(e) => { e.preventDefault(); if(inputName.trim()) onLogin(inputName.trim()); }} className="space-y-4">
                                <input type="text" value={inputName} onChange={(e) => setInputName(e.target.value)} placeholder="è¼¸å…¥æ‚¨çš„åå­—" className="w-full px-4 py-3 rounded-xl border border-orange-200 focus:outline-none focus:ring-2 focus:ring-orange-400 text-lg" autoFocus />
                                <button type="submit" disabled={!inputName.trim() || status === 'loading'} className="w-full py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-xl font-bold text-lg transition disabled:opacity-50">é–‹å§‹ä½¿ç”¨</button>
                            </form>
                            
                            <div className="mt-8">
                                <div className="relative mb-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-stone-200"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-stone-500">å¿«é€Ÿç™»å…¥</span></div></div>
                                
                                {users && users.length > 0 ? (
                                    <div className="flex flex-wrap gap-4 justify-center">
                                        {users.map((user, idx) => (
                                            <button key={idx} onClick={() => onLogin(user)} className="px-6 py-3 bg-stone-100 hover:bg-orange-100 text-stone-700 hover:text-orange-700 rounded-lg text-lg font-medium transition w-full min-w-[100px] shadow-sm">{user}</button>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-4 bg-orange-50/50 rounded-xl border border-dashed border-orange-200">
                                        <p className="text-orange-800 font-medium">å°šç„¡æŒ‘æˆ°è€…ç´€éŒ„ï¼Œæ­¡è¿åŠ å…¥ï¼</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const StudyView = ({ data, favorites, onToggleFavorite, title, emptyMessage = "æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„è³‡æ–™" }) => {
                const [searchTerm, setSearchTerm] = useState("");
                const filteredData = data.filter(item => item.question.includes(searchTerm) || item.answer.includes(searchTerm));

                return (
                    <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-6">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-orange-200">
                        <h2 className="text-xl font-bold text-orange-900 flex items-center"><List className="mr-2" size={24} />{title}</h2>
                        <input type="text" placeholder="æœå°‹é¡Œç›®ã€å­—å½¢..." className="px-4 py-2 rounded-lg border border-orange-200 focus:outline-none focus:ring-2 focus:ring-orange-400 w-full md:w-64 bg-white" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                    </div>
                    
                    {filteredData.length > 0 ? (
                        <div className="grid grid-cols-1 gap-4">
                        {filteredData.map((item) => (
                            <div key={item.id} className="bg-white rounded-xl shadow-sm border border-orange-100 overflow-hidden hover:shadow-md transition flex flex-col md:flex-row">
                                <div className="p-4 bg-orange-50 border-b md:border-b-0 md:border-r border-orange-100 flex-1 flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <span className="bg-orange-200 text-orange-800 text-xs font-bold px-2 py-1 rounded">#{item.id}</span>
                                        <h3 className="text-xl font-bold text-stone-800">{item.question}</h3>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <span className="text-3xl font-black text-orange-600 font-serif">{item.answer}</span>
                                        <button onClick={() => onToggleFavorite(item.id)} className={`transition transform active:scale-90 p-1 rounded-full hover:bg-orange-100 ${favorites.has(item.id) ? 'text-red-500' : 'text-stone-300 hover:text-red-400'}`}>
                                            <Heart size={20} className={favorites.has(item.id) ? "fill-current heart-click" : ""} />
                                        </button>
                                    </div>
                                </div>
                                <div className="p-4 flex-1 bg-white flex items-center">
                                    <ArrowRightLeft size={32} className="text-stone-400 mr-2 shrink-0" />
                                    <p className="text-stone-600 text-xl font-bold">{item.note}</p>
                                </div>
                            </div>
                        ))}
                        </div>
                    ) : (
                        <div className="p-12 text-center text-stone-400 bg-white rounded-xl border border-dashed border-stone-300">
                            <List size={48} className="mx-auto mb-4 opacity-50" />
                            <p>{emptyMessage}</p>
                        </div>
                    )}
                    <div className="text-center text-sm text-stone-500 mt-4">é¡¯ç¤º {filteredData.length} ç­†è³‡æ–™</div>
                    </div>
                );
            };

            const WaterfallQuizView = ({ data, favorites, onToggleFavorite, onAddMistake, onExit, progress, onUpdateProgress }) => {
                const [quizData, setQuizData] = useState([]);
                const [selections, setSelections] = useState(progress || {});

                useEffect(() => {
                    const preparedData = data.map(item => ({ ...item, options: shuffleArray([item.answer, ...item.distractors]) }));
                    setQuizData(preparedData);
                }, [data]);

                useEffect(() => {
                    setSelections(progress || {});
                }, [progress]);

                const handleSelect = (questionId, option) => {
                    const newSelections = { ...selections, [questionId]: option };
                    setSelections(newSelections);
                    onUpdateProgress(newSelections);
                    
                    const currentQuestion = data.find(item => item.id === questionId);
                    const isCorrect = option === currentQuestion.answer;
                    if (isCorrect) {
                        playSound('success');
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    } else {
                        playSound('error');
                        onAddMistake(questionId);
                    }
                };
                
                const completedCount = Object.keys(selections).length;
                const progressPercentage = Math.round((completedCount / data.length) * 100);

                return (
                    <div className="max-w-4xl mx-auto pb-20">
                    <div className="sticky top-16 z-10 bg-orange-50/95 backdrop-blur-sm pt-4 pb-2 border-b border-orange-200 mb-6 shadow-sm">
                        <div className="flex justify-between items-center mb-2 px-2">
                            <div>
                                <h2 className="text-xl font-bold text-orange-900 flex items-center gap-2"><Zap size={24} className="fill-orange-500 text-orange-600"/>é–ƒé›»åˆ·é¡Œ</h2>
                                <p className="text-xs text-stone-500 mt-1">å·²å®Œæˆ: {completedCount} / {data.length} é¡Œ</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => { if(window.confirm('ç¢ºå®šè¦æ¸…ç©ºé€²åº¦é‡ä¾†å—ï¼Ÿ')) { onUpdateProgress({}); window.scrollTo(0,0); }}} className="px-3 py-1.5 bg-white border border-orange-300 text-orange-700 rounded-lg hover:bg-orange-50 font-medium text-xs sm:text-sm transition">é‡ç½®</button>
                                <button onClick={onExit} className="px-3 py-1.5 bg-stone-600 text-white rounded-lg hover:bg-stone-700 font-medium text-xs sm:text-sm transition">æš«åœ</button>
                            </div>
                        </div>
                        <div className="w-full bg-orange-200 h-2.5 rounded-full overflow-hidden"><div className="bg-orange-600 h-2.5 rounded-full progress-bar shadow-[0_0_10px_rgba(249,115,22,0.5)]" style={{ width: `${progressPercentage}%` }}></div></div>
                    </div>

                    <div className="space-y-6">
                        {quizData.map((item) => {
                            const userSelection = selections[item.id];
                            const isAnswered = userSelection !== undefined;
                            const isCorrect = userSelection === item.answer;
                            const isFav = favorites.has(item.id);
                            
                            return (
                                <div key={item.id} className={`bg-white rounded-xl shadow-sm border-2 transition-all duration-300 overflow-hidden ${isAnswered ? (isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50') : 'border-orange-100'}`}>
                                    <div className="p-4 border-b border-black/5 flex items-start gap-3">
                                        <span className="bg-orange-100 text-orange-800 font-mono font-bold px-2 py-1 rounded text-sm shrink-0 mt-1">#{item.id}</span>
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2">
                                                <button onClick={(e) => { e.stopPropagation(); onToggleFavorite(item.id); }} className={`transition transform active:scale-90 p-1 rounded-full -ml-2 ${isFav ? 'text-red-500' : 'text-stone-300 hover:text-red-400'}`} title={isFav ? "å–æ¶ˆæ”¶è—" : "åŠ å…¥æœ€æ„›"}>
                                                    <Heart size={20} className={isFav ? "fill-current heart-click" : ""} />
                                                </button>
                                                <h3 className="text-xl md:text-2xl font-bold text-stone-800 leading-snug">{item.question}</h3>
                                            </div>
                                        </div>
                                        {isAnswered && <div className="ml-auto shrink-0">{isCorrect ? <CheckCircle className="text-green-500" /> : <XCircle className="text-red-500" />}</div>}
                                    </div>
                                    <div className="p-4 bg-white/50">
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                            {item.options.map((option, idx) => {
                                                let btnClass = "py-4 px-2 rounded-lg font-bold text-3xl font-serif transition-all border-2 relative ";
                                                if (isAnswered) {
                                                    if (option === item.answer) btnClass += "bg-green-500 text-white border-green-600 shadow-md";
                                                    else if (option === userSelection && !isCorrect) btnClass += "bg-red-500 text-white border-red-600 shadow-md";
                                                    else btnClass += "bg-stone-100 text-stone-400 border-transparent opacity-50";
                                                } else {
                                                    btnClass += "bg-white text-stone-700 border-stone-200 hover:border-orange-400 hover:bg-orange-50 active:scale-95";
                                                }
                                                return <button key={idx} onClick={() => !isAnswered && handleSelect(item.id, option)} disabled={isAnswered} className={btnClass}>{option}</button>;
                                            })}
                                        </div>
                                        {isAnswered && (
                                            <div className="mt-4 pt-4 border-t border-black/5 animate-in fade-in slide-in-from-top-2">
                                                <div className="bg-white/60 p-3 rounded-lg border border-stone-100 flex items-center gap-2">
                                                    <span className="text-sm font-bold text-stone-500">è¾¨æï¼š</span>
                                                    <p className="text-stone-800 font-medium">{item.note}</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    {progressPercentage === 100 && (
                        <div className="mt-8 p-8 bg-green-100 rounded-2xl text-center border-2 border-green-300 animate-in zoom-in duration-300">
                            <h3 className="text-2xl font-bold text-green-800 mb-2">æ­å–œå®Œæˆæ‰€æœ‰é¡Œç›®ï¼</h3>
                            <button onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })} className="mt-4 text-green-700 underline hover:text-green-900">å›åˆ°é ‚éƒ¨</button>
                        </div>
                    )}
                    </div>
                );
            };

            const root = createRoot(document.getElementById('root'));
            root.render(<App />);
        }
    </script>
</body>
</html>